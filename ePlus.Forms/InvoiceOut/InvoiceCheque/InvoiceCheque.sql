SET NOCOUNT ON
SET QUOTED_IDENTIFIER OFF
GO

IF (OBJECT_ID('DBO.REPEX_INVOICE_CHEQUE') IS NULL) EXEC ('CREATE PROCEDURE DBO.REPEX_INVOICE_CHEQUE AS RETURN')
GO
ALTER PROCEDURE DBO.REPEX_INVOICE_CHEQUE
    @XMLPARAM NTEXT
AS

DECLARE	@HDOC INT
DECLARE @ID_GLOBAL UNIQUEIDENTIFIER

EXEC SP_XML_PREPAREDOCUMENT @HDOC OUTPUT, @XMLPARAM OUTPUT
SELECT @ID_GLOBAL = ID_GLOBAL FROM OPENXML(@HDOC, '/XML') WITH(ID_GLOBAL UNIQUEIDENTIFIER 'ID_GLOBAL')
EXEC SP_XML_REMOVEDOCUMENT @HDOC

SELECT 
	DOC = I.MNEMOCODE + ' от ' + CONVERT(VARCHAR, I.DATE, 104),
	CONTRACTOR_FROM = FR.NAME,	
	ADDRESS_FROM = FR.ADDRESS,
	FULL_FROM = FR.FULL_NAME,
	CONTRACTOR_TO = CT.NAME,
	PHONE_TO = CT.PHONE,
	ADDRESS_TO = CT.ADDRESS 
FROM INVOICE_OUT I
	INNER JOIN CONTRACTOR CT ON I.ID_CONTRACTOR_TO = CT.ID_CONTRACTOR
	INNER JOIN STORE ST ON ST.ID_STORE = I.ID_STORE
	INNER JOIN CONTRACTOR FR ON FR.ID_CONTRACTOR = ST.ID_CONTRACTOR
WHERE I.ID_INVOICE_OUT_GLOBAL = @ID_GLOBAL

SELECT
	GOODS_NAME = G.NAME,
	BARCODE = L.INTERNAL_BARCODE,
	QUANTITY = II.QUANTITY,
	PRICE_SAL = II.PRICE_SAL
FROM INVOICE_OUT_ITEM II
	INNER JOIN LOT L ON L.ID_LOT_GLOBAL = II.ID_LOT_GLOBAL
	INNER JOIN GOODS G ON G.ID_GOODS = L.ID_GOODS
WHERE II.ID_INVOICE_OUT_GLOBAL = @ID_GLOBAL
ORDER BY GOODS_NAME

RETURN
GO

--exec DBO.REPEX_INVOICE_CHEQUE '<XML><ID_GLOBAL>0564BB00-61F8-42EC-AB19-E4DA3B72F3B0</ID_GLOBAL></XML>'