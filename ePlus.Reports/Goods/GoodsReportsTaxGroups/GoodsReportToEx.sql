SET NOCOUNT ON
SET QUOTED_IDENTIFIER OFF
GO

IF (OBJECT_ID('DBO.REP_GOODS_REPORTS_TO_EX') IS NULL ) EXEC ('CREATE PROCEDURE DBO.REP_GOODS_REPORTS_TO_EX AS SELECT NULL')
GO
ALTER PROCEDURE DBO.REP_GOODS_REPORTS_TO_EX
         @XMLPARAM NTEXT
AS
SET NOCOUNT ON
DECLARE @DATE_FR DATETIME, @DATE_TO DATETIME
DECLARE @SORT_DOC BIT, @SHOW_ADD BIT, @SHOW_SUB BIT, @REFRESH_DOC_MOV BIT

DECLARE @HDOC INT, @SQL NVARCHAR(4000), @SQL_FIELDS NVARCHAR(4000)
DECLARE @NOAU BIT, @DIS BIT, @CO BIT

EXEC SP_XML_PREPAREDOCUMENT @HDOC OUTPUT, @XMLPARAM OUTPUT
    SELECT TOP 1 
        @DATE_FR = DATE_FR, @DATE_TO = DATE_TO,
        @SORT_DOC = SORT_DOC,
        @SHOW_ADD = SHOW_ADD, @SHOW_SUB = SHOW_SUB,
        @REFRESH_DOC_MOV = REFRESH_DOC_MOV,
		@NOAU = NOAU, @DIS = DIS,
		@CO = CO
    FROM OPENXML(@HDOC, '/XML') WITH(
        DATE_FR DATETIME 'DATE_FR', 
        DATE_TO DATETIME 'DATE_TO', 
        SORT_DOC BIT 'SORT_DOC', 
        SHOW_ADD BIT 'SHOW_ADD', 
        SHOW_SUB BIT 'SHOW_SUB',
        REFRESH_DOC_MOV BIT 'REFRESH_DOC_MOV',
		NOAU BIT 'NOAU',
		DIS BIT 'DIS', 
		CO BIT 'CO')

    /* “¿¡À»÷¿ »ƒ≈Õ“»‘» ¿“Œ–Œ¬  ŒÕ“–¿√≈Õ“Œ¬ */
    SELECT DISTINCT C.ID_CONTRACTOR, C.NAME INTO #CONTRACTOR
    FROM 
        (SELECT * FROM OPENXML(@HDOC, '//ID_CONTRACTOR') 
        WITH(ID_CONTRACTOR BIGINT '.')) TAB
    INNER JOIN CONTRACTOR C ON C.ID_CONTRACTOR = TAB.ID_CONTRACTOR
    WHERE ((@CO <> 1 OR @CO IS NULL) 
		AND C.ID_CONTRACTOR = (SELECT TOP 1 ID_CONTRACTOR FROM ENTERPRISE_BRANCH WHERE IS_SELF = 1))
		OR (@CO = 1)
    
    /* “¿¡À»÷¿ »ƒ≈Õ“»‘» ¿“Œ–Œ¬ — À¿ƒŒ¬ */
    SELECT DISTINCT S.ID_STORE, S.ID_CONTRACTOR, S.NAME INTO #STORE
    FROM
    	(SELECT * FROM OPENXML(@HDOC, '//ID_STORE') 
        WITH(ID_STORE BIGINT '.')) TAB
    INNER JOIN STORE S ON S.ID_STORE = TAB.ID_STORE
    WHERE ((@CO <> 1 OR @CO IS NULL) 
		AND S.ID_CONTRACTOR = (SELECT TOP 1 ID_CONTRACTOR FROM ENTERPRISE_BRANCH WHERE IS_SELF = 1))
		OR (@CO = 1)
		
EXEC SP_XML_REMOVEDOCUMENT @HDOC

IF @REFRESH_DOC_MOV = 1 BEGIN
    -- ÔÂÂÒ˜ËÚ‡Ú¸ DOC_MOVEMENT ÔÓ ‚ÒÂÏ ‰ÓÍÛÏÂÌÚ‡Ï
    EXEC UTL_REFRESH_DOC_MOVEMENT 'REPAIR', 0
END

-- ÓÚÌÓÏËÓ‚‡Ú¸ ‰‡Ú˚
EXEC USP_RANGE_DAYS @DATE_FR OUT, @DATE_TO OUT
EXEC USP_RANGE_NORM @DATE_FR OUT, @DATE_TO OUT

-- ≈—À» Õ≈ ” ¿«¿Õ — À¿ƒ, “Œ »“Œ√» ¬€¡»–¿ﬁ“—ﬂ œŒ ¬—≈Ã — À¿ƒ¿Ã
IF NOT EXISTS(SELECT TOP 1 1 FROM #STORE) BEGIN
    INSERT INTO #STORE (ID_STORE, ID_CONTRACTOR, NAME)
    SELECT S.ID_STORE, S.ID_CONTRACTOR, S.NAME
    FROM STORE S(NOLOCK) INNER JOIN #CONTRACTOR C ON C.ID_CONTRACTOR = S.ID_CONTRACTOR
END
DELETE FROM #STORE WHERE ID_CONTRACTOR NOT IN (SELECT ID_CONTRACTOR FROM #CONTRACTOR)

-- Œ—“¿“Œ  Õ¿ Õ¿◊¿ÀŒ
SELECT
    SUM_SUP = SUM(DM.SUM_SUP * DM.SIGN_OP),
    SUM_ACC = SUM(CASE WHEN DM.ID_TABLE=19 AND CODE_OP='DIS' THEN -1 ELSE 1 END * DM.SUM_ACC * DM.SIGN_OP),
	NAL = SUM(CASE WHEN DM.ID_TABLE=19 AND CODE_OP='DIS' THEN -1 ELSE 1 END * DM.SUM_ACC * DM.SIGN_OP - DM.SUM_SUP * DM.SIGN_OP),
    KOF = CASE WHEN MAX(CODE_OP) = 'DIS' THEN 0 ELSE 1 END,

    SUM_SVAT_SUP = SUM(DM.SVAT_SUP * DM.SIGN_OP),
    SUM_SVAT_ACC = SUM(CASE WHEN DM.ID_TABLE=19 AND CODE_OP='DIS' THEN -1 ELSE 1 END * DM.SVAT_ACC * DM.SIGN_OP),

    SUM_SUP0 = SUM(CASE WHEN DM.VAT_RATE = 0 THEN (DM.SUM_SUP * DM.SIGN_OP) ELSE 0 END),
    SUM_SUP10 = SUM(CASE WHEN DM.VAT_RATE = 10 THEN (DM.SUM_SUP * DM.SIGN_OP) ELSE 0 END),
    SUM_SUP18 = SUM(CASE WHEN DM.VAT_RATE = 18 THEN (DM.SUM_SUP * DM.SIGN_OP) ELSE 0 END),
    SUM_ACC0 = SUM(CASE WHEN DM.VAT_RATE = 0 THEN CASE WHEN DM.ID_TABLE=19 AND CODE_OP='DIS' THEN -1 ELSE 1 END * SUM_ACC * DM.SIGN_OP ELSE 0 END),
    SUM_ACC10 = SUM(CASE WHEN DM.VAT_RATE = 10 THEN CASE WHEN DM.ID_TABLE=19 AND CODE_OP='DIS' THEN -1 ELSE 1 END * SUM_ACC * DM.SIGN_OP ELSE 0 END),
    SUM_ACC18 = SUM(CASE WHEN DM.VAT_RATE = 18 THEN CASE WHEN DM.ID_TABLE=19 AND CODE_OP='DIS' THEN -1 ELSE 1 END * SUM_ACC * DM.SIGN_OP ELSE 0 END),

    SVAT_SUP10 = SUM(CASE WHEN DM.VAT_RATE = 10 THEN (DM.SVAT_SUP * DM.SIGN_OP) ELSE 0 END),
    SVAT_SUP18 = SUM(CASE WHEN DM.VAT_RATE = 18 THEN (DM.SVAT_SUP * DM.SIGN_OP) ELSE 0 END),
    SVAT_ACC10 = SUM(CASE WHEN DM.VAT_RATE = 10 THEN CASE WHEN DM.ID_TABLE=19 AND CODE_OP='DIS' THEN -1 ELSE 1 END * SVAT_ACC * DM.SIGN_OP ELSE 0 END),
    SVAT_ACC18 = SUM(CASE WHEN DM.VAT_RATE = 18 THEN CASE WHEN DM.ID_TABLE=19 AND CODE_OP='DIS' THEN -1 ELSE 1 END * SVAT_ACC * DM.SIGN_OP ELSE 0 END)
    --,
    
    --SUM_DIS = SUM(CASE WHEN DM.CODE_OP='DIS' AND DM.ID_TABLE=19 THEN DM.SUM_ACC * DM.SIGN_OP WHEN DM.CODE_OP='DIS' AND DM.ID_TABLE<>19 THEN DM.SUM_ACC ELSE 0 END),
	--SUM_DIS0 = SUM(CASE WHEN DM.VAT_RATE_SAL = 0 THEN CASE WHEN DM.CODE_OP='DIS' AND DM.ID_TABLE=19 THEN DM.SUM_ACC * DM.SIGN_OP WHEN DM.CODE_OP='DIS' AND DM.ID_TABLE<>19 THEN DM.SUM_ACC ELSE 0 END ELSE 0 END),
	--SUM_DIS10 = SUM(CASE WHEN DM.VAT_RATE_SAL = 10 THEN CASE WHEN DM.CODE_OP='DIS' AND DM.ID_TABLE=19 THEN DM.SUM_ACC * DM.SIGN_OP WHEN DM.CODE_OP='DIS' AND DM.ID_TABLE<>19 THEN DM.SUM_ACC ELSE 0 END ELSE 0 END),
	--SUM_DIS18 = SUM(CASE WHEN DM.VAT_RATE_SAL = 18 THEN CASE WHEN DM.CODE_OP='DIS' AND DM.ID_TABLE=19 THEN DM.SUM_ACC * DM.SIGN_OP WHEN DM.CODE_OP='DIS' AND DM.ID_TABLE<>19 THEN DM.SUM_ACC ELSE 0 END ELSE 0 END)
--INTO #START_RESTS
FROM DOC_MOVEMENT DM
WHERE DATE_OP < @DATE_FR
AND DM.ID_STORE IN (SELECT ID_STORE FROM #STORE)

/*SELECT 
	SUM_SUP,
	SUM_ACC = SUM_ACC + CASE WHEN @DIS = 1 THEN SUM_DIS ELSE 0 END,
	NAL = NAL + CASE WHEN @DIS = 1 THEN NAL ELSE 0 END,
	KOF,
	
	SUM_SVAT_SUP,
	SUM_SVAT_ACC = SUM_SVAT_ACC * CASE WHEN @DIS = 1 AND SUM_ACC > 0 
		THEN (SUM_ACC + CASE WHEN @DIS = 1 THEN SUM_DIS ELSE 0 END) / SUM_ACC
		ELSE 1 END,
	
	SUM_SUP0,
	SUM_SUP10,
	SUM_SUP18,
	SUM_ACC0 = SUM_ACC0 + CASE WHEN @DIS = 1 THEN SUM_DIS0 ELSE 0 END,
	SUM_ACC10 = SUM_ACC10 + CASE WHEN @DIS = 1 THEN SUM_DIS10 ELSE 0 END,
	SUM_ACC18 = SUM_ACC18 + CASE WHEN @DIS = 1 THEN SUM_DIS18 ELSE 0 END,
	
	SVAT_SUP10,
	SVAT_SUP18,
	SVAT_ACC10 = SVAT_ACC10 * CASE WHEN @DIS = 1 AND SUM_ACC10 > 0 
		THEN (SUM_ACC10 + CASE WHEN @DIS = 1 THEN SUM_DIS10 ELSE 0 END) / SUM_ACC10
		ELSE 1 END,
	SVAT_ACC18 = SVAT_ACC18 * CASE WHEN @DIS = 1 AND SUM_ACC18 > 0 
		THEN (SUM_ACC18 + CASE WHEN @DIS = 1 THEN SUM_DIS18 ELSE 0 END) / SUM_ACC18
		ELSE 1 END
FROM #START_RESTS*/

IF(@SHOW_ADD = 1) BEGIN
	-- Œ¡Ÿ»… œ–»’Œƒ œŒ ƒŒ ”Ã≈Õ“¿Ã
    SELECT
        ID_DOCUMENT = DM.ID_DOCUMENT,
        DOC_NAME = ISNULL(TD.DESCRIPTION+': ','')+ISNULL(C.NAME,'')+ISNULL('('+S.NAME+')',''),
        DATE_OP = DM.DATE_OP, 
        DOC_NUM = AD.DOC_NUM,
		INCOMING_NUMBER = CASE WHEN DM.ID_TABLE = 2 THEN ISNULL('π Õœ:'+ I.INCOMING_NUMBER,'') ELSE '' END,

	    SUM_SUP = SUM(DM.SUM_SUP),
	    SUM_ACC = SUM(DM.SUM_ACC),--SUM(CASE WHEN CODE_OP<>'DIS' THEN DM.SUM_ACC ELSE 0 END),
		NAL = SUM(DM.SUM_ACC - DM.SUM_SUP),
	    KOF = CASE WHEN MAX(CODE_OP) = 'DIS' THEN 0 ELSE 1 END,
	
	    SUM_SVAT_SUP = SUM(DM.SVAT_SUP),
	    SUM_SVAT_ACC = SUM(DM.SVAT_ACC),--SUM(CASE WHEN CODE_OP<>'DIS' THEN DM.SVAT_ACC ELSE 0 END),
	
	    SUM_SUP0 = SUM(CASE WHEN DM.VAT_RATE = 0 THEN (DM.SUM_SUP * DM.SIGN_OP) ELSE 0 END),
	    SUM_SUP10 = SUM(CASE WHEN DM.VAT_RATE = 10 THEN (DM.SUM_SUP * DM.SIGN_OP) ELSE 0 END),
	    SUM_SUP18 = SUM(CASE WHEN DM.VAT_RATE = 18 THEN (DM.SUM_SUP * DM.SIGN_OP) ELSE 0 END),

	    SUM_ACC0 = SUM(CASE WHEN DM.VAT_RATE = 0 THEN SUM_ACC ELSE 0 END),
	    SUM_ACC10 = SUM(CASE WHEN DM.VAT_RATE =10 THEN SUM_ACC ELSE 0 END),
	    SUM_ACC18 = SUM(CASE WHEN DM.VAT_RATE = 18 THEN SUM_ACC ELSE 0 END),
	
	    SVAT_SUP10 = SUM(CASE WHEN DM.VAT_RATE = 10 THEN (DM.SVAT_SUP * DM.SIGN_OP) ELSE 0 END),
	    SVAT_SUP18 = SUM(CASE WHEN DM.VAT_RATE = 18 THEN (DM.SVAT_SUP * DM.SIGN_OP) ELSE 0 END),
	    SVAT_ACC10 = SUM(CASE WHEN DM.VAT_RATE = 10 THEN SVAT_ACC ELSE 0 END),
	    SVAT_ACC18 = SUM(CASE WHEN DM.VAT_RATE = 18 THEN SVAT_ACC ELSE 0 END),
	    
	    ID_CONTRACTOR_FROM = ISNULL(DM.ID_CONTRACTOR_FROM, 0),
	    CONTRACTOR_FROM = ISNULL(C.NAME,''),
	    DM.ID_TABLE,
	    DOC_TYPE = TD.DESCRIPTION

    FROM DOC_MOVEMENT DM
    INNER JOIN TABLE_DATA TD ON TD.ID_TABLE_DATA = DM.ID_TABLE
    INNER JOIN ALL_DOCUMENT AD ON AD.ID_DOCUMENT_GLOBAL = DM.ID_DOCUMENT
	LEFT JOIN INVOICE I ON DM.ID_DOCUMENT = I.ID_INVOICE_GLOBAL
    LEFT JOIN CONTRACTOR C ON C.ID_CONTRACTOR = DM.ID_CONTRACTOR_FROM
    LEFT JOIN STORE S ON S.ID_STORE = DM.ID_STORE_FROM
    WHERE DM.CODE_OP='ADD' AND DM.ID_TABLE <> 19
	AND DATE_OP BETWEEN @DATE_FR AND @DATE_TO
	AND DM.ID_STORE IN (SELECT ID_STORE FROM #STORE)
	AND (@NOAU = 1 OR (DM.ID_TABLE not in (8, 37, 39)) OR dm.id_store_from not in (select id_store from #store where id_contractor = dm.id_contractor_to))
    GROUP BY DM.ID_DOCUMENT, 
			 DM.ID_TABLE, 
			 TD.DESCRIPTION, 
			 DM.DATE_OP, 
			 AD.DOC_NUM,
  			 CASE WHEN DM.ID_TABLE = 2 THEN ISNULL('π Õœ:'+ I.INCOMING_NUMBER,'') ELSE '' END,
			 ISNULL(TD.DESCRIPTION+': ','')+ISNULL(C.NAME,'')+ISNULL('('+S.NAME+')',''),
			 ISNULL(DM.ID_CONTRACTOR_FROM, 0),
			 ISNULL(C.NAME,''),
             ISNULL(C.NAME,'')+ISNULL('('+S.NAME+')','')
    ORDER BY CASE WHEN NULLIF(@SORT_DOC,0) IS NULL THEN DM.DATE_OP ELSE NULL END, 
		CASE WHEN NULLIF(@SORT_DOC,0) IS NULL THEN NULL ELSE TD.DESCRIPTION END, 
		ISNULL(C.NAME,''), DM.DATE_OP
END
ELSE BEGIN
    SELECT
        ID_DOCUMENT = CAST(NULL AS UNIQUEIDENTIFIER),
        DOC_NAME = CAST(NULL AS NVARCHAR(128)),
		DATE_OP = CAST(NULL AS DATETIME),
		DOC_NUM = CAST(NULL AS NVARCHAR(128)),
		INCOMING_NUMBER = CAST(NULL AS NVARCHAR(128)),
        SUM_SUP = CAST(NULL AS MONEY),
        SUM_ACC = CAST(NULL AS MONEY),
		KOF = CAST(NULL AS BIT),
		SUM_SVAT_SUP = CAST(NULL AS MONEY),
		SUM_SVAT_ACC = CAST(NULL AS MONEY),
		SUM_SUP0 = CAST(NULL AS MONEY),
		SUM_SUP10 = CAST(NULL AS MONEY),
		SUM_SUP18 = CAST(NULL AS MONEY),
		SUM_ACC0 = CAST(NULL AS MONEY),
		SUM_ACC10 = CAST(NULL AS MONEY),
		SUM_ACC18 = CAST(NULL AS MONEY),
	    SVAT_SUP10 = CAST(NULL AS MONEY),
	    SVAT_SUP18 = CAST(NULL AS MONEY),
	    SVAT_ACC10 = CAST(NULL AS MONEY),
	    SVAT_ACC18 = CAST(NULL AS MONEY),
	    
	    ID_CONTRACTOR_FROM = CAST(NULL AS BIGINT),
	    CONTRACTOR_FROM = CAST(NULL AS NVARCHAR(128)),
	    ID_TABLE = CAST(NULL AS BIGINT),
	    DOC_TYPE = CAST(NULL AS NVARCHAR(128))
END

IF(@SHOW_SUB = 1) BEGIN
-- Œ¡Ÿ»… –¿—’Œƒ œŒ ƒŒ ”Ã≈Õ“¿Ã
SELECT 
    ID_DOCUMENT = DM.ID_DOCUMENT,
    DOC_NAME = ISNULL(TD.DESCRIPTION+': ','')+CASE WHEN DM.ID_TABLE=19 THEN '' ELSE ISNULL(C.NAME,'')+ISNULL('('+S.NAME+')','') END,
    DATE_OP = DM.DATE_OP, 
    DOC_NUM = AD.DOC_NUM,
	
	SUM_DIS = SUM(CASE WHEN DM.CODE_OP='DIS' AND DM.ID_TABLE=19 THEN DM.SUM_ACC * DM.SIGN_OP WHEN DM.CODE_OP='DIS' AND DM.ID_TABLE<>19 THEN DM.SUM_ACC ELSE 0 END),
	SUM_DIS0 = SUM(CASE WHEN DM.VAT_RATE = 0 THEN CASE WHEN DM.CODE_OP='DIS' AND DM.ID_TABLE=19 THEN DM.SUM_ACC * DM.SIGN_OP WHEN DM.CODE_OP='DIS' AND DM.ID_TABLE<>19 THEN DM.SUM_ACC ELSE 0 END ELSE 0 END),
	SUM_DIS10 = SUM(CASE WHEN DM.VAT_RATE = 10 THEN CASE WHEN DM.CODE_OP='DIS' AND DM.ID_TABLE=19 THEN DM.SUM_ACC * DM.SIGN_OP WHEN DM.CODE_OP='DIS' AND DM.ID_TABLE<>19 THEN DM.SUM_ACC ELSE 0 END ELSE 0 END),
	SUM_DIS18 = SUM(CASE WHEN DM.VAT_RATE = 18 THEN CASE WHEN DM.CODE_OP='DIS' AND DM.ID_TABLE=19 THEN DM.SUM_ACC * DM.SIGN_OP WHEN DM.CODE_OP='DIS' AND DM.ID_TABLE<>19 THEN DM.SUM_ACC ELSE 0 END ELSE 0 END),
	
    SUM_SUP = SUM(CASE WHEN DM.CODE_OP='DIS' THEN 0 ELSE DM.SUM_SUP * DM.SIGN_OP * -1 END),
    SUM_ACC = SUM(CASE WHEN DM.CODE_OP='DIS' THEN 0 ELSE DM.SUM_ACC * DM.SIGN_OP * -1 END),
	NAL = SUM(CASE WHEN DM.CODE_OP='DIS' THEN 0 ELSE DM.SUM_ACC * DM.SIGN_OP * -1 END - CASE WHEN DM.CODE_OP='DIS' THEN 0 ELSE DM.SUM_SUP * DM.SIGN_OP * -1 END),
    KOF = CASE WHEN MAX(CODE_OP) = 'DIS' THEN 0 ELSE 1 END,

    SUM_SVAT_SUP = SUM(CASE WHEN DM.CODE_OP='DIS' THEN 0 ELSE DM.SVAT_SUP * DM.SIGN_OP * -1 END),
    SUM_SVAT_ACC = SUM(CASE WHEN DM.CODE_OP='DIS' THEN 0 ELSE DM.SVAT_ACC * DM.SIGN_OP * -1 END),

    SUM_SUP0 = SUM(CASE WHEN DM.VAT_RATE = 0 THEN CASE WHEN DM.CODE_OP = 'ADD' THEN -1 * DM.SUM_SUP ELSE DM.SUM_SUP END ELSE 0 END),
    SUM_SUP10 = SUM(CASE WHEN DM.VAT_RATE = 10 THEN CASE WHEN DM.CODE_OP = 'ADD' THEN -1 * DM.SUM_SUP ELSE DM.SUM_SUP END ELSE 0 END),
    SUM_SUP18 = SUM(CASE WHEN DM.VAT_RATE = 18 THEN CASE WHEN DM.CODE_OP = 'ADD' THEN -1 * DM.SUM_SUP ELSE DM.SUM_SUP END ELSE 0 END),
    SUM_ACC0 = SUM(CASE WHEN DM.VAT_RATE = 0 THEN CASE WHEN DM.CODE_OP='DIS' THEN 0	ELSE DM.SUM_ACC * DM.SIGN_OP * -1 END ELSE 0 END),
    SUM_ACC10 = SUM(CASE WHEN DM.VAT_RATE = 10 THEN CASE WHEN DM.CODE_OP='DIS' THEN 0 ELSE DM.SUM_ACC * DM.SIGN_OP * -1 END ELSE 0 END),
    SUM_ACC18 = SUM(CASE WHEN DM.VAT_RATE = 18 THEN CASE WHEN DM.CODE_OP='DIS' THEN 0 ELSE DM.SUM_ACC * DM.SIGN_OP * -1	END ELSE 0 END),

    SVAT_SUP10 = SUM(CASE WHEN DM.VAT_RATE = 10 THEN CASE WHEN DM.CODE_OP = 'ADD' THEN -1 * DM.SVAT_SUP ELSE DM.SVAT_SUP END ELSE 0 END),
    SVAT_SUP18 = SUM(CASE WHEN DM.VAT_RATE = 18 THEN CASE WHEN DM.CODE_OP = 'ADD' THEN -1 * DM.SVAT_SUP ELSE DM.SVAT_SUP END ELSE 0 END),
    SVAT_ACC10 = SUM(CASE WHEN DM.VAT_RATE = 10 THEN CASE WHEN DM.CODE_OP='DIS' THEN 0 ELSE DM.SVAT_ACC * DM.SIGN_OP * -1 END ELSE 0 END),
    SVAT_ACC18 = SUM(CASE WHEN DM.VAT_RATE = 18 THEN CASE WHEN DM.CODE_OP='DIS' THEN 0 ELSE DM.SVAT_ACC * DM.SIGN_OP * -1 END ELSE 0 END),
    
    ID_CONTRACTOR_TO = CASE WHEN DM.ID_TABLE=19 THEN NULL ELSE ISNULL(DM.ID_CONTRACTOR_TO, 0) END,
    CONTRACTOR_TO = CASE WHEN DM.ID_TABLE=19 THEN NULL ELSE ISNULL(C.NAME,'') END,
    ID_TABLE = DM.ID_TABLE,
    DOC_TYPE = TD.DESCRIPTION
INTO #T
FROM DOC_MOVEMENT DM
INNER JOIN TABLE_DATA TD ON TD.ID_TABLE_DATA = DM.ID_TABLE
INNER JOIN ALL_DOCUMENT AD ON AD.ID_DOCUMENT_GLOBAL = DM.ID_DOCUMENT
LEFT JOIN CONTRACTOR C ON C.ID_CONTRACTOR = DM.ID_CONTRACTOR_TO
LEFT JOIN STORE S ON S.ID_STORE = DM.ID_STORE_TO
WHERE (CODE_OP IN ('SUB', 'DIS') OR (CODE_OP = 'ADD' AND dm.ID_TABLE = 19))
	AND DATE_OP BETWEEN @DATE_FR AND @DATE_TO
	AND DM.ID_STORE IN (SELECT ID_STORE FROM #STORE)
	AND (@NOAU = 1 OR (DM.ID_TABLE not in (8, 37, 39)) OR dm.id_store_to not in (select id_store from #store where id_contractor = dm.id_contractor_from))
GROUP BY DM.ID_DOCUMENT,
	     DM.ID_TABLE, 
         TD.DESCRIPTION, 
         DM.DATE_OP, 
         AD.DOC_NUM,
		 ISNULL(TD.DESCRIPTION+': ','')+CASE WHEN DM.ID_TABLE=19 THEN '' ELSE ISNULL(C.NAME,'')+ISNULL('('+S.NAME+')','') END,
		 CASE WHEN DM.ID_TABLE=19 THEN NULL ELSE ISNULL(DM.ID_CONTRACTOR_TO, 0) END,
		 CASE WHEN DM.ID_TABLE=19 THEN NULL ELSE ISNULL(C.NAME,'') END,
		 CASE WHEN DM.ID_TABLE=19 THEN NULL ELSE ISNULL(C.NAME,'')+ISNULL('('+S.NAME+')','') END			
ORDER BY CASE WHEN NULLIF(@SORT_DOC,0) IS NULL THEN DM.DATE_OP ELSE NULL END, 
	CASE WHEN NULLIF(@SORT_DOC,0) IS NULL THEN NULL ELSE TD.DESCRIPTION END, 
	CASE WHEN DM.ID_TABLE=19 THEN NULL ELSE ISNULL(C.NAME,'') END, DM.DATE_OP

--SELECT * FROM #T
SELECT
	T.ID_DOCUMENT,
	T.DOC_NAME,
	T.DATE_OP,
	T.DOC_NUM,
	T.SUM_DIS,
	T.SUM_DIS0,
	T.SUM_DIS10,
	T.SUM_DIS18,
	T.SUM_SUP,
	SUM_ACC = T.SUM_ACC + CASE WHEN @DIS = 1 THEN T.SUM_DIS ELSE 0 END,
	NAL = T.NAL + CASE WHEN @DIS = 1 THEN T.SUM_DIS ELSE 0 END,
	T.KOF,
	T.SUM_SVAT_SUP,
	SUM_SVAT_ACC = T.SUM_SVAT_ACC * CASE WHEN @DIS = 1 AND T.SUM_ACC > 0 
		THEN (T.SUM_ACC + CASE WHEN @DIS = 1 THEN T.SUM_DIS ELSE 0 END) / T.SUM_ACC
		ELSE 1 END,
	T.SUM_SUP0,
	T.SUM_SUP10,
	T.SUM_SUP18,
	SUM_ACC0 = T.SUM_ACC0 + CASE WHEN @DIS = 1 THEN T.SUM_DIS0 ELSE 0 END,
	SUM_ACC10 = T.SUM_ACC10 + CASE WHEN @DIS = 1 THEN T.SUM_DIS10 ELSE 0 END,
	SUM_ACC18 = T.SUM_ACC18 + CASE WHEN @DIS = 1 THEN T.SUM_DIS18 ELSE 0 END,
	T.SVAT_SUP10,
	T.SVAT_SUP18,
	SVAT_ACC10 = T.SVAT_ACC10 * CASE WHEN @DIS = 1 AND T.SUM_ACC10 > 0 
		THEN (T.SUM_ACC10 + CASE WHEN @DIS = 1 THEN T.SUM_DIS10 ELSE 0 END) / T.SUM_ACC10
		ELSE 1 END,
	SVAT_ACC18 = T.SVAT_ACC18 * CASE WHEN @DIS = 1 AND T.SUM_ACC18 > 0 
		THEN (T.SUM_ACC18 + CASE WHEN @DIS = 1 THEN T.SUM_DIS18 ELSE 0 END) / T.SUM_ACC18
		ELSE 1 END,
	T.ID_CONTRACTOR_TO,
	T.CONTRACTOR_TO,
	T.ID_TABLE,
	T.DOC_TYPE
FROM #T T

SELECT 
	SUM_DIS = SUM(SUM_DIS),
	SUM_DIS0 = SUM(SUM_DIS0),
	SUM_DIS10 = SUM(SUM_DIS10),
	SUM_DIS18 = SUM(SUM_DIS18)	
FROM #T
END
ELSE BEGIN
SELECT
    ID_DOCUMENT = CAST(NULL AS UNIQUEIDENTIFIER),
    DOC_NAME = CAST(NULL AS NVARCHAR(128)),
	DATE_OP = CAST(NULL AS DATETIME),
	DOC_NUM = CAST(NULL AS NVARCHAR(128)),
	SUM_DIS = CAST(NULL AS MONEY),
	SUM_DIS0 = CAST(NULL AS MONEY),
	SUM_DIS10 = CAST(NULL AS MONEY),
	SUM_DIS18 = CAST(NULL AS MONEY),
    SUM_SUP = CAST(NULL AS MONEY),
    SUM_ACC = CAST(NULL AS MONEY),
	KOF = CAST(NULL AS BIT),
	SUM_SVAT_SUP = CAST(NULL AS MONEY),
	SUM_SVAT_ACC = CAST(NULL AS MONEY),
	SUM_SUP0 = CAST(NULL AS MONEY),
	SUM_SUP10 = CAST(NULL AS MONEY),
	SUM_SUP18 = CAST(NULL AS MONEY),
	SUM_ACC0 = CAST(NULL AS MONEY),
	SUM_ACC10 = CAST(NULL AS MONEY),
	SUM_ACC18 = CAST(NULL AS MONEY),
    SVAT_SUP10 = CAST(NULL AS MONEY),
    SVAT_SUP18 = CAST(NULL AS MONEY),
    SVAT_ACC10 = CAST(NULL AS MONEY),
    SVAT_ACC18 = CAST(NULL AS MONEY),
    ID_CONTRACTOR_TO = CAST(NULL AS BIGINT),
	CONTRACTOR_TO = CAST(NULL AS NVARCHAR(128)),
	ID_TABLE = CAST(NULL AS BIGINT),
	DOC_TYPE = CAST(NULL AS NVARCHAR(128))
    
SELECT 
	SUM_DIS = NULL,
	SUM_DIS0 = NULL,
	SUM_DIS10 = NULL,
	SUM_DIS18 = NULL
END

DECLARE @STORES VARCHAR(1024)
DECLARE @CONTRACTORS VARCHAR(1024)

EXEC DBO.USP_TABLE_NAMES '#STORE', @STORES OUT
EXEC DBO.USP_TABLE_NAMES '#CONTRACTOR', @CONTRACTORS OUT
SELECT CONTRACTOR = @CONTRACTORS, STORE = @STORES

-- Œ—“¿“Œ  Õ¿  ŒÕ≈÷
SELECT
    SUM_SUP = SUM(DM.SUM_SUP * DM.SIGN_OP),
    SUM_ACC = SUM(CASE WHEN ID_TABLE=19 AND CODE_OP='DIS' THEN -1 ELSE 1 END * DM.SUM_ACC * DM.SIGN_OP),
	NAL = SUM(CASE WHEN ID_TABLE=19 AND CODE_OP='DIS' THEN -1 ELSE 1 END * DM.SUM_ACC * DM.SIGN_OP - DM.SUM_SUP * DM.SIGN_OP),
    KOF = CASE WHEN MAX(CODE_OP) = 'DIS' THEN 0 ELSE 1 END,

    SUM_SVAT_SUP = SUM(DM.SVAT_SUP * DM.SIGN_OP),
    SUM_SVAT_ACC = SUM(CASE WHEN DM.ID_TABLE=19 AND CODE_OP='DIS' THEN -1 ELSE 1 END * DM.SVAT_ACC * DM.SIGN_OP),

    SUM_SUP0 = SUM(CASE WHEN DM.VAT_RATE = 0 THEN (DM.SUM_SUP * DM.SIGN_OP) ELSE 0 END),
    SUM_SUP10 = SUM(CASE WHEN DM.VAT_RATE = 10 THEN (DM.SUM_SUP * DM.SIGN_OP) ELSE 0 END),
    SUM_SUP18 = SUM(CASE WHEN DM.VAT_RATE = 18 THEN (DM.SUM_SUP * DM.SIGN_OP) ELSE 0 END),
    SUM_ACC0 = SUM(CASE WHEN DM.VAT_RATE = 0 THEN CASE WHEN DM.ID_TABLE=19 AND CODE_OP='DIS' THEN -1 ELSE 1 END * SUM_ACC * DM.SIGN_OP ELSE 0 END),
    SUM_ACC10 = SUM(CASE WHEN DM.VAT_RATE = 10 THEN CASE WHEN DM.ID_TABLE=19 AND CODE_OP='DIS' THEN -1 ELSE 1 END * SUM_ACC * DM.SIGN_OP ELSE 0 END),
    SUM_ACC18 = SUM(CASE WHEN DM.VAT_RATE = 18 THEN CASE WHEN DM.ID_TABLE=19 AND CODE_OP='DIS' THEN -1 ELSE 1 END * SUM_ACC * DM.SIGN_OP ELSE 0 END),

    SVAT_SUP10 = SUM(CASE WHEN DM.VAT_RATE = 10 THEN (DM.SVAT_SUP * DM.SIGN_OP) ELSE 0 END),
    SVAT_SUP18 = SUM(CASE WHEN DM.VAT_RATE = 18 THEN (DM.SVAT_SUP * DM.SIGN_OP) ELSE 0 END),
    SVAT_ACC10 = SUM(CASE WHEN DM.VAT_RATE = 10 THEN CASE WHEN DM.ID_TABLE=19 AND CODE_OP='DIS' THEN -1 ELSE 1 END * SVAT_ACC * DM.SIGN_OP ELSE 0 END),
    SVAT_ACC18 = SUM(CASE WHEN DM.VAT_RATE = 18 THEN CASE WHEN DM.ID_TABLE=19 AND CODE_OP='DIS' THEN -1 ELSE 1 END * SVAT_ACC * DM.SIGN_OP ELSE 0 END)
    --,
    
    --SUM_DIS = SUM(CASE WHEN DM.CODE_OP='DIS' AND DM.ID_TABLE=19 THEN DM.SUM_ACC * DM.SIGN_OP WHEN DM.CODE_OP='DIS' AND DM.ID_TABLE<>19 THEN DM.SUM_ACC ELSE 0 END),
	--SUM_DIS0 = SUM(CASE WHEN DM.VAT_RATE_SAL = 0 THEN CASE WHEN DM.CODE_OP='DIS' AND DM.ID_TABLE=19 THEN DM.SUM_ACC * DM.SIGN_OP WHEN DM.CODE_OP='DIS' AND DM.ID_TABLE<>19 THEN DM.SUM_ACC ELSE 0 END ELSE 0 END),
	--SUM_DIS10 = SUM(CASE WHEN DM.VAT_RATE_SAL = 10 THEN CASE WHEN DM.CODE_OP='DIS' AND DM.ID_TABLE=19 THEN DM.SUM_ACC * DM.SIGN_OP WHEN DM.CODE_OP='DIS' AND DM.ID_TABLE<>19 THEN DM.SUM_ACC ELSE 0 END ELSE 0 END),
	--SUM_DIS18 = SUM(CASE WHEN DM.VAT_RATE_SAL = 18 THEN CASE WHEN DM.CODE_OP='DIS' AND DM.ID_TABLE=19 THEN DM.SUM_ACC * DM.SIGN_OP WHEN DM.CODE_OP='DIS' AND DM.ID_TABLE<>19 THEN DM.SUM_ACC ELSE 0 END ELSE 0 END)
--INTO #RESTS
FROM DOC_MOVEMENT DM
WHERE DATE_OP <= @DATE_TO
AND DM.ID_STORE IN (SELECT ID_STORE FROM #STORE)

/*SELECT 
	SUM_SUP,
	SUM_ACC = SUM_ACC + CASE WHEN @DIS = 1 THEN SUM_DIS ELSE 0 END,
	NAL = NAL + CASE WHEN @DIS = 1 THEN NAL ELSE 0 END,
	KOF,
	
	SUM_SVAT_SUP,
	SUM_SVAT_ACC = SUM_SVAT_ACC * CASE WHEN @DIS = 1 AND SUM_ACC > 0 
		THEN (SUM_ACC + CASE WHEN @DIS = 1 THEN SUM_DIS ELSE 0 END) / SUM_ACC
		ELSE 1 END,
	
	SUM_SUP0,
	SUM_SUP10,
	SUM_SUP18,
	SUM_ACC0 = SUM_ACC0 + CASE WHEN @DIS = 1 THEN SUM_DIS0 ELSE 0 END,
	SUM_ACC10 = SUM_ACC10 + CASE WHEN @DIS = 1 THEN SUM_DIS10 ELSE 0 END,
	SUM_ACC18 = SUM_ACC18 + CASE WHEN @DIS = 1 THEN SUM_DIS18 ELSE 0 END,
	
	SVAT_SUP10,
	SVAT_SUP18,
	SVAT_ACC10 = SVAT_ACC10 * CASE WHEN @DIS = 1 AND SUM_ACC10 > 0 
		THEN (SUM_ACC10 + CASE WHEN @DIS = 1 THEN SUM_DIS10 ELSE 0 END) / SUM_ACC10
		ELSE 1 END,
	SVAT_ACC18 = SVAT_ACC18 * CASE WHEN @DIS = 1 AND SUM_ACC18 > 0 
		THEN (SUM_ACC18 + CASE WHEN @DIS = 1 THEN SUM_DIS18 ELSE 0 END) / SUM_ACC18
		ELSE 1 END
FROM #RESTS*/

SELECT
	SUM_ACC = NULL,
	SUM_ACC0 = NULL,
	SUM_ACC10 = NULL,
	SUM_ACC18 = NULL,
	SUM_VAT = NULL,
	SVAT_ACC10 = NULL,
	SVAT_ACC18 = NULL

RETURN 0
GO

/*
exec REP_GOODS_REPORTS_TO_EX N'
<XML>
	<DATE_FR>2009-12-10T00:00:00.000</DATE_FR>
	<DATE_TO>2009-12-10T00:00:00.000</DATE_TO>
	<SHOW_ADD>1</SHOW_ADD>
	<SHOW_SUB>1</SHOW_SUB>
	<SORT_DOC>1</SORT_DOC>
	<ID_CONTRACTOR>5271</ID_CONTRACTOR>
	<NOAU>1</NOAU>
</XML>'*/

SET NOCOUNT ON
SET QUOTED_IDENTIFIER OFF
GO

IF (OBJECT_ID('DBO.REP_GOODS_REPORTS_TO_EX_SERVICE') IS NULL ) EXEC ('CREATE PROCEDURE DBO.REP_GOODS_REPORTS_TO_EX_SERVICE AS SELECT NULL')
GO
ALTER PROCEDURE DBO.REP_GOODS_REPORTS_TO_EX_SERVICE
         @XMLPARAM NTEXT
AS
SET NOCOUNT ON
DECLARE @DATE_FR DATETIME, @DATE_TO DATETIME
DECLARE @SORT_DOC BIT, @SHOW_ADD BIT, @SHOW_SUB BIT, @REFRESH_DOC_MOV BIT

DECLARE @HDOC INT, @SQL NVARCHAR(4000), @SQL_FIELDS NVARCHAR(4000)
DECLARE @NOAU BIT, @DIS BIT, @CO BIT

EXEC SP_XML_PREPAREDOCUMENT @HDOC OUTPUT, @XMLPARAM OUTPUT
    SELECT TOP 1 
        @DATE_FR = DATE_FR, @DATE_TO = DATE_TO,
        @SORT_DOC = SORT_DOC,
        @SHOW_ADD = SHOW_ADD, @SHOW_SUB = SHOW_SUB,
        @REFRESH_DOC_MOV = REFRESH_DOC_MOV,
		@NOAU = NOAU, @DIS = DIS, @CO = CO
    FROM OPENXML(@HDOC, '/XML') WITH(
        DATE_FR DATETIME 'DATE_FR', 
        DATE_TO DATETIME 'DATE_TO', 
        SORT_DOC BIT 'SORT_DOC', 
        SHOW_ADD BIT 'SHOW_ADD', 
        SHOW_SUB BIT 'SHOW_SUB',
        REFRESH_DOC_MOV BIT 'REFRESH_DOC_MOV',
		NOAU BIT 'NOAU',
		DIS BIT 'DIS',
		CO BIT 'CO')

    /* “¿¡À»÷¿ »ƒ≈Õ“»‘» ¿“Œ–Œ¬  ŒÕ“–¿√≈Õ“Œ¬ */
    SELECT DISTINCT C.ID_CONTRACTOR, C.NAME INTO #CONTRACTOR
    FROM 
        (SELECT * FROM OPENXML(@HDOC, '//ID_CONTRACTOR') 
        WITH(ID_CONTRACTOR BIGINT '.')) TAB
    INNER JOIN CONTRACTOR C ON C.ID_CONTRACTOR = TAB.ID_CONTRACTOR
    WHERE ((@CO <> 1 OR @CO IS NULL) 
		AND C.ID_CONTRACTOR = (SELECT TOP 1 ID_CONTRACTOR FROM ENTERPRISE_BRANCH WHERE IS_SELF = 1))
		OR (@CO = 1)
    
    /* “¿¡À»÷¿ »ƒ≈Õ“»‘» ¿“Œ–Œ¬ — À¿ƒŒ¬ */
    SELECT DISTINCT S.ID_STORE, S.ID_CONTRACTOR, S.NAME INTO #STORE
    FROM
    	(SELECT * FROM OPENXML(@HDOC, '//ID_STORE') 
        WITH(ID_STORE BIGINT '.')) TAB
    INNER JOIN STORE S ON S.ID_STORE = TAB.ID_STORE
    WHERE ((@CO <> 1 OR @CO IS NULL) 
		AND S.ID_CONTRACTOR = (SELECT TOP 1 ID_CONTRACTOR FROM ENTERPRISE_BRANCH WHERE IS_SELF = 1))
		OR (@CO = 1)
		
EXEC SP_XML_REMOVEDOCUMENT @HDOC

IF @REFRESH_DOC_MOV = 1 BEGIN
    -- ÔÂÂÒ˜ËÚ‡Ú¸ DOC_MOVEMENT ÔÓ ‚ÒÂÏ ‰ÓÍÛÏÂÌÚ‡Ï
    EXEC UTL_REFRESH_DOC_MOVEMENT 'REPAIR', 0
END

-- ÓÚÌÓÏËÓ‚‡Ú¸ ‰‡Ú˚
EXEC USP_RANGE_DAYS @DATE_FR OUT, @DATE_TO OUT
EXEC USP_RANGE_NORM @DATE_FR OUT, @DATE_TO OUT

-- ≈—À» Õ≈ ” ¿«¿Õ — À¿ƒ, “Œ »“Œ√» ¬€¡»–¿ﬁ“—ﬂ œŒ ¬—≈Ã — À¿ƒ¿Ã
IF NOT EXISTS(SELECT TOP 1 1 FROM #STORE) BEGIN
    INSERT INTO #STORE (ID_STORE, ID_CONTRACTOR, NAME)
    SELECT S.ID_STORE, S.ID_CONTRACTOR, S.NAME
    FROM STORE S(NOLOCK) INNER JOIN #CONTRACTOR C ON C.ID_CONTRACTOR = S.ID_CONTRACTOR
END
DELETE FROM #STORE WHERE ID_CONTRACTOR NOT IN (SELECT ID_CONTRACTOR FROM #CONTRACTOR)

-- Œ—“¿“Œ  Õ¿ Õ¿◊¿ÀŒ
SELECT
    SUM_SUP = SUM(DM.SUM_SUP * DM.SIGN_OP),
    SUM_ACC = SUM(CASE WHEN DM.ID_TABLE=19 AND CODE_OP='DIS' THEN -1 ELSE 1 END * DM.SUM_ACC * DM.SIGN_OP),
	NAL = SUM(CASE WHEN DM.ID_TABLE=19 AND CODE_OP='DIS' THEN -1 ELSE 1 END * DM.SUM_ACC * DM.SIGN_OP - DM.SUM_SUP * DM.SIGN_OP),
    KOF = CASE WHEN MAX(CODE_OP) = 'DIS' THEN 0 ELSE 1 END,

    SUM_SVAT_SUP = SUM(DM.SVAT_SUP * DM.SIGN_OP),
    SUM_SVAT_ACC = SUM(CASE WHEN DM.ID_TABLE=19 AND CODE_OP='DIS' THEN -1 ELSE 1 END * DM.SVAT_ACC * DM.SIGN_OP),

    SUM_SUP0 = SUM(CASE WHEN DM.VAT_RATE = 0 THEN (DM.SUM_SUP * DM.SIGN_OP) ELSE 0 END),
    SUM_SUP10 = SUM(CASE WHEN DM.VAT_RATE = 10 THEN (DM.SUM_SUP * DM.SIGN_OP) ELSE 0 END),
    SUM_SUP18 = SUM(CASE WHEN DM.VAT_RATE = 18 THEN (DM.SUM_SUP * DM.SIGN_OP) ELSE 0 END),
    SUM_ACC0 = SUM(CASE WHEN DM.VAT_RATE = 0 THEN CASE WHEN DM.ID_TABLE=19 AND CODE_OP='DIS' THEN -1 ELSE 1 END * SUM_ACC * DM.SIGN_OP ELSE 0 END),
    SUM_ACC10 = SUM(CASE WHEN DM.VAT_RATE = 10 THEN CASE WHEN DM.ID_TABLE=19 AND CODE_OP='DIS' THEN -1 ELSE 1 END * SUM_ACC * DM.SIGN_OP ELSE 0 END),
    SUM_ACC18 = SUM(CASE WHEN DM.VAT_RATE = 18 THEN CASE WHEN DM.ID_TABLE=19 AND CODE_OP='DIS' THEN -1 ELSE 1 END * SUM_ACC * DM.SIGN_OP ELSE 0 END),

    SVAT_SUP10 = SUM(CASE WHEN DM.VAT_RATE = 10 THEN (DM.SVAT_SUP * DM.SIGN_OP) ELSE 0 END),
    SVAT_SUP18 = SUM(CASE WHEN DM.VAT_RATE = 18 THEN (DM.SVAT_SUP * DM.SIGN_OP) ELSE 0 END),
    SVAT_ACC10 = SUM(CASE WHEN DM.VAT_RATE = 10 THEN CASE WHEN DM.ID_TABLE=19 AND CODE_OP='DIS' THEN -1 ELSE 1 END * SVAT_ACC * DM.SIGN_OP ELSE 0 END),
    SVAT_ACC18 = SUM(CASE WHEN DM.VAT_RATE = 18 THEN CASE WHEN DM.ID_TABLE=19 AND CODE_OP='DIS' THEN -1 ELSE 1 END * SVAT_ACC * DM.SIGN_OP ELSE 0 END)
    --,
    
    --SUM_DIS = SUM(CASE WHEN DM.CODE_OP='DIS' AND DM.ID_TABLE=19 THEN DM.SUM_ACC * DM.SIGN_OP WHEN DM.CODE_OP='DIS' AND DM.ID_TABLE<>19 THEN DM.SUM_ACC ELSE 0 END),
	--SUM_DIS0 = SUM(CASE WHEN DM.VAT_RATE_SAL = 0 THEN CASE WHEN DM.CODE_OP='DIS' AND DM.ID_TABLE=19 THEN DM.SUM_ACC * DM.SIGN_OP WHEN DM.CODE_OP='DIS' AND DM.ID_TABLE<>19 THEN DM.SUM_ACC ELSE 0 END ELSE 0 END),
	--SUM_DIS10 = SUM(CASE WHEN DM.VAT_RATE_SAL = 10 THEN CASE WHEN DM.CODE_OP='DIS' AND DM.ID_TABLE=19 THEN DM.SUM_ACC * DM.SIGN_OP WHEN DM.CODE_OP='DIS' AND DM.ID_TABLE<>19 THEN DM.SUM_ACC ELSE 0 END ELSE 0 END),
	--SUM_DIS18 = SUM(CASE WHEN DM.VAT_RATE_SAL = 18 THEN CASE WHEN DM.CODE_OP='DIS' AND DM.ID_TABLE=19 THEN DM.SUM_ACC * DM.SIGN_OP WHEN DM.CODE_OP='DIS' AND DM.ID_TABLE<>19 THEN DM.SUM_ACC ELSE 0 END ELSE 0 END)
--INTO #START_RESTS
FROM DOC_MOVEMENT DM
WHERE DATE_OP < @DATE_FR
AND DM.ID_STORE IN (SELECT ID_STORE FROM #STORE)

/*SELECT 
	SUM_SUP,
	SUM_ACC = SUM_ACC + CASE WHEN @DIS = 1 THEN SUM_DIS ELSE 0 END,
	NAL = NAL + CASE WHEN @DIS = 1 THEN NAL ELSE 0 END,
	KOF,
	
	SUM_SVAT_SUP,
	SUM_SVAT_ACC = SUM_SVAT_ACC * CASE WHEN @DIS = 1 AND SUM_ACC > 0 
		THEN (SUM_ACC + CASE WHEN @DIS = 1 THEN SUM_DIS ELSE 0 END) / SUM_ACC
		ELSE 1 END,
	
	SUM_SUP0,
	SUM_SUP10,
	SUM_SUP18,
	SUM_ACC0 = SUM_ACC0 + CASE WHEN @DIS = 1 THEN SUM_DIS0 ELSE 0 END,
	SUM_ACC10 = SUM_ACC10 + CASE WHEN @DIS = 1 THEN SUM_DIS10 ELSE 0 END,
	SUM_ACC18 = SUM_ACC18 + CASE WHEN @DIS = 1 THEN SUM_DIS18 ELSE 0 END,
	
	SVAT_SUP10,
	SVAT_SUP18,
	SVAT_ACC10 = SVAT_ACC10 * CASE WHEN @DIS = 1 AND SUM_ACC10 > 0 
		THEN (SUM_ACC10 + CASE WHEN @DIS = 1 THEN SUM_DIS10 ELSE 0 END) / SUM_ACC10
		ELSE 1 END,
	SVAT_ACC18 = SVAT_ACC18 * CASE WHEN @DIS = 1 AND SUM_ACC18 > 0 
		THEN (SUM_ACC18 + CASE WHEN @DIS = 1 THEN SUM_DIS18 ELSE 0 END) / SUM_ACC18
		ELSE 1 END
FROM #START_RESTS*/

IF(@SHOW_ADD = 1) BEGIN
SELECT
	ID_DOCUMENT = R1.ID_DOCUMENT,	
	DOC_NAME = R1.DOC_NAME,
	DATE_OP = R1.DATE_OP,
	DOC_NUM = R1.DOC_NUM,
	INCOMING_NUMBER = MAX(R1.INCOMING_NUMBER),

	SUM_SUP = SUM(R1.SUM_SUP),
    SUM_ACC = SUM(R1.SUM_ACC),
	NAL = SUM(R1.NAL),
    --KOF = CASE WHEN CODE_OP = 'DIS' THEN 0 ELSE 1 END,

    SUM_SVAT_SUP = SUM(R1.SUM_SVAT_SUP),
    SUM_SVAT_ACC = SUM(R1.SUM_SVAT_ACC),

    SUM_SUP0 = SUM(R1.SUM_SUP0),
    SUM_SUP10 = SUM(R1.SUM_SUP10),
    SUM_SUP18 = SUM(R1.SUM_SUP18),
    SUM_ACC0 = SUM(R1.SUM_ACC0),
    SUM_ACC10 = SUM(R1.SUM_ACC10),
    SUM_ACC18 = SUM(R1.SUM_ACC18),

    SVAT_SUP10 = SUM(R1.SVAT_SUP10),
    SVAT_SUP18 = SUM(R1.SVAT_SUP18),
    SVAT_ACC10 = SUM(R1.SVAT_ACC10),
    SVAT_ACC18 = SUM(R1.SVAT_ACC18),
	    
    ID_CONTRACTOR_FROM = R1.ID_CONTRACTOR_FROM,
    CONTRACTOR_FROM = R1.CONTRACTOR_FROM,
    ID_TABLE = R1.ID_TABLE,
    DOC_TYPE = R1.DOC_TYPE
FROM
(
SELECT
	ID_DOCUMENT = DM.ID_DOCUMENT,
	DOC_NAME = ISNULL(TD.DESCRIPTION+': ','')+CASE WHEN DM.ID_TABLE=19 THEN '' ELSE ISNULL(C.NAME,'')+ISNULL('('+S.NAME+')','') END,
	DATE_OP = DM.DATE_OP,
	DOC_NUM = AD.DOC_NUM,
	INCOMING_NUMBER = CASE WHEN DM.ID_TABLE = 2 THEN ISNULL('π Õœ:'+ I.INCOMING_NUMBER,'') ELSE '' END,

	SUM_SUP = DM.SUM_SUP,
	SUM_ACC = DM.SUM_ACC,
	NAL = DM.SUM_ACC - DM.SUM_SUP,
	--KOF = CASE WHEN CODE_OP = 'DIS' THEN 0 ELSE 1 END,
	
	SUM_SVAT_SUP = DM.SVAT_SUP,
	SUM_SVAT_ACC = DM.SVAT_ACC,
	
	SUM_SUP0 = CASE WHEN DM.VAT_RATE = 0 THEN (DM.SUM_SUP * DM.SIGN_OP) ELSE 0 END,
	SUM_SUP10 = CASE WHEN DM.VAT_RATE = 10 THEN (DM.SUM_SUP * DM.SIGN_OP) ELSE 0 END,
	SUM_SUP18 = CASE WHEN DM.VAT_RATE = 18 THEN (DM.SUM_SUP * DM.SIGN_OP) ELSE 0 END,
	SUM_ACC0 = CASE WHEN DM.VAT_RATE = 0 THEN SUM_ACC ELSE 0 END,
	SUM_ACC10 = CASE WHEN DM.VAT_RATE =10 THEN SUM_ACC ELSE 0 END,
	SUM_ACC18 = CASE WHEN DM.VAT_RATE = 18 THEN SUM_ACC ELSE 0 END,
	
	SVAT_SUP10 = CASE WHEN DM.VAT_RATE = 10 THEN (DM.SVAT_SUP * DM.SIGN_OP) ELSE 0 END,
	SVAT_SUP18 = CASE WHEN DM.VAT_RATE = 18 THEN (DM.SVAT_SUP * DM.SIGN_OP) ELSE 0 END,
	SVAT_ACC10 = CASE WHEN DM.VAT_RATE = 10 THEN SVAT_ACC ELSE 0 END,
	SVAT_ACC18 = CASE WHEN DM.VAT_RATE = 18 THEN SVAT_ACC ELSE 0 END,
	
	ID_CONTRACTOR_FROM = ISNULL(DM.ID_CONTRACTOR_FROM, 0),
    CONTRACTOR_FROM = ISNULL(C.NAME,''),
    DM.ID_TABLE,
    DOC_TYPE = TD.DESCRIPTION

FROM DOC_MOVEMENT DM
    INNER JOIN TABLE_DATA TD ON TD.ID_TABLE_DATA = DM.ID_TABLE
    INNER JOIN ALL_DOCUMENT AD ON AD.ID_DOCUMENT_GLOBAL = DM.ID_DOCUMENT
	LEFT JOIN INVOICE I ON DM.ID_DOCUMENT = I.ID_INVOICE_GLOBAL
    LEFT JOIN CONTRACTOR C ON C.ID_CONTRACTOR = DM.ID_CONTRACTOR_FROM
    LEFT JOIN STORE S ON S.ID_STORE = DM.ID_STORE_FROM
WHERE DM.CODE_OP='ADD' AND DM.ID_TABLE <> 19
	AND DATE_OP BETWEEN @DATE_FR AND @DATE_TO
	AND (DM.ID_STORE IS NOT NULL AND DM.ID_STORE IN (SELECT ID_STORE FROM #STORE))
	AND (@NOAU = 1 OR (DM.ID_TABLE not in (8, 37, 39)) OR dm.id_store_from not in (select id_store from #store where id_contractor = dm.id_contractor_to))

) AS R1
GROUP BY R1.ID_DOCUMENT, R1.ID_TABLE, R1.DOC_TYPE, R1.DATE_OP, R1.DOC_NAME, R1.DOC_NUM, 
	R1.ID_CONTRACTOR_FROM, R1.CONTRACTOR_FROM
ORDER BY CASE WHEN @SORT_DOC = 0 THEN NULL ELSE R1.DOC_NAME END, 
	CASE WHEN @SORT_DOC = 0 THEN R1.DATE_OP ELSE NULL END, 
	R1.CONTRACTOR_FROM, R1.DATE_OP

END
ELSE BEGIN
SELECT
    ID_DOCUMENT = CAST(NULL AS UNIQUEIDENTIFIER),
    DOC_NAME = CAST(NULL AS NVARCHAR(128)),
	DATE_OP = CAST(NULL AS DATETIME),
	DOC_NUM = CAST(NULL AS NVARCHAR(128)),
	INCOMING_NUMBER = CAST(NULL AS NVARCHAR(128)),
    SUM_SUP = CAST(NULL AS MONEY),
    SUM_ACC = CAST(NULL AS MONEY),
	KOF = CAST(NULL AS BIT),
	SUM_SVAT_SUP = CAST(NULL AS MONEY),
	SUM_SVAT_ACC = CAST(NULL AS MONEY),
	SUM_SUP0 = CAST(NULL AS MONEY),
	SUM_SUP10 = CAST(NULL AS MONEY),
	SUM_SUP18 = CAST(NULL AS MONEY),
	SUM_ACC0 = CAST(NULL AS MONEY),
	SUM_ACC10 = CAST(NULL AS MONEY),
	SUM_ACC18 = CAST(NULL AS MONEY),
    SVAT_SUP10 = CAST(NULL AS MONEY),
    SVAT_SUP18 = CAST(NULL AS MONEY),
    SVAT_ACC10 = CAST(NULL AS MONEY),
    SVAT_ACC18 = CAST(NULL AS MONEY),
	    
    ID_CONTRACTOR_FROM = CAST(NULL AS BIGINT),
    CONTRACTOR_FROM = CAST(NULL AS NVARCHAR(128)),
    ID_TABLE = CAST(NULL AS BIGINT),
    DOC_TYPE = CAST(NULL AS NVARCHAR(128))
END

-- Œ¡Ÿ»… –¿—’Œƒ œŒ ƒŒ ”Ã≈Õ“¿Ã
IF(@SHOW_SUB = 1)
BEGIN

SELECT
	ID_DOCUMENT = R1.ID_DOCUMENT,
	DOC_NAME = R1.DOC_NAME,
	DATE_OP = R1.DATE_OP,
	DOC_NUM = R1.DOC_NUM,

	SUM_DIS = SUM(R1.SUM_DIS),
	SUM_DIS0 = SUM(R1.SUM_DIS0),
	SUM_DIS10 = SUM(R1.SUM_DIS10),
	SUM_DIS18 = SUM(R1.SUM_DIS18),
	
	SUM_SUP = SUM(R1.SUM_SUP),
    SUM_ACC = SUM(R1.SUM_ACC),
	NAL = SUM(R1.NAL),
    KOF = MAX(R1.KOF),

    SUM_SVAT_SUP = SUM(R1.SUM_SVAT_SUP),
    SUM_SVAT_ACC = SUM(R1.SUM_SVAT_ACC),

    SUM_SUP0 = SUM(R1.SUM_SUP0),
    SUM_SUP10 = SUM(R1.SUM_SUP10),
    SUM_SUP18 = SUM(R1.SUM_SUP18),
    SUM_ACC0 = SUM(R1.SUM_ACC0),
    SUM_ACC10 = SUM(R1.SUM_ACC10),
    SUM_ACC18 = SUM(R1.SUM_ACC18),

    SVAT_SUP10 = SUM(R1.SVAT_SUP10),
    SVAT_SUP18 = SUM(R1.SVAT_SUP18),
    SVAT_ACC10 = SUM(R1.SVAT_ACC10),
    SVAT_ACC18 = SUM(R1.SVAT_ACC18),
    
    R1.ID_CONTRACTOR_TO,
    R1.CONTRACTOR_TO,
    R1.ID_TABLE,
    R1.DOC_TYPE,
    
	EX = R1.EX
INTO #temp_t
FROM
(
SELECT 
	ID_DOCUMENT = DM.ID_DOCUMENT,
	DOC_NAME = ISNULL(TD.DESCRIPTION+': ','')+CASE WHEN DM.ID_TABLE=19 THEN '' ELSE ISNULL(C.NAME,'')+ISNULL('('+S.NAME+')','') END,
	DATE_OP = DM.DATE_OP,
	DOC_NUM = AD.DOC_NUM,
		
	SUM_DIS = CASE WHEN DM.CODE_OP='DIS' AND DM.ID_TABLE=19 THEN DM.SUM_ACC * DM.SIGN_OP WHEN DM.CODE_OP='DIS' AND DM.ID_TABLE<>19 THEN DM.SUM_ACC ELSE 0 END,
	SUM_DIS0 = CASE WHEN DM.VAT_RATE = 0 THEN CASE WHEN DM.CODE_OP='DIS' AND DM.ID_TABLE=19 THEN DM.SUM_ACC * DM.SIGN_OP WHEN DM.CODE_OP='DIS' AND DM.ID_TABLE<>19 THEN DM.SUM_ACC ELSE 0 END ELSE 0 END,
	SUM_DIS10 = CASE WHEN DM.VAT_RATE = 10 THEN CASE WHEN DM.CODE_OP='DIS' AND DM.ID_TABLE=19 THEN DM.SUM_ACC * DM.SIGN_OP WHEN DM.CODE_OP='DIS' AND DM.ID_TABLE<>19 THEN DM.SUM_ACC ELSE 0 END ELSE 0 END,
	SUM_DIS18 = CASE WHEN DM.VAT_RATE = 18 THEN CASE WHEN DM.CODE_OP='DIS' AND DM.ID_TABLE=19 THEN DM.SUM_ACC * DM.SIGN_OP WHEN DM.CODE_OP='DIS' AND DM.ID_TABLE<>19 THEN DM.SUM_ACC ELSE 0 END ELSE 0 END,
	
	SUM_SUP = CASE WHEN DM.CODE_OP='DIS' THEN 0 ELSE DM.SUM_SUP * DM.SIGN_OP * -1 END,
	SUM_ACC = CASE WHEN DM.CODE_OP='DIS' THEN 0	ELSE DM.SUM_ACC * DM.SIGN_OP * -1 END,
	NAL = CASE WHEN DM.CODE_OP='DIS' THEN 0 ELSE DM.SUM_ACC * DM.SIGN_OP * -1 END -	CASE WHEN DM.CODE_OP='DIS' THEN 0 ELSE DM.SUM_SUP * DM.SIGN_OP * -1 END,
	KOF = CASE WHEN DM.CODE_OP = 'DIS' THEN 0 ELSE 1 END,
	
	SUM_SVAT_SUP = CASE WHEN DM.CODE_OP='DIS' THEN 0 ELSE DM.SVAT_SUP * DM.SIGN_OP * -1	END,
	SUM_SVAT_ACC = CASE WHEN DM.CODE_OP='DIS' THEN 0 ELSE DM.SVAT_ACC * DM.SIGN_OP * -1 END,
	
    SUM_SUP0 = CASE WHEN DM.VAT_RATE = 0 THEN CASE WHEN DM.CODE_OP = 'ADD' THEN -1 * DM.SUM_SUP ELSE DM.SUM_SUP END ELSE 0 END,
    SUM_SUP10 = CASE WHEN DM.VAT_RATE = 10 THEN CASE WHEN DM.CODE_OP = 'ADD' THEN -1 * DM.SUM_SUP ELSE DM.SUM_SUP END ELSE 0 END,
    SUM_SUP18 = CASE WHEN DM.VAT_RATE = 18 THEN CASE WHEN DM.CODE_OP = 'ADD' THEN -1 * DM.SUM_SUP ELSE DM.SUM_SUP END ELSE 0 END,
    SUM_ACC0 = CASE WHEN DM.VAT_RATE = 0 THEN CASE WHEN DM.CODE_OP='DIS' THEN 0	ELSE DM.SUM_ACC * DM.SIGN_OP * -1 END ELSE 0 END,
    SUM_ACC10 = CASE WHEN DM.VAT_RATE = 10 THEN CASE WHEN DM.CODE_OP='DIS' THEN 0 ELSE DM.SUM_ACC * DM.SIGN_OP * -1 END ELSE 0 END,
    SUM_ACC18 = CASE WHEN DM.VAT_RATE = 18 THEN CASE WHEN DM.CODE_OP='DIS' THEN 0 ELSE DM.SUM_ACC * DM.SIGN_OP * -1	END ELSE 0 END,

    SVAT_SUP10 = CASE WHEN DM.VAT_RATE = 10 THEN CASE WHEN DM.CODE_OP = 'ADD' THEN -1 * DM.SVAT_SUP ELSE DM.SVAT_SUP END ELSE 0 END,
    SVAT_SUP18 = CASE WHEN DM.VAT_RATE = 18 THEN CASE WHEN DM.CODE_OP = 'ADD' THEN -1 * DM.SVAT_SUP ELSE DM.SVAT_SUP END ELSE 0 END,
    SVAT_ACC10 = CASE WHEN DM.VAT_RATE = 10 THEN CASE WHEN DM.CODE_OP='DIS' THEN 0 ELSE DM.SVAT_ACC * DM.SIGN_OP * -1 END ELSE 0 END,
    SVAT_ACC18 = CASE WHEN DM.VAT_RATE = 18 THEN CASE WHEN DM.CODE_OP='DIS' THEN 0 ELSE DM.SVAT_ACC * DM.SIGN_OP * -1 END ELSE 0 END,
    
    ID_CONTRACTOR_TO = CASE WHEN DM.ID_TABLE=19 THEN NULL ELSE ISNULL(DM.ID_CONTRACTOR_TO, 0) END,
    CONTRACTOR_TO = CASE WHEN DM.ID_TABLE=19 THEN NULL ELSE ISNULL(C.NAME,'') END,
    ID_TABLE = DM.ID_TABLE,
    DOC_TYPE = TD.DESCRIPTION,
    
	EX = 0
FROM DOC_MOVEMENT DM
    INNER JOIN TABLE_DATA TD ON TD.ID_TABLE_DATA = DM.ID_TABLE
    INNER JOIN ALL_DOCUMENT AD ON AD.ID_DOCUMENT_GLOBAL = DM.ID_DOCUMENT
    LEFT JOIN CONTRACTOR C ON C.ID_CONTRACTOR = DM.ID_CONTRACTOR_TO
    LEFT JOIN STORE S ON S.ID_STORE = DM.ID_STORE_TO
WHERE (CODE_OP IN ('SUB', 'DIS') OR (CODE_OP = 'ADD' AND dm.ID_TABLE = 19))
		AND DATE_OP BETWEEN @DATE_FR AND @DATE_TO
		AND (DM.ID_STORE IS NOT NULL AND DM.ID_STORE IN (SELECT ID_STORE FROM #STORE))
		AND (@NOAU = 1 OR (DM.ID_TABLE not in (8, 37, 39)) OR dm.id_store_to not in (select id_store from #store where id_contractor = dm.id_contractor_from))

UNION ALL

SELECT
	ID_DOCUMENT = CS.ID_CASH_SESSION_GLOBAL,
	DOC_NAME = '”ÒÎÛ„‡',
	DATE_OP = CS.DATE_CLOSE,
	DOC_NUM = CS.MNEMOCODE,
	
	SUM_DIS = CH_I.SUMM_DISCOUNT * CASE WHEN CH.CHEQUE_TYPE = 'SALE' THEN 1 ELSE -1 END,
	SUM_DIS0 = CH_I.SUMM_DISCOUNT * CASE WHEN TT.TAX_RATE = 0 THEN CASE WHEN CH.CHEQUE_TYPE = 'SALE' THEN 1 ELSE -1 END ELSE 0 END,
	SUM_DIS10 = CH_I.SUMM_DISCOUNT * CASE WHEN TT.TAX_RATE = 10 THEN CASE WHEN CH.CHEQUE_TYPE = 'SALE' THEN 1 ELSE -1 END ELSE 0 END,
	SUM_DIS18 = CH_I.SUMM_DISCOUNT * CASE WHEN TT.TAX_RATE = 18 THEN CASE WHEN CH.CHEQUE_TYPE = 'SALE' THEN 1 ELSE -1 END ELSE 0 END,
	
	SUM_SUP = 0,
	SUM_ACC = CASE WHEN CH.CHEQUE_TYPE = 'SALE' THEN 1 ELSE -1 END * S4S.PRICE_SAL * S4S.QUANTITY * CH_I.QUANTITY,
	NAL = CASE WHEN CH.CHEQUE_TYPE = 'SALE' THEN 1 ELSE -1 END * S4S.PRICE_SAL * S4S.QUANTITY * CH_I.QUANTITY,
	KOF = 1,

	SUM_SVAT_SUP = 0,
	SUM_SVAT_ACC = CASE WHEN CH.CHEQUE_TYPE = 'SALE' THEN 1 ELSE -1 END * (S4S.PRICE_SAL * TT.TAX_RATE / (100+TT.TAX_RATE)) * S4S.QUANTITY * CH_I.QUANTITY,

	SUM_SUP0 = 0,
	SUM_SUP10 = 0,
	SUM_SUP18 = 0,
	SUM_ACC0 = CASE WHEN TT.TAX_RATE = 0 THEN CASE WHEN CH.CHEQUE_TYPE = 'SALE' THEN 1 ELSE -1 END * S4S.PRICE_SAL * S4S.QUANTITY * CH_I.QUANTITY ELSE 0 END,
	SUM_ACC10 = CASE WHEN TT.TAX_RATE = 10 THEN CASE WHEN CH.CHEQUE_TYPE = 'SALE' THEN 1 ELSE -1 END * S4S.PRICE_SAL * S4S.QUANTITY * CH_I.QUANTITY ELSE 0 END,
	SUM_ACC18 = CASE WHEN TT.TAX_RATE = 18 THEN CASE WHEN CH.CHEQUE_TYPE = 'SALE' THEN 1 ELSE -1 END * S4S.PRICE_SAL * S4S.QUANTITY * CH_I.QUANTITY ELSE 0 END,

    SVAT_SUP10 = 0,
    SVAT_SUP18 = 0,
    SVAT_ACC10 = CASE WHEN TT.TAX_RATE = 10 THEN CASE WHEN CH.CHEQUE_TYPE = 'SALE' THEN 1 ELSE -1 END * (S4S.PRICE_SAL * TT.TAX_RATE / (100+TT.TAX_RATE)) * S4S.QUANTITY * CH_I.QUANTITY ELSE 0 END,
    SVAT_ACC18 = CASE WHEN TT.TAX_RATE = 18 THEN CASE WHEN CH.CHEQUE_TYPE = 'SALE' THEN 1 ELSE -1 END * (S4S.PRICE_SAL * TT.TAX_RATE / (100+TT.TAX_RATE)) * S4S.QUANTITY * CH_I.QUANTITY ELSE 0 END,
    
    ID_CONTRACTOR_TO = 999999,
    CONTRACTOR_TO = ' ‡ÒÒÓ‚‡ˇ ÒÏÂÌ‡',
    ID_TABLE = 99,
    DOC_TYPE = '”ÒÎÛ„‡',
    
	EX = 1
FROM CHEQUE_ITEM CH_I
	INNER JOIN CHEQUE CH ON CH.ID_CHEQUE_GLOBAL = CH_I.ID_CHEQUE_GLOBAL
	INNER JOIN CASH_SESSION CS ON CS.ID_CASH_SESSION_GLOBAL = CH.ID_CASH_SESSION_GLOBAL
	INNER JOIN SERVICE_4_SALE_ITEM S4S ON S4S.ID_SERVICE_4_SALE = CH_I.ID_LOT_GLOBAL
	INNER JOIN SERVICE S ON S.ID_SERVICE = S4S.ID_SERVICE
	INNER JOIN TAX_TYPE TT ON TT.ID_TAX_TYPE = S.ID_TAX_TYPE
WHERE CH.CHEQUE_TYPE IN ('SALE', 'RETURN') AND CS.DATE_CLOSE BETWEEN @DATE_FR AND @DATE_TO
) AS R1
GROUP BY R1.ID_DOCUMENT, R1.ID_TABLE, R1.DOC_TYPE, R1.DATE_OP, R1.DOC_NAME, R1.DOC_NUM, R1.ID_CONTRACTOR_TO,
	R1.CONTRACTOR_TO, R1.EX
ORDER BY CASE WHEN @SORT_DOC = 0 THEN NULL ELSE R1.DOC_NAME END, 
	CASE WHEN @SORT_DOC = 0 THEN R1.DATE_OP ELSE NULL END, 
	R1.CONTRACTOR_TO, R1.DATE_OP

--SELECT * FROM #temp_t
/*SELECT * FROM 
(*/
SELECT
	T.ID_DOCUMENT,
	T.DOC_NAME,
	T.DATE_OP,
	T.DOC_NUM,
	T.SUM_DIS,
	T.SUM_DIS0,
	T.SUM_DIS10,
	T.SUM_DIS18,
	T.SUM_SUP,
	SUM_ACC = T.SUM_ACC + CASE WHEN @DIS = 1 THEN T.SUM_DIS ELSE 0 END,
	NAL = T.NAL + CASE WHEN @DIS = 1 THEN T.SUM_DIS ELSE 0 END,
	T.KOF,
	T.SUM_SVAT_SUP,
	SUM_SVAT_ACC = T.SUM_SVAT_ACC * CASE WHEN @DIS = 1 AND T.SUM_ACC > 0 
		THEN (T.SUM_ACC + CASE WHEN @DIS = 1 THEN T.SUM_DIS ELSE 0 END) / T.SUM_ACC
		ELSE 1 END,
	T.SUM_SUP0,
	T.SUM_SUP10,
	T.SUM_SUP18,
	SUM_ACC0 = T.SUM_ACC0 + CASE WHEN @DIS = 1 THEN T.SUM_DIS0 ELSE 0 END,
	SUM_ACC10 = T.SUM_ACC10 + CASE WHEN @DIS = 1 THEN T.SUM_DIS10 ELSE 0 END,
	SUM_ACC18 = T.SUM_ACC18 + CASE WHEN @DIS = 1 THEN T.SUM_DIS18 ELSE 0 END,
	T.SVAT_SUP10,
	T.SVAT_SUP18,
	SVAT_ACC10 = T.SVAT_ACC10 * CASE WHEN @DIS = 1 AND T.SUM_ACC10 > 0 
		THEN (T.SUM_ACC10 + CASE WHEN @DIS = 1 THEN T.SUM_DIS10 ELSE 0 END) / T.SUM_ACC10
		ELSE 1 END,
	SVAT_ACC18 = T.SVAT_ACC18 * CASE WHEN @DIS = 1 AND T.SUM_ACC18 > 0 
		THEN (T.SUM_ACC18 + CASE WHEN @DIS = 1 THEN T.SUM_DIS18 ELSE 0 END) / T.SUM_ACC18
		ELSE 1 END,
	T.ID_CONTRACTOR_TO,
	T.CONTRACTOR_TO,
	T.ID_TABLE,
	T.DOC_TYPE,
	T.EX
FROM #temp_t T
--WHERE T.EX = 0
--UNION ALL
--SELECT 
--	T.ID_DOCUMENT,
--	T.DOC_NAME,
--	T.DATE_OP,
--	T.DOC_NUM,
--	T.SUM_DIS,
--	T.SUM_DIS0,
--	T.SUM_DIS10,
--	T.SUM_DIS18,
--	T.SUM_SUP,
--	T.SUM_ACC,
--	T.NAL,
--	T.KOF,
--	T.SUM_SVAT_SUP,
--	T.SUM_SVAT_ACC,
--	T.SUM_SUP0,
--	T.SUM_SUP10,
--	T.SUM_SUP18,
--	T.SUM_ACC0,
--	T.SUM_ACC10,
--	T.SUM_ACC18,
--	T.SVAT_SUP10,
--	T.SVAT_SUP18,
--	T.SVAT_ACC10,
--	T.SVAT_ACC18,
--	T.EX
--FROM #temp_t T
--WHERE T.EX = 1
--) A

SELECT 
	SUM_DIS = SUM(SUM_DIS),
	SUM_DIS0 = SUM(SUM_DIS0),
	SUM_DIS10 = SUM(SUM_DIS10),
	SUM_DIS18 = SUM(SUM_DIS18)
FROM #temp_t

END
ELSE BEGIN
SELECT
    ID_DOCUMENT = CAST(NULL AS UNIQUEIDENTIFIER),
    DOC_NAME = CAST(NULL AS NVARCHAR(128)),
	DATE_OP = CAST(NULL AS DATETIME),
	DOC_NUM = CAST(NULL AS NVARCHAR(128)),
	SUM_DIS = CAST(NULL AS MONEY),
    SUM_SUP = CAST(NULL AS MONEY),
    SUM_ACC = CAST(NULL AS MONEY),
	KOF = CAST(NULL AS BIT),
	SUM_SVAT_SUP = CAST(NULL AS MONEY),
	SUM_SVAT_ACC = CAST(NULL AS MONEY),
	SUM_SUP0 = CAST(NULL AS MONEY),
	SUM_SUP10 = CAST(NULL AS MONEY),
	SUM_SUP18 = CAST(NULL AS MONEY),
	SUM_ACC0 = CAST(NULL AS MONEY),
	SUM_ACC10 = CAST(NULL AS MONEY),
	SUM_ACC18 = CAST(NULL AS MONEY),
    SVAT_SUP10 = CAST(NULL AS MONEY),
    SVAT_SUP18 = CAST(NULL AS MONEY),
    SVAT_ACC10 = CAST(NULL AS MONEY),
    SVAT_ACC18 = CAST(NULL AS MONEY),
    ID_CONTRACTOR_TO = CAST(NULL AS BIGINT),
	CONTRACTOR_TO = CAST(NULL AS NVARCHAR(128)),
	ID_TABLE = CAST(NULL AS BIGINT),
	DOC_TYPE = CAST(NULL AS NVARCHAR(128))
    
SELECT 
	SUM_DIS = NULL,
	SUM_DIS0 = NULL,
	SUM_DIS10 = NULL,
	SUM_DIS18 = NULL
END

DECLARE @STORES VARCHAR(1024)
DECLARE @CONTRACTORS VARCHAR(1024)

EXEC DBO.USP_TABLE_NAMES '#STORE', @STORES OUT
EXEC DBO.USP_TABLE_NAMES '#CONTRACTOR', @CONTRACTORS OUT
SELECT CONTRACTOR = @CONTRACTORS, STORE = @STORES

-- Œ—“¿“Œ  Õ¿  ŒÕ≈÷
SELECT
    SUM_SUP = SUM(DM.SUM_SUP * DM.SIGN_OP),
    SUM_ACC = SUM(CASE WHEN ID_TABLE=19 AND CODE_OP='DIS' THEN -1 ELSE 1 END * DM.SUM_ACC * DM.SIGN_OP),
	NAL = SUM(CASE WHEN ID_TABLE=19 AND CODE_OP='DIS' THEN -1 ELSE 1 END * DM.SUM_ACC * DM.SIGN_OP - DM.SUM_SUP * DM.SIGN_OP),
    KOF = CASE WHEN MAX(CODE_OP) = 'DIS' THEN 0 ELSE 1 END,

    SUM_SVAT_SUP = SUM(DM.SVAT_SUP * DM.SIGN_OP),
    SUM_SVAT_ACC = SUM(CASE WHEN DM.ID_TABLE=19 AND CODE_OP='DIS' THEN -1 ELSE 1 END * DM.SVAT_ACC * DM.SIGN_OP),

    SUM_SUP0 = SUM(CASE WHEN DM.VAT_RATE = 0 THEN (DM.SUM_SUP * DM.SIGN_OP) ELSE 0 END),
    SUM_SUP10 = SUM(CASE WHEN DM.VAT_RATE = 10 THEN (DM.SUM_SUP * DM.SIGN_OP) ELSE 0 END),
    SUM_SUP18 = SUM(CASE WHEN DM.VAT_RATE = 18 THEN (DM.SUM_SUP * DM.SIGN_OP) ELSE 0 END),
    SUM_ACC0 = SUM(CASE WHEN DM.VAT_RATE = 0 THEN CASE WHEN DM.ID_TABLE=19 AND CODE_OP='DIS' THEN -1 ELSE 1 END * SUM_ACC * DM.SIGN_OP ELSE 0 END),
    SUM_ACC10 = SUM(CASE WHEN DM.VAT_RATE = 10 THEN CASE WHEN DM.ID_TABLE=19 AND CODE_OP='DIS' THEN -1 ELSE 1 END * SUM_ACC * DM.SIGN_OP ELSE 0 END),
    SUM_ACC18 = SUM(CASE WHEN DM.VAT_RATE = 18 THEN CASE WHEN DM.ID_TABLE=19 AND CODE_OP='DIS' THEN -1 ELSE 1 END * SUM_ACC * DM.SIGN_OP ELSE 0 END),

    SVAT_SUP10 = SUM(CASE WHEN DM.VAT_RATE = 10 THEN (DM.SVAT_SUP * DM.SIGN_OP) ELSE 0 END),
    SVAT_SUP18 = SUM(CASE WHEN DM.VAT_RATE = 18 THEN (DM.SVAT_SUP * DM.SIGN_OP) ELSE 0 END),
    SVAT_ACC10 = SUM(CASE WHEN DM.VAT_RATE = 10 THEN CASE WHEN DM.ID_TABLE=19 AND CODE_OP='DIS' THEN -1 ELSE 1 END * SVAT_ACC * DM.SIGN_OP ELSE 0 END),
    SVAT_ACC18 = SUM(CASE WHEN DM.VAT_RATE = 18 THEN CASE WHEN DM.ID_TABLE=19 AND CODE_OP='DIS' THEN -1 ELSE 1 END * SVAT_ACC * DM.SIGN_OP ELSE 0 END)
    --,
    
    --SUM_DIS = SUM(CASE WHEN DM.CODE_OP='DIS' AND DM.ID_TABLE=19 THEN DM.SUM_ACC * DM.SIGN_OP WHEN DM.CODE_OP='DIS' AND DM.ID_TABLE<>19 THEN DM.SUM_ACC ELSE 0 END),
	--SUM_DIS0 = SUM(CASE WHEN DM.VAT_RATE_SAL = 0 THEN CASE WHEN DM.CODE_OP='DIS' AND DM.ID_TABLE=19 THEN DM.SUM_ACC * DM.SIGN_OP WHEN DM.CODE_OP='DIS' AND DM.ID_TABLE<>19 THEN DM.SUM_ACC ELSE 0 END ELSE 0 END),
	--SUM_DIS10 = SUM(CASE WHEN DM.VAT_RATE_SAL = 10 THEN CASE WHEN DM.CODE_OP='DIS' AND DM.ID_TABLE=19 THEN DM.SUM_ACC * DM.SIGN_OP WHEN DM.CODE_OP='DIS' AND DM.ID_TABLE<>19 THEN DM.SUM_ACC ELSE 0 END ELSE 0 END),
	--SUM_DIS18 = SUM(CASE WHEN DM.VAT_RATE_SAL = 18 THEN CASE WHEN DM.CODE_OP='DIS' AND DM.ID_TABLE=19 THEN DM.SUM_ACC * DM.SIGN_OP WHEN DM.CODE_OP='DIS' AND DM.ID_TABLE<>19 THEN DM.SUM_ACC ELSE 0 END ELSE 0 END)
--INTO #RESTS
FROM DOC_MOVEMENT DM
WHERE DATE_OP <= @DATE_TO
AND DM.ID_STORE IN (SELECT ID_STORE FROM #STORE)

/*SELECT 
	SUM_SUP,
	SUM_ACC = SUM_ACC + CASE WHEN @DIS = 1 THEN SUM_DIS ELSE 0 END,
	NAL = NAL + CASE WHEN @DIS = 1 THEN NAL ELSE 0 END,
	KOF,
	
	SUM_SVAT_SUP,
	SUM_SVAT_ACC = SUM_SVAT_ACC * CASE WHEN @DIS = 1 AND SUM_ACC > 0 
		THEN (SUM_ACC + CASE WHEN @DIS = 1 THEN SUM_DIS ELSE 0 END) / SUM_ACC
		ELSE 1 END,
	
	SUM_SUP0,
	SUM_SUP10,
	SUM_SUP18,
	SUM_ACC0 = SUM_ACC0 + CASE WHEN @DIS = 1 THEN SUM_DIS0 ELSE 0 END,
	SUM_ACC10 = SUM_ACC10 + CASE WHEN @DIS = 1 THEN SUM_DIS10 ELSE 0 END,
	SUM_ACC18 = SUM_ACC18 + CASE WHEN @DIS = 1 THEN SUM_DIS18 ELSE 0 END,
	
	SVAT_SUP10,
	SVAT_SUP18,
	SVAT_ACC10 = SVAT_ACC10 * CASE WHEN @DIS = 1 AND SUM_ACC10 > 0 
		THEN (SUM_ACC10 + CASE WHEN @DIS = 1 THEN SUM_DIS10 ELSE 0 END) / SUM_ACC10
		ELSE 1 END,
	SVAT_ACC18 = SVAT_ACC18 * CASE WHEN @DIS = 1 AND SUM_ACC18 > 0 
		THEN (SUM_ACC18 + CASE WHEN @DIS = 1 THEN SUM_DIS18 ELSE 0 END) / SUM_ACC18
		ELSE 1 END
FROM #RESTS*/

IF(@SHOW_SUB = 1)
BEGIN
SELECT
	SUM_ACC = SUM(SUM_ACC + CASE WHEN @DIS = 1 THEN SUM_DIS ELSE 0 END),
	SUM_ACC0 = SUM(SUM_ACC0 + CASE WHEN @DIS = 1 THEN SUM_DIS0 ELSE 0 END),
	SUM_ACC10 = SUM(SUM_ACC10 + CASE WHEN @DIS = 1 THEN SUM_DIS10 ELSE 0 END),
	SUM_ACC18 = SUM(SUM_ACC18 + CASE WHEN @DIS = 1 THEN SUM_DIS18 ELSE 0 END),
	SUM_VAT = SUM(SUM_SVAT_ACC * CASE WHEN @DIS = 1 AND SUM_ACC > 0 
		THEN (SUM_ACC + CASE WHEN @DIS = 1 THEN SUM_DIS ELSE 0 END) / SUM_ACC
		ELSE 1 END),
	SVAT_ACC10 = SUM(SVAT_ACC10 * CASE WHEN @DIS = 1 AND SUM_ACC10 > 0 
		THEN (SUM_ACC10 + CASE WHEN @DIS = 1 THEN SUM_DIS10 ELSE 0 END) / SUM_ACC10
		ELSE 1 END),
	SVAT_ACC18 = SUM(SVAT_ACC18 * CASE WHEN @DIS = 1 AND SUM_ACC18 > 0 
		THEN (SUM_ACC18 + CASE WHEN @DIS = 1 THEN SUM_DIS18 ELSE 0 END) / SUM_ACC18
		ELSE 1 END)
FROM #temp_t where EX = 1
END ELSE
BEGIN
SELECT
	SUM_ACC = NULL,
	SUM_ACC0 = NULL,
	SUM_ACC10 = NULL,
	SUM_ACC18 = NULL,
	SUM_VAT = NULL,
	SVAT_ACC10 = NULL,
	SVAT_ACC18 = NULL
END

RETURN 0
GO

/*
exec REP_GOODS_REPORTS_TO_EX_SERVICE N'
<XML>
	<DATE_FR>2009-01-01T00:00:00.000</DATE_FR>
	<DATE_TO>2009-12-10T00:00:00.000</DATE_TO>
	<SHOW_ADD>1</SHOW_ADD>
	<SHOW_SUB>1</SHOW_SUB>
	<SORT_DOC>1</SORT_DOC>
	<ID_CONTRACTOR>5271</ID_CONTRACTOR>
	<NOAU>0</NOAU>
</XML>'*/

SET NOCOUNT ON
SET QUOTED_IDENTIFIER OFF
GO

IF (OBJECT_ID('DBO.REP_GOODS_REPORTS_TO_EX_SAL') IS NULL ) EXEC ('CREATE PROCEDURE DBO.REP_GOODS_REPORTS_TO_EX_SAL AS SELECT NULL')
GO
ALTER PROCEDURE DBO.REP_GOODS_REPORTS_TO_EX_SAL
         @XMLPARAM NTEXT
AS

DECLARE @DATE_FR DATETIME, @DATE_TO DATETIME
DECLARE @SORT_DOC BIT, @SHOW_ADD BIT, @SHOW_SUB BIT, @REFRESH_DOC_MOV BIT
DECLARE @HDOC INT, @SQL NVARCHAR(4000), @SQL_FIELDS NVARCHAR(4000)
DECLARE @NOAU BIT, @DIS BIT, @CO BIT

EXEC SP_XML_PREPAREDOCUMENT @HDOC OUTPUT, @XMLPARAM OUTPUT
SELECT TOP 1 
    @DATE_FR = DATE_FR, @DATE_TO = DATE_TO,
    @SORT_DOC = SORT_DOC,
    @SHOW_ADD = SHOW_ADD, @SHOW_SUB = SHOW_SUB,
    @REFRESH_DOC_MOV = REFRESH_DOC_MOV,
	@NOAU = NOAU, @DIS = DIS, @CO = CO
FROM OPENXML(@HDOC, '/XML') WITH(
    DATE_FR DATETIME 'DATE_FR', 
    DATE_TO DATETIME 'DATE_TO', 
    SORT_DOC BIT 'SORT_DOC', 
    SHOW_ADD BIT 'SHOW_ADD', 
    SHOW_SUB BIT 'SHOW_SUB',
    REFRESH_DOC_MOV BIT 'REFRESH_DOC_MOV',
	NOAU BIT 'NOAU',
	DIS BIT 'DIS',
	CO BIT 'CO')

/* “¿¡À»÷¿ »ƒ≈Õ“»‘» ¿“Œ–Œ¬  ŒÕ“–¿√≈Õ“Œ¬ */
SELECT DISTINCT C.ID_CONTRACTOR, C.NAME INTO #CONTRACTOR
FROM 
    (SELECT * FROM OPENXML(@HDOC, '//ID_CONTRACTOR') 
    WITH(ID_CONTRACTOR BIGINT '.')) TAB
INNER JOIN CONTRACTOR C ON C.ID_CONTRACTOR = TAB.ID_CONTRACTOR
WHERE ((@CO <> 1 OR @CO IS NULL) 
		AND C.ID_CONTRACTOR = (SELECT TOP 1 ID_CONTRACTOR FROM ENTERPRISE_BRANCH WHERE IS_SELF = 1))
		OR (@CO = 1)

/* “¿¡À»÷¿ »ƒ≈Õ“»‘» ¿“Œ–Œ¬ — À¿ƒŒ¬ */
SELECT DISTINCT S.ID_STORE, S.ID_CONTRACTOR, S.NAME INTO #STORE
FROM
	(SELECT * FROM OPENXML(@HDOC, '//ID_STORE') 
    WITH(ID_STORE BIGINT '.')) TAB
INNER JOIN STORE S ON S.ID_STORE = TAB.ID_STORE
WHERE ((@CO <> 1 OR @CO IS NULL) 
		AND S.ID_CONTRACTOR = (SELECT TOP 1 ID_CONTRACTOR FROM ENTERPRISE_BRANCH WHERE IS_SELF = 1))
		OR (@CO = 1)
		
EXEC SP_XML_REMOVEDOCUMENT @HDOC


IF @REFRESH_DOC_MOV = 1 BEGIN
    -- ÔÂÂÒ˜ËÚ‡Ú¸ DOC_MOVEMENT ÔÓ ‚ÒÂÏ ‰ÓÍÛÏÂÌÚ‡Ï
    EXEC UTL_REFRESH_DOC_MOVEMENT 'REPAIR', 0
END

-- ÓÚÌÓÏËÓ‚‡Ú¸ ‰‡Ú˚
EXEC USP_RANGE_DAYS @DATE_FR OUT, @DATE_TO OUT
EXEC USP_RANGE_NORM @DATE_FR OUT, @DATE_TO OUT

-- ≈—À» Õ≈ ” ¿«¿Õ — À¿ƒ, “Œ »“Œ√» ¬€¡»–¿ﬁ“—ﬂ œŒ ¬—≈Ã — À¿ƒ¿Ã
IF NOT EXISTS(SELECT TOP 1 1 FROM #STORE) BEGIN
    INSERT INTO #STORE (ID_STORE, ID_CONTRACTOR, NAME)
    SELECT S.ID_STORE, S.ID_CONTRACTOR, S.NAME
    FROM STORE S(NOLOCK) INNER JOIN #CONTRACTOR C ON C.ID_CONTRACTOR = S.ID_CONTRACTOR
END
DELETE FROM #STORE WHERE ID_CONTRACTOR NOT IN (SELECT ID_CONTRACTOR FROM #CONTRACTOR)

-- Œ—“¿“Œ  Õ¿ Õ¿◊¿ÀŒ
SELECT
    SUM_SUP = SUM(DM.SUM_SUP * DM.SIGN_OP),
    SUM_ACC = SUM(CASE WHEN DM.ID_TABLE=19 AND CODE_OP='DIS' THEN -1 ELSE 1 END * DM.SUM_ACC * DM.SIGN_OP),
	NAL = SUM(CASE WHEN DM.ID_TABLE=19 AND CODE_OP='DIS' THEN -1 ELSE 1 END * DM.SUM_ACC * DM.SIGN_OP - DM.SUM_SUP * DM.SIGN_OP),
    KOF = CASE WHEN MAX(CODE_OP) = 'DIS' THEN 0 ELSE 1 END,

    SUM_SVAT_SUP = SUM(DM.SVAT_SUP * DM.SIGN_OP),
    SUM_SVAT_ACC = SUM(CASE WHEN DM.ID_TABLE=19 AND CODE_OP='DIS' THEN -1 ELSE 1 END * DM.SVAT_ACC * DM.SIGN_OP),

    SUM_SUP0 = SUM(CASE WHEN DM.VAT_RATE_SAL = 0 THEN (DM.SUM_SUP * DM.SIGN_OP) ELSE 0 END),
    SUM_SUP10 = SUM(CASE WHEN DM.VAT_RATE_SAL = 10 THEN (DM.SUM_SUP * DM.SIGN_OP) ELSE 0 END),
    SUM_SUP18 = SUM(CASE WHEN DM.VAT_RATE_SAL = 18 THEN (DM.SUM_SUP * DM.SIGN_OP) ELSE 0 END),
    SUM_ACC0 = SUM(CASE WHEN DM.VAT_RATE_SAL = 0 THEN CASE WHEN DM.ID_TABLE=19 AND CODE_OP='DIS' THEN -1 ELSE 1 END * SUM_ACC * DM.SIGN_OP ELSE 0 END),
    SUM_ACC10 = SUM(CASE WHEN DM.VAT_RATE_SAL = 10 THEN CASE WHEN DM.ID_TABLE=19 AND CODE_OP='DIS' THEN -1 ELSE 1 END * SUM_ACC * DM.SIGN_OP ELSE 0 END),
    SUM_ACC18 = SUM(CASE WHEN DM.VAT_RATE_SAL = 18 THEN CASE WHEN DM.ID_TABLE=19 AND CODE_OP='DIS' THEN -1 ELSE 1 END * SUM_ACC * DM.SIGN_OP ELSE 0 END),

    SVAT_SUP10 = SUM(CASE WHEN DM.VAT_RATE_SAL = 10 THEN (DM.SVAT_SUP * DM.SIGN_OP) ELSE 0 END),
    SVAT_SUP18 = SUM(CASE WHEN DM.VAT_RATE_SAL = 18 THEN (DM.SVAT_SUP * DM.SIGN_OP) ELSE 0 END),
    SVAT_ACC10 = SUM(CASE WHEN DM.VAT_RATE_SAL = 10 THEN CASE WHEN DM.ID_TABLE=19 AND CODE_OP='DIS' THEN -1 ELSE 1 END * SVAT_ACC * DM.SIGN_OP ELSE 0 END),
    SVAT_ACC18 = SUM(CASE WHEN DM.VAT_RATE_SAL = 18 THEN CASE WHEN DM.ID_TABLE=19 AND CODE_OP='DIS' THEN -1 ELSE 1 END * SVAT_ACC * DM.SIGN_OP ELSE 0 END)
    --,
    
    --SUM_DIS = SUM(CASE WHEN DM.CODE_OP='DIS' AND DM.ID_TABLE=19 THEN DM.SUM_ACC * DM.SIGN_OP WHEN DM.CODE_OP='DIS' AND DM.ID_TABLE<>19 THEN DM.SUM_ACC ELSE 0 END),
	--SUM_DIS0 = SUM(CASE WHEN DM.VAT_RATE_SAL = 0 THEN CASE WHEN DM.CODE_OP='DIS' AND DM.ID_TABLE=19 THEN DM.SUM_ACC * DM.SIGN_OP WHEN DM.CODE_OP='DIS' AND DM.ID_TABLE<>19 THEN DM.SUM_ACC ELSE 0 END ELSE 0 END),
	--SUM_DIS10 = SUM(CASE WHEN DM.VAT_RATE_SAL = 10 THEN CASE WHEN DM.CODE_OP='DIS' AND DM.ID_TABLE=19 THEN DM.SUM_ACC * DM.SIGN_OP WHEN DM.CODE_OP='DIS' AND DM.ID_TABLE<>19 THEN DM.SUM_ACC ELSE 0 END ELSE 0 END),
	--SUM_DIS18 = SUM(CASE WHEN DM.VAT_RATE_SAL = 18 THEN CASE WHEN DM.CODE_OP='DIS' AND DM.ID_TABLE=19 THEN DM.SUM_ACC * DM.SIGN_OP WHEN DM.CODE_OP='DIS' AND DM.ID_TABLE<>19 THEN DM.SUM_ACC ELSE 0 END ELSE 0 END)
--INTO #START_RESTS
FROM DOC_MOVEMENT DM
	WHERE DATE_OP < @DATE_FR
		AND DM.ID_STORE IN (SELECT ID_STORE FROM #STORE)

/*SELECT 
	SUM_SUP,
	SUM_ACC = SUM_ACC + CASE WHEN @DIS = 1 THEN SUM_DIS ELSE 0 END,
	NAL = NAL + CASE WHEN @DIS = 1 THEN NAL ELSE 0 END,
	KOF,
	
	SUM_SVAT_SUP,
	SUM_SVAT_ACC = SUM_SVAT_ACC * CASE WHEN @DIS = 1 AND SUM_ACC > 0 
		THEN (SUM_ACC + CASE WHEN @DIS = 1 THEN SUM_DIS ELSE 0 END) / SUM_ACC
		ELSE 1 END,
	
	SUM_SUP0,
	SUM_SUP10,
	SUM_SUP18,
	SUM_ACC0 = SUM_ACC0 + CASE WHEN @DIS = 1 THEN SUM_DIS0 ELSE 0 END,
	SUM_ACC10 = SUM_ACC10 + CASE WHEN @DIS = 1 THEN SUM_DIS10 ELSE 0 END,
	SUM_ACC18 = SUM_ACC18 + CASE WHEN @DIS = 1 THEN SUM_DIS18 ELSE 0 END,
	
	SVAT_SUP10,
	SVAT_SUP18,
	SVAT_ACC10 = SVAT_ACC10 * CASE WHEN @DIS = 1 AND SUM_ACC10 > 0 
		THEN (SUM_ACC10 + CASE WHEN @DIS = 1 THEN SUM_DIS10 ELSE 0 END) / SUM_ACC10
		ELSE 1 END,
	SVAT_ACC18 = SVAT_ACC18 * CASE WHEN @DIS = 1 AND SUM_ACC18 > 0 
		THEN (SUM_ACC18 + CASE WHEN @DIS = 1 THEN SUM_DIS18 ELSE 0 END) / SUM_ACC18
		ELSE 1 END
FROM #START_RESTS*/

IF(@SHOW_ADD = 1) BEGIN
-- Œ¡Ÿ»… œ–»’Œƒ œŒ ƒŒ ”Ã≈Õ“¿Ã
SELECT
    ID_DOCUMENT = DM.ID_DOCUMENT,
    DOC_NAME = ISNULL(TD.DESCRIPTION+': ','')+ISNULL(C.NAME,'')+ISNULL('('+S.NAME+')',''),
    DATE_OP = DM.DATE_OP, 
    DOC_NUM = AD.DOC_NUM,
	INCOMING_NUMBER = CASE WHEN DM.ID_TABLE = 2 THEN ISNULL('π Õœ:'+ I.INCOMING_NUMBER,'') ELSE '' END,

    SUM_SUP = SUM(DM.SUM_SUP),
    SUM_ACC = SUM(DM.SUM_ACC),
	NAL = SUM(DM.SUM_ACC - DM.SUM_SUP),
    KOF = CASE WHEN MAX(CODE_OP) = 'DIS' THEN 0 ELSE 1 END,

    SUM_SVAT_SUP = SUM(DM.SVAT_SUP),
    SUM_SVAT_ACC = SUM(DM.SVAT_ACC),

    SUM_SUP0 = SUM(CASE WHEN DM.VAT_RATE_SAL = 0 THEN (DM.SUM_SUP * DM.SIGN_OP) ELSE 0 END),
    SUM_SUP10 = SUM(CASE WHEN DM.VAT_RATE_SAL = 10 THEN (DM.SUM_SUP * DM.SIGN_OP) ELSE 0 END),
    SUM_SUP18 = SUM(CASE WHEN DM.VAT_RATE_SAL = 18 THEN (DM.SUM_SUP * DM.SIGN_OP) ELSE 0 END),

    SUM_ACC0 = SUM(CASE WHEN DM.VAT_RATE_SAL = 0 THEN SUM_ACC ELSE 0 END),
    SUM_ACC10 = SUM(CASE WHEN DM.VAT_RATE_SAL =10 THEN SUM_ACC ELSE 0 END),
    SUM_ACC18 = SUM(CASE WHEN DM.VAT_RATE_SAL = 18 THEN SUM_ACC ELSE 0 END),

    SVAT_SUP10 = SUM(CASE WHEN DM.VAT_RATE_SAL = 10 THEN (DM.SVAT_SUP * DM.SIGN_OP) ELSE 0 END),
    SVAT_SUP18 = SUM(CASE WHEN DM.VAT_RATE_SAL = 18 THEN (DM.SVAT_SUP * DM.SIGN_OP) ELSE 0 END),
    SVAT_ACC10 = SUM(CASE WHEN DM.VAT_RATE_SAL = 10 THEN SVAT_ACC ELSE 0 END),
    SVAT_ACC18 = SUM(CASE WHEN DM.VAT_RATE_SAL = 18 THEN SVAT_ACC ELSE 0 END),
	    
    ID_CONTRACTOR_FROM = ISNULL(DM.ID_CONTRACTOR_FROM, 0),
    CONTRACTOR_FROM = ISNULL(C.NAME,''),
    DM.ID_TABLE,
    DOC_TYPE = TD.DESCRIPTION

FROM DOC_MOVEMENT DM
	INNER JOIN TABLE_DATA TD ON TD.ID_TABLE_DATA = DM.ID_TABLE
	INNER JOIN ALL_DOCUMENT AD ON AD.ID_DOCUMENT_GLOBAL = DM.ID_DOCUMENT
	LEFT JOIN INVOICE I ON DM.ID_DOCUMENT = I.ID_INVOICE_GLOBAL
	LEFT JOIN CONTRACTOR C ON C.ID_CONTRACTOR = DM.ID_CONTRACTOR_FROM
	LEFT JOIN STORE S ON S.ID_STORE = DM.ID_STORE_FROM
WHERE DM.CODE_OP='ADD' AND DM.ID_TABLE <> 19
	AND DATE_OP BETWEEN @DATE_FR AND @DATE_TO
	AND DM.ID_STORE IN (SELECT ID_STORE FROM #STORE)	 
	AND (@NOAU = 1 OR (DM.ID_TABLE not in (8, 37, 39)) OR dm.id_store_from not in (select id_store from #store where id_contractor = dm.id_contractor_to))
GROUP BY DM.ID_DOCUMENT, 
		 DM.ID_TABLE, 
		 TD.DESCRIPTION, 
		 DM.DATE_OP, 
		 AD.DOC_NUM,
		 CASE WHEN DM.ID_TABLE = 2 THEN ISNULL('π Õœ:'+ I.INCOMING_NUMBER,'') ELSE '' END,
		 ISNULL(TD.DESCRIPTION+': ','')+ISNULL(C.NAME,'')+ISNULL('('+S.NAME+')',''),
		 ISNULL(DM.ID_CONTRACTOR_FROM, 0),
		 ISNULL(C.NAME,''),
         ISNULL(C.NAME,'')+ISNULL('('+S.NAME+')','')
ORDER BY CASE WHEN NULLIF(@SORT_DOC,0) IS NULL THEN DM.DATE_OP ELSE NULL END, 
	CASE WHEN NULLIF(@SORT_DOC,0) IS NULL THEN NULL ELSE TD.DESCRIPTION END, 
	ISNULL(C.NAME,''), DM.DATE_OP

END
ELSE BEGIN
SELECT
    ID_DOCUMENT = CAST(NULL AS UNIQUEIDENTIFIER),
    DOC_NAME = CAST(NULL AS NVARCHAR(128)),
	DATE_OP = CAST(NULL AS DATETIME),
	DOC_NUM = CAST(NULL AS NVARCHAR(128)),
	INCOMING_NUMBER = CAST(NULL AS NVARCHAR(128)),
    SUM_SUP = CAST(NULL AS MONEY),
    SUM_ACC = CAST(NULL AS MONEY),
	KOF = CAST(NULL AS BIT),
	SUM_SVAT_SUP = CAST(NULL AS MONEY),
	SUM_SVAT_ACC = CAST(NULL AS MONEY),
	SUM_SUP0 = CAST(NULL AS MONEY),
	SUM_SUP10 = CAST(NULL AS MONEY),
	SUM_SUP18 = CAST(NULL AS MONEY),
	SUM_ACC0 = CAST(NULL AS MONEY),
	SUM_ACC10 = CAST(NULL AS MONEY),
	SUM_ACC18 = CAST(NULL AS MONEY),
    SVAT_SUP10 = CAST(NULL AS MONEY),
    SVAT_SUP18 = CAST(NULL AS MONEY),
    SVAT_ACC10 = CAST(NULL AS MONEY),
    SVAT_ACC18 = CAST(NULL AS MONEY),
	    
    ID_CONTRACTOR_FROM = CAST(NULL AS BIGINT),
    CONTRACTOR_FROM = CAST(NULL AS NVARCHAR(128)),
    ID_TABLE = CAST(NULL AS BIGINT),
    DOC_TYPE = CAST(NULL AS NVARCHAR(128))
END

IF(@SHOW_SUB = 1) BEGIN
-- Œ¡Ÿ»… –¿—’Œƒ œŒ ƒŒ ”Ã≈Õ“¿Ã
SELECT 
    ID_DOCUMENT = DM.ID_DOCUMENT,
    DOC_NAME = ISNULL(TD.DESCRIPTION+': ','')+CASE WHEN DM.ID_TABLE=19 THEN '' ELSE ISNULL(C.NAME,'')+ISNULL('('+S.NAME+')','') END,
    DATE_OP = DM.DATE_OP, 
    DOC_NUM = AD.DOC_NUM,
	
	SUM_DIS = SUM(CASE WHEN DM.CODE_OP='DIS' AND DM.ID_TABLE=19 THEN DM.SUM_ACC * DM.SIGN_OP WHEN DM.CODE_OP='DIS' AND DM.ID_TABLE<>19 THEN DM.SUM_ACC ELSE 0 END),
	SUM_DIS0 = SUM(CASE WHEN DM.VAT_RATE_SAL = 0 THEN CASE WHEN DM.CODE_OP='DIS' AND DM.ID_TABLE=19 THEN DM.SUM_ACC * DM.SIGN_OP WHEN DM.CODE_OP='DIS' AND DM.ID_TABLE<>19 THEN DM.SUM_ACC ELSE 0 END ELSE 0 END),
	SUM_DIS10 = SUM(CASE WHEN DM.VAT_RATE_SAL = 10 THEN CASE WHEN DM.CODE_OP='DIS' AND DM.ID_TABLE=19 THEN DM.SUM_ACC * DM.SIGN_OP WHEN DM.CODE_OP='DIS' AND DM.ID_TABLE<>19 THEN DM.SUM_ACC ELSE 0 END ELSE 0 END),
	SUM_DIS18 = SUM(CASE WHEN DM.VAT_RATE_SAL = 18 THEN CASE WHEN DM.CODE_OP='DIS' AND DM.ID_TABLE=19 THEN DM.SUM_ACC * DM.SIGN_OP WHEN DM.CODE_OP='DIS' AND DM.ID_TABLE<>19 THEN DM.SUM_ACC ELSE 0 END ELSE 0 END),
    
    SUM_SUP = SUM(CASE WHEN DM.CODE_OP='DIS' THEN 0 ELSE DM.SUM_SUP * DM.SIGN_OP * -1 END),
    SUM_ACC = SUM(CASE WHEN DM.CODE_OP='DIS' THEN 0 ELSE DM.SUM_ACC * DM.SIGN_OP * -1 END),
	NAL = SUM(CASE WHEN DM.CODE_OP='DIS' THEN 0 ELSE DM.SUM_ACC * DM.SIGN_OP * -1 END - CASE WHEN DM.CODE_OP='DIS' THEN 0 ELSE DM.SUM_SUP * DM.SIGN_OP * -1 END),
    KOF = CASE WHEN MAX(CODE_OP) = 'DIS' THEN 0 ELSE 1 END,

    SUM_SVAT_SUP = SUM(CASE WHEN DM.CODE_OP='DIS' THEN 0 ELSE DM.SVAT_SUP * DM.SIGN_OP * -1 END),
    SUM_SVAT_ACC = SUM(CASE WHEN DM.CODE_OP='DIS' THEN 0 ELSE DM.SVAT_ACC * DM.SIGN_OP * -1 END),

    SUM_SUP0 = SUM(CASE WHEN DM.VAT_RATE_SAL = 0 THEN CASE WHEN DM.CODE_OP = 'ADD' THEN -1 * DM.SUM_SUP ELSE DM.SUM_SUP END ELSE 0 END),
    SUM_SUP10 = SUM(CASE WHEN DM.VAT_RATE_SAL = 10 THEN CASE WHEN DM.CODE_OP = 'ADD' THEN -1 * DM.SUM_SUP ELSE DM.SUM_SUP END ELSE 0 END),
    SUM_SUP18 = SUM(CASE WHEN DM.VAT_RATE_SAL = 18 THEN CASE WHEN DM.CODE_OP = 'ADD' THEN -1 * DM.SUM_SUP ELSE DM.SUM_SUP END ELSE 0 END),
    SUM_ACC0 = SUM(CASE WHEN DM.VAT_RATE_SAL = 0 THEN CASE WHEN DM.CODE_OP='DIS' THEN 0	ELSE DM.SUM_ACC * DM.SIGN_OP * -1 END ELSE 0 END),
    SUM_ACC10 = SUM(CASE WHEN DM.VAT_RATE_SAL = 10 THEN CASE WHEN DM.CODE_OP='DIS' THEN 0 ELSE DM.SUM_ACC * DM.SIGN_OP * -1 END ELSE 0 END),
    SUM_ACC18 = SUM(CASE WHEN DM.VAT_RATE_SAL = 18 THEN CASE WHEN DM.CODE_OP='DIS' THEN 0 ELSE DM.SUM_ACC * DM.SIGN_OP * -1	END ELSE 0 END),

    SVAT_SUP10 = SUM(CASE WHEN DM.VAT_RATE_SAL = 10 THEN CASE WHEN DM.CODE_OP = 'ADD' THEN -1 * DM.SVAT_SUP ELSE DM.SVAT_SUP END ELSE 0 END),
    SVAT_SUP18 = SUM(CASE WHEN DM.VAT_RATE_SAL = 18 THEN CASE WHEN DM.CODE_OP = 'ADD' THEN -1 * DM.SVAT_SUP ELSE DM.SVAT_SUP END ELSE 0 END),
    SVAT_ACC10 = SUM(CASE WHEN DM.VAT_RATE_SAL = 10 THEN CASE WHEN DM.CODE_OP='DIS' THEN 0 ELSE DM.SVAT_ACC * DM.SIGN_OP * -1 END ELSE 0 END),
    SVAT_ACC18 = SUM(CASE WHEN DM.VAT_RATE_SAL = 18 THEN CASE WHEN DM.CODE_OP='DIS' THEN 0 ELSE DM.SVAT_ACC * DM.SIGN_OP * -1 END ELSE 0 END),
    
    ID_CONTRACTOR_TO = CASE WHEN DM.ID_TABLE=19 THEN NULL ELSE ISNULL(DM.ID_CONTRACTOR_TO, 0) END,
    CONTRACTOR_TO = CASE WHEN DM.ID_TABLE=19 THEN NULL ELSE ISNULL(C.NAME,'') END,
    ID_TABLE = DM.ID_TABLE,
    DOC_TYPE = TD.DESCRIPTION
INTO #T
FROM DOC_MOVEMENT DM
	INNER JOIN TABLE_DATA TD ON TD.ID_TABLE_DATA = DM.ID_TABLE
	INNER JOIN ALL_DOCUMENT AD ON AD.ID_DOCUMENT_GLOBAL = DM.ID_DOCUMENT
	LEFT JOIN CONTRACTOR C ON C.ID_CONTRACTOR = DM.ID_CONTRACTOR_TO
	LEFT JOIN STORE S ON S.ID_STORE = DM.ID_STORE_TO
WHERE (CODE_OP IN ('SUB', 'DIS') OR (CODE_OP = 'ADD' AND dm.ID_TABLE = 19))
	AND DATE_OP BETWEEN @DATE_FR AND @DATE_TO
	AND DM.ID_STORE IN (SELECT ID_STORE FROM #STORE)
	AND (@NOAU = 1 OR (DM.ID_TABLE not in (8, 37, 39)) OR dm.id_store_to not in (select id_store from #store where id_contractor = dm.id_contractor_from))
GROUP BY DM.ID_DOCUMENT,
	     DM.ID_TABLE, 
         TD.DESCRIPTION, 
         DM.DATE_OP, 
         AD.DOC_NUM,
		 ISNULL(TD.DESCRIPTION+': ','')+CASE WHEN DM.ID_TABLE=19 THEN '' ELSE ISNULL(C.NAME,'')+ISNULL('('+S.NAME+')','') END,
		 CASE WHEN DM.ID_TABLE=19 THEN NULL ELSE ISNULL(DM.ID_CONTRACTOR_TO, 0) END,
		 CASE WHEN DM.ID_TABLE=19 THEN NULL ELSE ISNULL(C.NAME,'') END,
		 CASE WHEN DM.ID_TABLE=19 THEN NULL ELSE ISNULL(C.NAME,'')+ISNULL('('+S.NAME+')','') END
ORDER BY CASE WHEN NULLIF(@SORT_DOC,0) IS NULL THEN DM.DATE_OP ELSE NULL END, 
	CASE WHEN NULLIF(@SORT_DOC,0) IS NULL THEN NULL ELSE TD.DESCRIPTION END, 
	CASE WHEN DM.ID_TABLE=19 THEN NULL ELSE ISNULL(C.NAME,'') END, DM.DATE_OP

--SELECT * FROM #T

SELECT
	T.ID_DOCUMENT,
	T.DOC_NAME,
	T.DATE_OP,
	T.DOC_NUM,
	T.SUM_DIS,
	T.SUM_DIS0,
	T.SUM_DIS10,
	T.SUM_DIS18,
	T.SUM_SUP,
	SUM_ACC = T.SUM_ACC + CASE WHEN @DIS = 1 THEN T.SUM_DIS ELSE 0 END,
	NAL = T.NAL + CASE WHEN @DIS = 1 THEN T.SUM_DIS ELSE 0 END,
	T.KOF,
	T.SUM_SVAT_SUP,
	SUM_SVAT_ACC = T.SUM_SVAT_ACC * CASE WHEN @DIS = 1 AND T.SUM_ACC > 0 
		THEN (T.SUM_ACC + CASE WHEN @DIS = 1 THEN T.SUM_DIS ELSE 0 END) / T.SUM_ACC
		ELSE 1 END,
	T.SUM_SUP0,
	T.SUM_SUP10,
	T.SUM_SUP18,
	SUM_ACC0 = T.SUM_ACC0 + CASE WHEN @DIS = 1 THEN T.SUM_DIS0 ELSE 0 END,
	SUM_ACC10 = T.SUM_ACC10 + CASE WHEN @DIS = 1 THEN T.SUM_DIS10 ELSE 0 END,
	SUM_ACC18 = T.SUM_ACC18 + CASE WHEN @DIS = 1 THEN T.SUM_DIS18 ELSE 0 END,
	T.SVAT_SUP10,
	T.SVAT_SUP18,
	SVAT_ACC10 = T.SVAT_ACC10 * CASE WHEN @DIS = 1 AND T.SUM_ACC10 > 0 
		THEN (T.SUM_ACC10 + CASE WHEN @DIS = 1 THEN T.SUM_DIS10 ELSE 0 END) / T.SUM_ACC10
		ELSE 1 END,
	SVAT_ACC18 = T.SVAT_ACC18 * CASE WHEN @DIS = 1 AND T.SUM_ACC18 > 0 
		THEN (T.SUM_ACC18 + CASE WHEN @DIS = 1 THEN T.SUM_DIS18 ELSE 0 END) / T.SUM_ACC18
		ELSE 1 END,
	T.ID_CONTRACTOR_TO,
	T.CONTRACTOR_TO,
	T.ID_TABLE,
	T.DOC_TYPE
FROM #T T

SELECT 
	SUM_DIS = SUM(SUM_DIS),
	SUM_DIS0 = SUM(SUM_DIS0),
	SUM_DIS10 = SUM(SUM_DIS10),
	SUM_DIS18 = SUM(SUM_DIS18)
FROM #T
END
ELSE BEGIN
SELECT
    ID_DOCUMENT = CAST(NULL AS UNIQUEIDENTIFIER),
    DOC_NAME = CAST(NULL AS NVARCHAR(128)),
	DATE_OP = CAST(NULL AS DATETIME),
	DOC_NUM = CAST(NULL AS NVARCHAR(128)),
	SUM_DIS = CAST(NULL AS MONEY),
	SUM_DIS0 = CAST(NULL AS MONEY),
	SUM_DIS10 = CAST(NULL AS MONEY),
	SUM_DIS18 = CAST(NULL AS MONEY),
    SUM_SUP = CAST(NULL AS MONEY),
    SUM_ACC = CAST(NULL AS MONEY),
	KOF = CAST(NULL AS BIT),
	SUM_SVAT_SUP = CAST(NULL AS MONEY),
	SUM_SVAT_ACC = CAST(NULL AS MONEY),
	SUM_SUP0 = CAST(NULL AS MONEY),
	SUM_SUP10 = CAST(NULL AS MONEY),
	SUM_SUP18 = CAST(NULL AS MONEY),
	SUM_ACC0 = CAST(NULL AS MONEY),
	SUM_ACC10 = CAST(NULL AS MONEY),
	SUM_ACC18 = CAST(NULL AS MONEY),
    SVAT_SUP10 = CAST(NULL AS MONEY),
    SVAT_SUP18 = CAST(NULL AS MONEY),
    SVAT_ACC10 = CAST(NULL AS MONEY),
    SVAT_ACC18 = CAST(NULL AS MONEY),
    ID_CONTRACTOR_TO = CAST(NULL AS BIGINT),
	CONTRACTOR_TO = CAST(NULL AS NVARCHAR(128)),
	ID_TABLE = CAST(NULL AS BIGINT),
	DOC_TYPE = CAST(NULL AS NVARCHAR(128))
    
SELECT 
	SUM_DIS = NULL,
	SUM_DIS0 = NULL,
	SUM_DIS10 = NULL,
	SUM_DIS18 = NULL
END

DECLARE @STORES VARCHAR(1024)
DECLARE @CONTRACTORS VARCHAR(1024)

EXEC DBO.USP_TABLE_NAMES '#STORE', @STORES OUT
EXEC DBO.USP_TABLE_NAMES '#CONTRACTOR', @CONTRACTORS OUT
SELECT CONTRACTOR = @CONTRACTORS, STORE = @STORES

-- Œ—“¿“Œ  Õ¿  ŒÕ≈÷
SELECT
    SUM_SUP = SUM(DM.SUM_SUP * DM.SIGN_OP),
    SUM_ACC = SUM(CASE WHEN ID_TABLE=19 AND CODE_OP='DIS' THEN -1 ELSE 1 END * DM.SUM_ACC * DM.SIGN_OP),
	NAL = SUM(CASE WHEN ID_TABLE=19 AND CODE_OP='DIS' THEN -1 ELSE 1 END * DM.SUM_ACC * DM.SIGN_OP - DM.SUM_SUP * DM.SIGN_OP),
    KOF = CASE WHEN MAX(CODE_OP) = 'DIS' THEN 0 ELSE 1 END,

    SUM_SVAT_SUP = SUM(DM.SVAT_SUP * DM.SIGN_OP),
    SUM_SVAT_ACC = SUM(CASE WHEN DM.ID_TABLE=19 AND CODE_OP='DIS' THEN -1 ELSE 1 END * DM.SVAT_ACC * DM.SIGN_OP),

    SUM_SUP0 = SUM(CASE WHEN DM.VAT_RATE_SAL = 0 THEN (DM.SUM_SUP * DM.SIGN_OP) ELSE 0 END),
    SUM_SUP10 = SUM(CASE WHEN DM.VAT_RATE_SAL = 10 THEN (DM.SUM_SUP * DM.SIGN_OP) ELSE 0 END),
    SUM_SUP18 = SUM(CASE WHEN DM.VAT_RATE_SAL = 18 THEN (DM.SUM_SUP * DM.SIGN_OP) ELSE 0 END),
    SUM_ACC0 = SUM(CASE WHEN DM.VAT_RATE_SAL = 0 THEN CASE WHEN DM.ID_TABLE=19 AND CODE_OP='DIS' THEN -1 ELSE 1 END * SUM_ACC * DM.SIGN_OP ELSE 0 END),
    SUM_ACC10 = SUM(CASE WHEN DM.VAT_RATE_SAL = 10 THEN CASE WHEN DM.ID_TABLE=19 AND CODE_OP='DIS' THEN -1 ELSE 1 END * SUM_ACC * DM.SIGN_OP ELSE 0 END),
    SUM_ACC18 = SUM(CASE WHEN DM.VAT_RATE_SAL = 18 THEN CASE WHEN DM.ID_TABLE=19 AND CODE_OP='DIS' THEN -1 ELSE 1 END * SUM_ACC * DM.SIGN_OP ELSE 0 END),

    SVAT_SUP10 = SUM(CASE WHEN DM.VAT_RATE_SAL = 10 THEN (DM.SVAT_SUP * DM.SIGN_OP) ELSE 0 END),
    SVAT_SUP18 = SUM(CASE WHEN DM.VAT_RATE_SAL = 18 THEN (DM.SVAT_SUP * DM.SIGN_OP) ELSE 0 END),
    SVAT_ACC10 = SUM(CASE WHEN DM.VAT_RATE_SAL = 10 THEN CASE WHEN DM.ID_TABLE=19 AND CODE_OP='DIS' THEN -1 ELSE 1 END * SVAT_ACC * DM.SIGN_OP ELSE 0 END),
    SVAT_ACC18 = SUM(CASE WHEN DM.VAT_RATE_SAL = 18 THEN CASE WHEN DM.ID_TABLE=19 AND CODE_OP='DIS' THEN -1 ELSE 1 END * SVAT_ACC * DM.SIGN_OP ELSE 0 END)
    --,
    
    --SUM_DIS = SUM(CASE WHEN DM.CODE_OP='DIS' AND DM.ID_TABLE=19 THEN DM.SUM_ACC * DM.SIGN_OP WHEN DM.CODE_OP='DIS' AND DM.ID_TABLE<>19 THEN DM.SUM_ACC ELSE 0 END),
	--SUM_DIS0 = SUM(CASE WHEN DM.VAT_RATE_SAL = 0 THEN CASE WHEN DM.CODE_OP='DIS' AND DM.ID_TABLE=19 THEN DM.SUM_ACC * DM.SIGN_OP WHEN DM.CODE_OP='DIS' AND DM.ID_TABLE<>19 THEN DM.SUM_ACC ELSE 0 END ELSE 0 END),
	--SUM_DIS10 = SUM(CASE WHEN DM.VAT_RATE_SAL = 10 THEN CASE WHEN DM.CODE_OP='DIS' AND DM.ID_TABLE=19 THEN DM.SUM_ACC * DM.SIGN_OP WHEN DM.CODE_OP='DIS' AND DM.ID_TABLE<>19 THEN DM.SUM_ACC ELSE 0 END ELSE 0 END),
	--SUM_DIS18 = SUM(CASE WHEN DM.VAT_RATE_SAL = 18 THEN CASE WHEN DM.CODE_OP='DIS' AND DM.ID_TABLE=19 THEN DM.SUM_ACC * DM.SIGN_OP WHEN DM.CODE_OP='DIS' AND DM.ID_TABLE<>19 THEN DM.SUM_ACC ELSE 0 END ELSE 0 END)
--INTO #RESTS
FROM DOC_MOVEMENT DM
WHERE DATE_OP <= @DATE_TO
	AND DM.ID_STORE IN (SELECT ID_STORE FROM #STORE)
	
/*SELECT 
	SUM_SUP,
	SUM_ACC = SUM_ACC + CASE WHEN @DIS = 1 THEN SUM_DIS ELSE 0 END,
	NAL = NAL + CASE WHEN @DIS = 1 THEN NAL ELSE 0 END,
	KOF,
	
	SUM_SVAT_SUP,
	SUM_SVAT_ACC = SUM_SVAT_ACC * CASE WHEN @DIS = 1 AND SUM_ACC > 0 
		THEN (SUM_ACC + CASE WHEN @DIS = 1 THEN SUM_DIS ELSE 0 END) / SUM_ACC
		ELSE 1 END,
	
	SUM_SUP0,
	SUM_SUP10,
	SUM_SUP18,
	SUM_ACC0 = SUM_ACC0 + CASE WHEN @DIS = 1 THEN SUM_DIS0 ELSE 0 END,
	SUM_ACC10 = SUM_ACC10 + CASE WHEN @DIS = 1 THEN SUM_DIS10 ELSE 0 END,
	SUM_ACC18 = SUM_ACC18 + CASE WHEN @DIS = 1 THEN SUM_DIS18 ELSE 0 END,
	
	SVAT_SUP10,
	SVAT_SUP18,
	SVAT_ACC10 = SVAT_ACC10 * CASE WHEN @DIS = 1 AND SUM_ACC10 > 0 
		THEN (SUM_ACC10 + CASE WHEN @DIS = 1 THEN SUM_DIS10 ELSE 0 END) / SUM_ACC10
		ELSE 1 END,
	SVAT_ACC18 = SVAT_ACC18 * CASE WHEN @DIS = 1 AND SUM_ACC18 > 0 
		THEN (SUM_ACC18 + CASE WHEN @DIS = 1 THEN SUM_DIS18 ELSE 0 END) / SUM_ACC18
		ELSE 1 END
FROM #RESTS*/

SELECT
	SUM_ACC = NULL,
	SUM_ACC0 = NULL,
	SUM_ACC10 = NULL,
	SUM_ACC18 = NULL,
	SUM_VAT = NULL,
	SVAT_ACC10 = NULL,
	SVAT_ACC18 = NULL

RETURN 0
GO

/*
exec REP_GOODS_REPORTS_TO_EX_SAL N'
<XML>
	<DATE_FR>2009-12-10T00:00:00.000</DATE_FR>
	<DATE_TO>2009-12-10T00:00:00.000</DATE_TO>
	<SHOW_ADD>1</SHOW_ADD>
	<SHOW_SUB>1</SHOW_SUB>
	<SORT_DOC>1</SORT_DOC>
	<ID_CONTRACTOR>5271</ID_CONTRACTOR>
	<NOAU>1</NOAU>
</XML>'*/

SET NOCOUNT ON
SET QUOTED_IDENTIFIER OFF
GO

IF (OBJECT_ID('DBO.REP_GOODS_REPORTS_TO_EX_SERVICE_SAL') IS NULL ) EXEC ('CREATE PROCEDURE DBO.REP_GOODS_REPORTS_TO_EX_SERVICE_SAL AS SELECT NULL')
GO
ALTER PROCEDURE DBO.REP_GOODS_REPORTS_TO_EX_SERVICE_SAL
         @XMLPARAM NTEXT
AS
SET NOCOUNT ON
DECLARE @DATE_FR DATETIME, @DATE_TO DATETIME
DECLARE @SORT_DOC BIT, @SHOW_ADD BIT, @SHOW_SUB BIT, @REFRESH_DOC_MOV BIT

DECLARE @HDOC INT, @SQL NVARCHAR(4000), @SQL_FIELDS NVARCHAR(4000)
DECLARE @NOAU BIT, @DIS BIT, @CO BIT

EXEC SP_XML_PREPAREDOCUMENT @HDOC OUTPUT, @XMLPARAM OUTPUT
    SELECT TOP 1 
        @DATE_FR = DATE_FR, @DATE_TO = DATE_TO,
        @SORT_DOC = SORT_DOC,
        @SHOW_ADD = SHOW_ADD, @SHOW_SUB = SHOW_SUB,
        @REFRESH_DOC_MOV = REFRESH_DOC_MOV,
		@NOAU = NOAU, @DIS = DIS, @CO = CO
    FROM OPENXML(@HDOC, '/XML') WITH(
        DATE_FR DATETIME 'DATE_FR', 
        DATE_TO DATETIME 'DATE_TO', 
        SORT_DOC BIT 'SORT_DOC', 
        SHOW_ADD BIT 'SHOW_ADD', 
        SHOW_SUB BIT 'SHOW_SUB',
        REFRESH_DOC_MOV BIT 'REFRESH_DOC_MOV',
		NOAU BIT 'NOAU',
		DIS BIT 'DIS',
		CO BIT 'CO')

    /* “¿¡À»÷¿ »ƒ≈Õ“»‘» ¿“Œ–Œ¬  ŒÕ“–¿√≈Õ“Œ¬ */
    SELECT DISTINCT C.ID_CONTRACTOR, C.NAME INTO #CONTRACTOR
    FROM 
        (SELECT * FROM OPENXML(@HDOC, '//ID_CONTRACTOR') 
        WITH(ID_CONTRACTOR BIGINT '.')) TAB
    INNER JOIN CONTRACTOR C ON C.ID_CONTRACTOR = TAB.ID_CONTRACTOR
    WHERE ((@CO <> 1 OR @CO IS NULL) 
		AND C.ID_CONTRACTOR = (SELECT TOP 1 ID_CONTRACTOR FROM ENTERPRISE_BRANCH WHERE IS_SELF = 1))
		OR (@CO = 1)
    
    /* “¿¡À»÷¿ »ƒ≈Õ“»‘» ¿“Œ–Œ¬ — À¿ƒŒ¬ */
    SELECT DISTINCT S.ID_STORE, S.ID_CONTRACTOR, S.NAME INTO #STORE
    FROM
    	(SELECT * FROM OPENXML(@HDOC, '//ID_STORE') 
        WITH(ID_STORE BIGINT '.')) TAB
    INNER JOIN STORE S ON S.ID_STORE = TAB.ID_STORE
    WHERE ((@CO <> 1 OR @CO IS NULL) 
		AND S.ID_CONTRACTOR = (SELECT TOP 1 ID_CONTRACTOR FROM ENTERPRISE_BRANCH WHERE IS_SELF = 1))
		OR (@CO = 1)
		
EXEC SP_XML_REMOVEDOCUMENT @HDOC

IF @REFRESH_DOC_MOV = 1 BEGIN
    -- ÔÂÂÒ˜ËÚ‡Ú¸ DOC_MOVEMENT ÔÓ ‚ÒÂÏ ‰ÓÍÛÏÂÌÚ‡Ï
    EXEC UTL_REFRESH_DOC_MOVEMENT 'REPAIR', 0
END

-- ÓÚÌÓÏËÓ‚‡Ú¸ ‰‡Ú˚
EXEC USP_RANGE_DAYS @DATE_FR OUT, @DATE_TO OUT
EXEC USP_RANGE_NORM @DATE_FR OUT, @DATE_TO OUT

-- ≈—À» Õ≈ ” ¿«¿Õ — À¿ƒ, “Œ »“Œ√» ¬€¡»–¿ﬁ“—ﬂ œŒ ¬—≈Ã — À¿ƒ¿Ã
IF NOT EXISTS(SELECT TOP 1 1 FROM #STORE) BEGIN
    INSERT INTO #STORE (ID_STORE, ID_CONTRACTOR, NAME)
    SELECT S.ID_STORE, S.ID_CONTRACTOR, S.NAME
    FROM STORE S(NOLOCK) INNER JOIN #CONTRACTOR C ON C.ID_CONTRACTOR = S.ID_CONTRACTOR
END
DELETE FROM #STORE WHERE ID_CONTRACTOR NOT IN (SELECT ID_CONTRACTOR FROM #CONTRACTOR)

-- Œ—“¿“Œ  Õ¿ Õ¿◊¿ÀŒ
SELECT
    SUM_SUP = SUM(DM.SUM_SUP * DM.SIGN_OP),
    SUM_ACC = SUM(CASE WHEN DM.ID_TABLE=19 AND CODE_OP='DIS' THEN -1 ELSE 1 END * DM.SUM_ACC * DM.SIGN_OP),
	NAL = SUM(CASE WHEN DM.ID_TABLE=19 AND CODE_OP='DIS' THEN -1 ELSE 1 END * DM.SUM_ACC * DM.SIGN_OP - DM.SUM_SUP * DM.SIGN_OP),
    KOF = CASE WHEN MAX(CODE_OP) = 'DIS' THEN 0 ELSE 1 END,

    SUM_SVAT_SUP = SUM(DM.SVAT_SUP * DM.SIGN_OP),
    SUM_SVAT_ACC = SUM(CASE WHEN DM.ID_TABLE=19 AND CODE_OP='DIS' THEN -1 ELSE 1 END * DM.SVAT_ACC * DM.SIGN_OP),

    SUM_SUP0 = SUM(CASE WHEN DM.VAT_RATE_SAL = 0 THEN (DM.SUM_SUP * DM.SIGN_OP) ELSE 0 END),
    SUM_SUP10 = SUM(CASE WHEN DM.VAT_RATE_SAL = 10 THEN (DM.SUM_SUP * DM.SIGN_OP) ELSE 0 END),
    SUM_SUP18 = SUM(CASE WHEN DM.VAT_RATE_SAL = 18 THEN (DM.SUM_SUP * DM.SIGN_OP) ELSE 0 END),
    SUM_ACC0 = SUM(CASE WHEN DM.VAT_RATE_SAL = 0 THEN CASE WHEN DM.ID_TABLE=19 AND CODE_OP='DIS' THEN -1 ELSE 1 END * SUM_ACC * DM.SIGN_OP ELSE 0 END),
    SUM_ACC10 = SUM(CASE WHEN DM.VAT_RATE_SAL = 10 THEN CASE WHEN DM.ID_TABLE=19 AND CODE_OP='DIS' THEN -1 ELSE 1 END * SUM_ACC * DM.SIGN_OP ELSE 0 END),
    SUM_ACC18 = SUM(CASE WHEN DM.VAT_RATE_SAL = 18 THEN CASE WHEN DM.ID_TABLE=19 AND CODE_OP='DIS' THEN -1 ELSE 1 END * SUM_ACC * DM.SIGN_OP ELSE 0 END),

    SVAT_SUP10 = SUM(CASE WHEN DM.VAT_RATE_SAL = 10 THEN (DM.SVAT_SUP * DM.SIGN_OP) ELSE 0 END),
    SVAT_SUP18 = SUM(CASE WHEN DM.VAT_RATE_SAL = 18 THEN (DM.SVAT_SUP * DM.SIGN_OP) ELSE 0 END),
    SVAT_ACC10 = SUM(CASE WHEN DM.VAT_RATE_SAL = 10 THEN CASE WHEN DM.ID_TABLE=19 AND CODE_OP='DIS' THEN -1 ELSE 1 END * SVAT_ACC * DM.SIGN_OP ELSE 0 END),
    SVAT_ACC18 = SUM(CASE WHEN DM.VAT_RATE_SAL = 18 THEN CASE WHEN DM.ID_TABLE=19 AND CODE_OP='DIS' THEN -1 ELSE 1 END * SVAT_ACC * DM.SIGN_OP ELSE 0 END)
    --,
    
    --SUM_DIS = SUM(CASE WHEN DM.CODE_OP='DIS' AND DM.ID_TABLE=19 THEN DM.SUM_ACC * DM.SIGN_OP WHEN DM.CODE_OP='DIS' AND DM.ID_TABLE<>19 THEN DM.SUM_ACC ELSE 0 END),
	--SUM_DIS0 = SUM(CASE WHEN DM.VAT_RATE_SAL = 0 THEN CASE WHEN DM.CODE_OP='DIS' AND DM.ID_TABLE=19 THEN DM.SUM_ACC * DM.SIGN_OP WHEN DM.CODE_OP='DIS' AND DM.ID_TABLE<>19 THEN DM.SUM_ACC ELSE 0 END ELSE 0 END),
	--SUM_DIS10 = SUM(CASE WHEN DM.VAT_RATE_SAL = 10 THEN CASE WHEN DM.CODE_OP='DIS' AND DM.ID_TABLE=19 THEN DM.SUM_ACC * DM.SIGN_OP WHEN DM.CODE_OP='DIS' AND DM.ID_TABLE<>19 THEN DM.SUM_ACC ELSE 0 END ELSE 0 END),
	--SUM_DIS18 = SUM(CASE WHEN DM.VAT_RATE_SAL = 18 THEN CASE WHEN DM.CODE_OP='DIS' AND DM.ID_TABLE=19 THEN DM.SUM_ACC * DM.SIGN_OP WHEN DM.CODE_OP='DIS' AND DM.ID_TABLE<>19 THEN DM.SUM_ACC ELSE 0 END ELSE 0 END)
--INTO #START_RESTS
FROM DOC_MOVEMENT DM
	WHERE DATE_OP < @DATE_FR
		AND DM.ID_STORE IN (SELECT ID_STORE FROM #STORE)

/*SELECT 
	SUM_SUP,
	SUM_ACC = SUM_ACC + CASE WHEN @DIS = 1 THEN SUM_DIS ELSE 0 END,
	NAL = NAL + CASE WHEN @DIS = 1 THEN NAL ELSE 0 END,
	KOF,
	
	SUM_SVAT_SUP,
	SUM_SVAT_ACC = SUM_SVAT_ACC * CASE WHEN @DIS = 1 AND SUM_ACC > 0 
		THEN (SUM_ACC + CASE WHEN @DIS = 1 THEN SUM_DIS ELSE 0 END) / SUM_ACC
		ELSE 1 END,
	
	SUM_SUP0,
	SUM_SUP10,
	SUM_SUP18,
	SUM_ACC0 = SUM_ACC0 + CASE WHEN @DIS = 1 THEN SUM_DIS0 ELSE 0 END,
	SUM_ACC10 = SUM_ACC10 + CASE WHEN @DIS = 1 THEN SUM_DIS10 ELSE 0 END,
	SUM_ACC18 = SUM_ACC18 + CASE WHEN @DIS = 1 THEN SUM_DIS18 ELSE 0 END,
	
	SVAT_SUP10,
	SVAT_SUP18,
	SVAT_ACC10 = SVAT_ACC10 * CASE WHEN @DIS = 1 AND SUM_ACC10 > 0 
		THEN (SUM_ACC10 + CASE WHEN @DIS = 1 THEN SUM_DIS10 ELSE 0 END) / SUM_ACC10
		ELSE 1 END,
	SVAT_ACC18 = SVAT_ACC18 * CASE WHEN @DIS = 1 AND SUM_ACC18 > 0 
		THEN (SUM_ACC18 + CASE WHEN @DIS = 1 THEN SUM_DIS18 ELSE 0 END) / SUM_ACC18
		ELSE 1 END
FROM #START_RESTS*/

--œ–»’Œƒ
IF(@SHOW_ADD = 1) BEGIN
SELECT
	ID_DOCUMENT = R1.ID_DOCUMENT,	
	DOC_NAME = R1.DOC_NAME,
	DATE_OP = R1.DATE_OP,
	DOC_NUM = R1.DOC_NUM,
	INCOMING_NUMBER = MAX(R1.INCOMING_NUMBER),

	SUM_SUP = SUM(R1.SUM_SUP),
    SUM_ACC = SUM(R1.SUM_ACC),
	NAL = SUM(R1.NAL),
    --KOF = CASE WHEN CODE_OP = 'DIS' THEN 0 ELSE 1 END,

    SUM_SVAT_SUP = SUM(R1.SUM_SVAT_SUP),
    SUM_SVAT_ACC = SUM(R1.SUM_SVAT_ACC),

    SUM_SUP0 = SUM(R1.SUM_SUP0),
    SUM_SUP10 = SUM(R1.SUM_SUP10),
    SUM_SUP18 = SUM(R1.SUM_SUP18),
    SUM_ACC0 = SUM(R1.SUM_ACC0),
    SUM_ACC10 = SUM(R1.SUM_ACC10),
    SUM_ACC18 = SUM(R1.SUM_ACC18),

    SVAT_SUP10 = SUM(R1.SVAT_SUP10),
    SVAT_SUP18 = SUM(R1.SVAT_SUP18),
    SVAT_ACC10 = SUM(R1.SVAT_ACC10),
    SVAT_ACC18 = SUM(R1.SVAT_ACC18),
	    
    ID_CONTRACTOR_FROM = R1.ID_CONTRACTOR_FROM,
    CONTRACTOR_FROM = R1.CONTRACTOR_FROM,
    ID_TABLE = R1.ID_TABLE,
    DOC_TYPE = R1.DOC_TYPE
FROM
(
SELECT
	ID_DOCUMENT = DM.ID_DOCUMENT,
	DOC_NAME = ISNULL(TD.DESCRIPTION+': ','')+CASE WHEN DM.ID_TABLE=19 THEN '' ELSE ISNULL(C.NAME,'')+ISNULL('('+S.NAME+')','') END,
	DATE_OP = DM.DATE_OP,
	DOC_NUM = AD.DOC_NUM,
	INCOMING_NUMBER = CASE WHEN DM.ID_TABLE = 2 THEN ISNULL('π Õœ:'+ I.INCOMING_NUMBER,'') ELSE '' END,

	SUM_SUP = DM.SUM_SUP,
	SUM_ACC = DM.SUM_ACC,
	NAL = DM.SUM_ACC - DM.SUM_SUP,
	--KOF = CASE WHEN CODE_OP = 'DIS' THEN 0 ELSE 1 END,
	
	SUM_SVAT_SUP = DM.SVAT_SUP,
	SUM_SVAT_ACC = DM.SVAT_ACC,
	
	SUM_SUP0 = CASE WHEN DM.VAT_RATE_SAL = 0 THEN (DM.SUM_SUP * DM.SIGN_OP) ELSE 0 END,
	SUM_SUP10 = CASE WHEN DM.VAT_RATE_SAL = 10 THEN (DM.SUM_SUP * DM.SIGN_OP) ELSE 0 END,
	SUM_SUP18 = CASE WHEN DM.VAT_RATE_SAL = 18 THEN (DM.SUM_SUP * DM.SIGN_OP) ELSE 0 END,
	SUM_ACC0 = CASE WHEN DM.VAT_RATE_SAL = 0 THEN SUM_ACC ELSE 0 END,
	SUM_ACC10 = CASE WHEN DM.VAT_RATE_SAL =10 THEN SUM_ACC ELSE 0 END,
	SUM_ACC18 = CASE WHEN DM.VAT_RATE_SAL = 18 THEN SUM_ACC ELSE 0 END,
	
	SVAT_SUP10 = CASE WHEN DM.VAT_RATE_SAL = 10 THEN (DM.SVAT_SUP * DM.SIGN_OP) ELSE 0 END,
	SVAT_SUP18 = CASE WHEN DM.VAT_RATE_SAL = 18 THEN (DM.SVAT_SUP * DM.SIGN_OP) ELSE 0 END,
	SVAT_ACC10 = CASE WHEN DM.VAT_RATE_SAL = 10 THEN SVAT_ACC ELSE 0 END,
	SVAT_ACC18 = CASE WHEN DM.VAT_RATE_SAL = 18 THEN SVAT_ACC ELSE 0 END,
	
	ID_CONTRACTOR_FROM = ISNULL(DM.ID_CONTRACTOR_FROM, 0),
    CONTRACTOR_FROM = ISNULL(C.NAME,''),
    DM.ID_TABLE,
    DOC_TYPE = TD.DESCRIPTION
FROM DOC_MOVEMENT DM
    INNER JOIN TABLE_DATA TD ON TD.ID_TABLE_DATA = DM.ID_TABLE
    INNER JOIN ALL_DOCUMENT AD ON AD.ID_DOCUMENT_GLOBAL = DM.ID_DOCUMENT
	LEFT JOIN INVOICE I ON DM.ID_DOCUMENT = I.ID_INVOICE_GLOBAL
    LEFT JOIN CONTRACTOR C ON C.ID_CONTRACTOR = DM.ID_CONTRACTOR_FROM
    LEFT JOIN STORE S ON S.ID_STORE = DM.ID_STORE_FROM
WHERE DM.CODE_OP='ADD' AND DM.ID_TABLE <> 19
	AND DATE_OP BETWEEN @DATE_FR AND @DATE_TO
	AND (DM.ID_STORE IS NOT NULL AND DM.ID_STORE IN (SELECT ID_STORE FROM #STORE))
	AND (@NOAU = 1 OR (DM.ID_TABLE not in (8, 37, 39)) OR dm.id_store_from not in (select id_store from #store where id_contractor = dm.id_contractor_to))

) AS R1
GROUP BY R1.ID_DOCUMENT, R1.ID_TABLE, R1.DOC_TYPE, R1.DATE_OP, R1.DOC_NAME, R1.DOC_NUM, 
	R1.ID_CONTRACTOR_FROM, R1.CONTRACTOR_FROM
ORDER BY CASE WHEN @SORT_DOC = 0 THEN NULL ELSE R1.DOC_NAME END, 
	CASE WHEN @SORT_DOC = 0 THEN R1.DATE_OP ELSE NULL END, 
	R1.CONTRACTOR_FROM, R1.DATE_OP

END
ELSE BEGIN
SELECT
    ID_DOCUMENT = CAST(NULL AS UNIQUEIDENTIFIER),
    DOC_NAME = CAST(NULL AS NVARCHAR(128)),
	DATE_OP = CAST(NULL AS DATETIME),
	DOC_NUM = CAST(NULL AS NVARCHAR(128)),
	INCOMING_NUMBER = CAST(NULL AS NVARCHAR(128)),
    SUM_SUP = CAST(NULL AS MONEY),
    SUM_ACC = CAST(NULL AS MONEY),
	KOF = CAST(NULL AS BIT),
	SUM_SVAT_SUP = CAST(NULL AS MONEY),
	SUM_SVAT_ACC = CAST(NULL AS MONEY),
	SUM_SUP0 = CAST(NULL AS MONEY),
	SUM_SUP10 = CAST(NULL AS MONEY),
	SUM_SUP18 = CAST(NULL AS MONEY),
	SUM_ACC0 = CAST(NULL AS MONEY),
	SUM_ACC10 = CAST(NULL AS MONEY),
	SUM_ACC18 = CAST(NULL AS MONEY),
    SVAT_SUP10 = CAST(NULL AS MONEY),
    SVAT_SUP18 = CAST(NULL AS MONEY),
    SVAT_ACC10 = CAST(NULL AS MONEY),
    SVAT_ACC18 = CAST(NULL AS MONEY),
	    
    ID_CONTRACTOR_FROM = CAST(NULL AS BIGINT),
    CONTRACTOR_FROM = CAST(NULL AS NVARCHAR(128)),
    ID_TABLE = CAST(NULL AS BIGINT),
    DOC_TYPE = CAST(NULL AS NVARCHAR(128))
END

-- Œ¡Ÿ»… –¿—’Œƒ œŒ ƒŒ ”Ã≈Õ“¿Ã
IF(@SHOW_SUB = 1)
BEGIN

SELECT
	ID_DOCUMENT = R1.ID_DOCUMENT,
	DOC_NAME = R1.DOC_NAME,
	DATE_OP = R1.DATE_OP,
	DOC_NUM = R1.DOC_NUM,

	SUM_DIS = SUM(R1.SUM_DIS),
	SUM_DIS0 = SUM(R1.SUM_DIS0),
	SUM_DIS10 = SUM(R1.SUM_DIS10),
	SUM_DIS18 = SUM(R1.SUM_DIS18),
	
	SUM_SUP = SUM(R1.SUM_SUP),
    SUM_ACC = SUM(R1.SUM_ACC),
	NAL = SUM(R1.NAL),
    KOF = MAX(R1.KOF),

    SUM_SVAT_SUP = SUM(R1.SUM_SVAT_SUP),
    SUM_SVAT_ACC = SUM(R1.SUM_SVAT_ACC),

    SUM_SUP0 = SUM(R1.SUM_SUP0),
    SUM_SUP10 = SUM(R1.SUM_SUP10),
    SUM_SUP18 = SUM(R1.SUM_SUP18),
    SUM_ACC0 = SUM(R1.SUM_ACC0),
    SUM_ACC10 = SUM(R1.SUM_ACC10),
    SUM_ACC18 = SUM(R1.SUM_ACC18),

    SVAT_SUP10 = SUM(R1.SVAT_SUP10),
    SVAT_SUP18 = SUM(R1.SVAT_SUP18),
    SVAT_ACC10 = SUM(R1.SVAT_ACC10),
    SVAT_ACC18 = SUM(R1.SVAT_ACC18),
    
    R1.ID_CONTRACTOR_TO,
    R1.CONTRACTOR_TO,
    R1.ID_TABLE,
    R1.DOC_TYPE,
    
	EX = R1.EX
INTO #temp_t
FROM
(
SELECT 
	ID_DOCUMENT = DM.ID_DOCUMENT,
	DOC_NAME = ISNULL(TD.DESCRIPTION+': ','')+CASE WHEN DM.ID_TABLE=19 THEN '' ELSE ISNULL(C.NAME,'')+ISNULL('('+S.NAME+')','') END,
	DATE_OP = DM.DATE_OP,
	DOC_NUM = AD.DOC_NUM,
		
	SUM_DIS = CASE WHEN DM.CODE_OP='DIS' AND DM.ID_TABLE=19 THEN DM.SUM_ACC * DM.SIGN_OP WHEN DM.CODE_OP='DIS' AND DM.ID_TABLE<>19 THEN DM.SUM_ACC ELSE 0 END,
	SUM_DIS0 = CASE WHEN DM.VAT_RATE_SAL = 0 THEN CASE WHEN DM.CODE_OP='DIS' AND DM.ID_TABLE=19 THEN DM.SUM_ACC * DM.SIGN_OP WHEN DM.CODE_OP='DIS' AND DM.ID_TABLE<>19 THEN DM.SUM_ACC ELSE 0 END ELSE 0 END,
	SUM_DIS10 = CASE WHEN DM.VAT_RATE_SAL = 10 THEN CASE WHEN DM.CODE_OP='DIS' AND DM.ID_TABLE=19 THEN DM.SUM_ACC * DM.SIGN_OP WHEN DM.CODE_OP='DIS' AND DM.ID_TABLE<>19 THEN DM.SUM_ACC ELSE 0 END ELSE 0 END,
	SUM_DIS18 = CASE WHEN DM.VAT_RATE_SAL = 18 THEN CASE WHEN DM.CODE_OP='DIS' AND DM.ID_TABLE=19 THEN DM.SUM_ACC * DM.SIGN_OP WHEN DM.CODE_OP='DIS' AND DM.ID_TABLE<>19 THEN DM.SUM_ACC ELSE 0 END ELSE 0 END,
	
	SUM_SUP = CASE WHEN DM.CODE_OP='DIS' THEN 0 ELSE DM.SUM_SUP * DM.SIGN_OP * -1 END,
	SUM_ACC = CASE WHEN DM.CODE_OP='DIS' THEN 0	ELSE DM.SUM_ACC * DM.SIGN_OP * -1 END,
	NAL = CASE WHEN DM.CODE_OP='DIS' THEN 0 ELSE DM.SUM_ACC * DM.SIGN_OP * -1 END -	CASE WHEN DM.CODE_OP='DIS' THEN 0 ELSE DM.SUM_SUP * DM.SIGN_OP * -1 END,
	KOF = CASE WHEN DM.CODE_OP = 'DIS' THEN 0 ELSE 1 END,
	
	SUM_SVAT_SUP = CASE WHEN DM.CODE_OP='DIS' THEN 0 ELSE DM.SVAT_SUP * DM.SIGN_OP * -1	END,
	SUM_SVAT_ACC = CASE WHEN DM.CODE_OP='DIS' THEN 0 ELSE DM.SVAT_ACC * DM.SIGN_OP * -1 END,
	
    SUM_SUP0 = CASE WHEN DM.VAT_RATE_SAL = 0 THEN CASE WHEN DM.CODE_OP = 'ADD' THEN -1 * DM.SUM_SUP ELSE DM.SUM_SUP END ELSE 0 END,
    SUM_SUP10 = CASE WHEN DM.VAT_RATE_SAL = 10 THEN CASE WHEN DM.CODE_OP = 'ADD' THEN -1 * DM.SUM_SUP ELSE DM.SUM_SUP END ELSE 0 END,
    SUM_SUP18 = CASE WHEN DM.VAT_RATE_SAL = 18 THEN CASE WHEN DM.CODE_OP = 'ADD' THEN -1 * DM.SUM_SUP ELSE DM.SUM_SUP END ELSE 0 END,
    SUM_ACC0 = CASE WHEN DM.VAT_RATE_SAL = 0 THEN CASE WHEN DM.CODE_OP='DIS' THEN 0	ELSE DM.SUM_ACC * DM.SIGN_OP * -1 END ELSE 0 END,
    SUM_ACC10 = CASE WHEN DM.VAT_RATE_SAL = 10 THEN CASE WHEN DM.CODE_OP='DIS' THEN 0 ELSE DM.SUM_ACC * DM.SIGN_OP * -1 END ELSE 0 END,
    SUM_ACC18 = CASE WHEN DM.VAT_RATE_SAL = 18 THEN CASE WHEN DM.CODE_OP='DIS' THEN 0 ELSE DM.SUM_ACC * DM.SIGN_OP * -1	END ELSE 0 END,

    SVAT_SUP10 = CASE WHEN DM.VAT_RATE_SAL = 10 THEN CASE WHEN DM.CODE_OP = 'ADD' THEN -1 * DM.SVAT_SUP ELSE DM.SVAT_SUP END ELSE 0 END,
    SVAT_SUP18 = CASE WHEN DM.VAT_RATE_SAL = 18 THEN CASE WHEN DM.CODE_OP = 'ADD' THEN -1 * DM.SVAT_SUP ELSE DM.SVAT_SUP END ELSE 0 END,
    SVAT_ACC10 = CASE WHEN DM.VAT_RATE_SAL = 10 THEN CASE WHEN DM.CODE_OP='DIS' THEN 0 ELSE DM.SVAT_ACC * DM.SIGN_OP * -1 END ELSE 0 END,
    SVAT_ACC18 = CASE WHEN DM.VAT_RATE_SAL = 18 THEN CASE WHEN DM.CODE_OP='DIS' THEN 0 ELSE DM.SVAT_ACC * DM.SIGN_OP * -1 END ELSE 0 END,
    
    ID_CONTRACTOR_TO = CASE WHEN DM.ID_TABLE=19 THEN NULL ELSE ISNULL(DM.ID_CONTRACTOR_TO, 0) END,
    CONTRACTOR_TO = CASE WHEN DM.ID_TABLE=19 THEN NULL ELSE ISNULL(C.NAME,'') END,
    ID_TABLE = DM.ID_TABLE,
    DOC_TYPE = TD.DESCRIPTION,
    
	EX = 0
FROM DOC_MOVEMENT DM
    INNER JOIN TABLE_DATA TD ON TD.ID_TABLE_DATA = DM.ID_TABLE
    INNER JOIN ALL_DOCUMENT AD ON AD.ID_DOCUMENT_GLOBAL = DM.ID_DOCUMENT
    LEFT JOIN CONTRACTOR C ON C.ID_CONTRACTOR = DM.ID_CONTRACTOR_TO
    LEFT JOIN STORE S ON S.ID_STORE = DM.ID_STORE_TO
WHERE (CODE_OP IN ('SUB', 'DIS') OR (CODE_OP = 'ADD' AND dm.ID_TABLE = 19))
		AND DATE_OP BETWEEN @DATE_FR AND @DATE_TO
		AND (DM.ID_STORE IS NOT NULL AND DM.ID_STORE IN (SELECT ID_STORE FROM #STORE))
		AND (@NOAU = 1 OR (DM.ID_TABLE not in (8, 37, 39)) OR dm.id_store_to not in (select id_store from #store where id_contractor = dm.id_contractor_from))

UNION ALL

SELECT
	ID_DOCUMENT = CS.ID_CASH_SESSION_GLOBAL,
	DOC_NAME = '”ÒÎÛ„‡',
	DATE_OP = CS.DATE_CLOSE,
	DOC_NUM = CS.MNEMOCODE,
	
	SUM_DIS = CASE WHEN CH.CHEQUE_TYPE = 'SALE' THEN 1 ELSE -1 END,
	SUM_DIS0 = CH_I.SUMM_DISCOUNT * CASE WHEN TT.TAX_RATE = 0 THEN CASE WHEN CH.CHEQUE_TYPE = 'SALE' THEN 1 ELSE -1 END ELSE 0 END,
	SUM_DIS10 = CH_I.SUMM_DISCOUNT * CASE WHEN TT.TAX_RATE = 10 THEN CASE WHEN CH.CHEQUE_TYPE = 'SALE' THEN 1 ELSE -1 END ELSE 0 END,
	SUM_DIS18 = CH_I.SUMM_DISCOUNT * CASE WHEN TT.TAX_RATE = 18 THEN CASE WHEN CH.CHEQUE_TYPE = 'SALE' THEN 1 ELSE -1 END ELSE 0 END,
	
	SUM_SUP = 0,
	SUM_ACC = CASE WHEN CH.CHEQUE_TYPE = 'SALE' THEN 1 ELSE -1 END * S4S.PRICE_SAL * S4S.QUANTITY * CH_I.QUANTITY,
	NAL = CASE WHEN CH.CHEQUE_TYPE = 'SALE' THEN 1 ELSE -1 END * S4S.PRICE_SAL * S4S.QUANTITY * CH_I.QUANTITY,
	KOF = 1,

	SUM_SVAT_SUP = 0,
	SUM_SVAT_ACC = CASE WHEN CH.CHEQUE_TYPE = 'SALE' THEN 1 ELSE -1 END * (S4S.PRICE_SAL * TT.TAX_RATE / (100+TT.TAX_RATE)) * S4S.QUANTITY * CH_I.QUANTITY,

	SUM_SUP0 = 0,
	SUM_SUP10 = 0,
	SUM_SUP18 = 0,
	SUM_ACC0 = CASE WHEN TT.TAX_RATE = 0 THEN CASE WHEN CH.CHEQUE_TYPE = 'SALE' THEN 1 ELSE -1 END * S4S.PRICE_SAL * S4S.QUANTITY * CH_I.QUANTITY ELSE 0 END,
	SUM_ACC10 = CASE WHEN TT.TAX_RATE = 10 THEN CASE WHEN CH.CHEQUE_TYPE = 'SALE' THEN 1 ELSE -1 END * S4S.PRICE_SAL * S4S.QUANTITY * CH_I.QUANTITY ELSE 0 END,
	SUM_ACC18 = CASE WHEN TT.TAX_RATE = 18 THEN CASE WHEN CH.CHEQUE_TYPE = 'SALE' THEN 1 ELSE -1 END * S4S.PRICE_SAL * S4S.QUANTITY * CH_I.QUANTITY ELSE 0 END,

    SVAT_SUP10 = 0,
    SVAT_SUP18 = 0,
    SVAT_ACC10 = CASE WHEN TT.TAX_RATE = 10 THEN CASE WHEN CH.CHEQUE_TYPE = 'SALE' THEN 1 ELSE -1 END * (S4S.PRICE_SAL * TT.TAX_RATE / (100+TT.TAX_RATE)) * S4S.QUANTITY * CH_I.QUANTITY ELSE 0 END,
    SVAT_ACC18 = CASE WHEN TT.TAX_RATE = 18 THEN CASE WHEN CH.CHEQUE_TYPE = 'SALE' THEN 1 ELSE -1 END * (S4S.PRICE_SAL * TT.TAX_RATE / (100+TT.TAX_RATE)) * S4S.QUANTITY * CH_I.QUANTITY ELSE 0 END,
    
    ID_CONTRACTOR_TO = 999999,
    CONTRACTOR_TO = ' ‡ÒÒÓ‚‡ˇ ÒÏÂÌ‡',
    ID_TABLE = 99,
    DOC_TYPE = '”ÒÎÛ„‡',
    
	EX = 1
FROM CHEQUE_ITEM CH_I
	INNER JOIN CHEQUE CH ON CH.ID_CHEQUE_GLOBAL = CH_I.ID_CHEQUE_GLOBAL
	INNER JOIN CASH_SESSION CS ON CS.ID_CASH_SESSION_GLOBAL = CH.ID_CASH_SESSION_GLOBAL
	INNER JOIN SERVICE_4_SALE_ITEM S4S ON S4S.ID_SERVICE_4_SALE = CH_I.ID_LOT_GLOBAL
	INNER JOIN SERVICE S ON S.ID_SERVICE = S4S.ID_SERVICE
	INNER JOIN TAX_TYPE TT ON TT.ID_TAX_TYPE = S.ID_TAX_TYPE
WHERE CH.CHEQUE_TYPE IN ('SALE', 'RETURN') AND CS.DATE_CLOSE BETWEEN @DATE_FR AND @DATE_TO
) AS R1
GROUP BY R1.ID_DOCUMENT, R1.ID_TABLE, R1.DOC_TYPE, R1.DATE_OP, R1.DOC_NAME, R1.DOC_NUM, R1.ID_CONTRACTOR_TO,
	R1.CONTRACTOR_TO, R1.EX
ORDER BY CASE WHEN @SORT_DOC = 0 THEN NULL ELSE R1.DOC_NAME END, 
	CASE WHEN @SORT_DOC = 0 THEN R1.DATE_OP ELSE NULL END, 
	R1.CONTRACTOR_TO, R1.DATE_OP

--SELECT * FROM 
--(
SELECT
	T.ID_DOCUMENT,
	T.DOC_NAME,
	T.DATE_OP,
	T.DOC_NUM,
	T.SUM_DIS,
	T.SUM_DIS0,
	T.SUM_DIS10,
	T.SUM_DIS18,
	T.SUM_SUP,
	SUM_ACC = T.SUM_ACC + CASE WHEN @DIS = 1 THEN T.SUM_DIS ELSE 0 END,
	NAL = T.NAL + CASE WHEN @DIS = 1 THEN T.SUM_DIS ELSE 0 END,
	T.KOF,
	T.SUM_SVAT_SUP,
	SUM_SVAT_ACC = T.SUM_SVAT_ACC * CASE WHEN @DIS = 1 AND T.SUM_ACC > 0 
		THEN (T.SUM_ACC + CASE WHEN @DIS = 1 THEN T.SUM_DIS ELSE 0 END) / T.SUM_ACC
		ELSE 1 END,
	T.SUM_SUP0,
	T.SUM_SUP10,
	T.SUM_SUP18,
	SUM_ACC0 = T.SUM_ACC0 + CASE WHEN @DIS = 1 THEN T.SUM_DIS0 ELSE 0 END,
	SUM_ACC10 = T.SUM_ACC10 + CASE WHEN @DIS = 1 THEN T.SUM_DIS10 ELSE 0 END,
	SUM_ACC18 = T.SUM_ACC18 + CASE WHEN @DIS = 1 THEN T.SUM_DIS18 ELSE 0 END,
	T.SVAT_SUP10,
	T.SVAT_SUP18,
	SVAT_ACC10 = T.SVAT_ACC10 * CASE WHEN @DIS = 1 AND T.SUM_ACC10 > 0 
		THEN (T.SUM_ACC10 + CASE WHEN @DIS = 1 THEN T.SUM_DIS10 ELSE 0 END) / T.SUM_ACC10
		ELSE 1 END,
	SVAT_ACC18 = T.SVAT_ACC18 * CASE WHEN @DIS = 1 AND T.SUM_ACC18 > 0 
		THEN (T.SUM_ACC18 + CASE WHEN @DIS = 1 THEN T.SUM_DIS18 ELSE 0 END) / T.SUM_ACC18
		ELSE 1 END,
	T.ID_CONTRACTOR_TO,
	T.CONTRACTOR_TO,
	T.ID_TABLE,
	T.DOC_TYPE,
	T.EX
FROM #temp_t T
--WHERE T.EX = 0
--UNION ALL
--SELECT 
--	T.ID_DOCUMENT,
--	T.DOC_NAME,
--	T.DATE_OP,
--	T.DOC_NUM,
--	T.SUM_DIS,
--	T.SUM_DIS0,
--	T.SUM_DIS10,
--	T.SUM_DIS18,
--	T.SUM_SUP,
--	T.SUM_ACC,
--	T.NAL,
--	T.KOF,
--	T.SUM_SVAT_SUP,
--	T.SUM_SVAT_ACC,
--	T.SUM_SUP0,
--	T.SUM_SUP10,
--	T.SUM_SUP18,
--	T.SUM_ACC0,
--	T.SUM_ACC10,
--	T.SUM_ACC18,
--	T.SVAT_SUP10,
--	T.SVAT_SUP18,
--	T.SVAT_ACC10,
--	T.SVAT_ACC18,
--	T.EX
--FROM #temp_t T
--WHERE T.EX = 1
--) A

SELECT 
	SUM_DIS = SUM(SUM_DIS),
	SUM_DIS0 = SUM(SUM_DIS0),
	SUM_DIS10 = SUM(SUM_DIS10),
	SUM_DIS18 = SUM(SUM_DIS18)
FROM #temp_t

END
ELSE BEGIN
SELECT
    ID_DOCUMENT = CAST(NULL AS UNIQUEIDENTIFIER),
    DOC_NAME = CAST(NULL AS NVARCHAR(128)),
	DATE_OP = CAST(NULL AS DATETIME),
	DOC_NUM = CAST(NULL AS NVARCHAR(128)),
	SUM_DIS = CAST(NULL AS MONEY),
	SUM_DIS0 = CAST(NULL AS MONEY),
	SUM_DIS10 = CAST(NULL AS MONEY),
	SUM_DIS18 = CAST(NULL AS MONEY),
    SUM_SUP = CAST(NULL AS MONEY),
    SUM_ACC = CAST(NULL AS MONEY),
	KOF = CAST(NULL AS BIT),
	SUM_SVAT_SUP = CAST(NULL AS MONEY),
	SUM_SVAT_ACC = CAST(NULL AS MONEY),
	SUM_SUP0 = CAST(NULL AS MONEY),
	SUM_SUP10 = CAST(NULL AS MONEY),
	SUM_SUP18 = CAST(NULL AS MONEY),
	SUM_ACC0 = CAST(NULL AS MONEY),
	SUM_ACC10 = CAST(NULL AS MONEY),
	SUM_ACC18 = CAST(NULL AS MONEY),
    SVAT_SUP10 = CAST(NULL AS MONEY),
    SVAT_SUP18 = CAST(NULL AS MONEY),
    SVAT_ACC10 = CAST(NULL AS MONEY),
    SVAT_ACC18 = CAST(NULL AS MONEY),
    ID_CONTRACTOR_TO = CAST(NULL AS BIGINT),
	CONTRACTOR_TO = CAST(NULL AS NVARCHAR(128)),
	ID_TABLE = CAST(NULL AS BIGINT),
	DOC_TYPE = CAST(NULL AS NVARCHAR(128))
    
SELECT 
	SUM_DIS = NULL,
	SUM_DIS0 = NULL,
	SUM_DIS10 = NULL,
	SUM_DIS18 = NULL
END

DECLARE @STORES VARCHAR(1024)
DECLARE @CONTRACTORS VARCHAR(1024)

EXEC DBO.USP_TABLE_NAMES '#STORE', @STORES OUT
EXEC DBO.USP_TABLE_NAMES '#CONTRACTOR', @CONTRACTORS OUT
SELECT CONTRACTOR = @CONTRACTORS, STORE = @STORES

--Œ—“¿“Œ  Õ¿  ŒÕ≈÷
SELECT
    SUM_SUP = SUM(DM.SUM_SUP * DM.SIGN_OP),
    SUM_ACC = SUM(CASE WHEN ID_TABLE=19 AND CODE_OP='DIS' THEN -1 ELSE 1 END * DM.SUM_ACC * DM.SIGN_OP),
	NAL = SUM(CASE WHEN ID_TABLE=19 AND CODE_OP='DIS' THEN -1 ELSE 1 END * DM.SUM_ACC * DM.SIGN_OP - DM.SUM_SUP * DM.SIGN_OP),
    KOF = CASE WHEN MAX(CODE_OP) = 'DIS' THEN 0 ELSE 1 END,

    SUM_SVAT_SUP = SUM(DM.SVAT_SUP * DM.SIGN_OP),
    SUM_SVAT_ACC = SUM(CASE WHEN DM.ID_TABLE=19 AND CODE_OP='DIS' THEN -1 ELSE 1 END * DM.SVAT_ACC * DM.SIGN_OP),

    SUM_SUP0 = SUM(CASE WHEN DM.VAT_RATE_SAL = 0 THEN (DM.SUM_SUP * DM.SIGN_OP) ELSE 0 END),
    SUM_SUP10 = SUM(CASE WHEN DM.VAT_RATE_SAL = 10 THEN (DM.SUM_SUP * DM.SIGN_OP) ELSE 0 END),
    SUM_SUP18 = SUM(CASE WHEN DM.VAT_RATE_SAL = 18 THEN (DM.SUM_SUP * DM.SIGN_OP) ELSE 0 END),
    SUM_ACC0 = SUM(CASE WHEN DM.VAT_RATE_SAL = 0 THEN CASE WHEN DM.ID_TABLE=19 AND CODE_OP='DIS' THEN -1 ELSE 1 END * SUM_ACC * DM.SIGN_OP ELSE 0 END),
    SUM_ACC10 = SUM(CASE WHEN DM.VAT_RATE_SAL = 10 THEN CASE WHEN DM.ID_TABLE=19 AND CODE_OP='DIS' THEN -1 ELSE 1 END * SUM_ACC * DM.SIGN_OP ELSE 0 END),
    SUM_ACC18 = SUM(CASE WHEN DM.VAT_RATE_SAL = 18 THEN CASE WHEN DM.ID_TABLE=19 AND CODE_OP='DIS' THEN -1 ELSE 1 END * SUM_ACC * DM.SIGN_OP ELSE 0 END),

    SVAT_SUP10 = SUM(CASE WHEN DM.VAT_RATE_SAL = 10 THEN (DM.SVAT_SUP * DM.SIGN_OP) ELSE 0 END),
    SVAT_SUP18 = SUM(CASE WHEN DM.VAT_RATE_SAL = 18 THEN (DM.SVAT_SUP * DM.SIGN_OP) ELSE 0 END),
    SVAT_ACC10 = SUM(CASE WHEN DM.VAT_RATE_SAL = 10 THEN CASE WHEN DM.ID_TABLE=19 AND CODE_OP='DIS' THEN -1 ELSE 1 END * SVAT_ACC * DM.SIGN_OP ELSE 0 END),
    SVAT_ACC18 = SUM(CASE WHEN DM.VAT_RATE_SAL = 18 THEN CASE WHEN DM.ID_TABLE=19 AND CODE_OP='DIS' THEN -1 ELSE 1 END * SVAT_ACC * DM.SIGN_OP ELSE 0 END)
    --,
    
    --SUM_DIS = SUM(CASE WHEN DM.CODE_OP='DIS' AND DM.ID_TABLE=19 THEN DM.SUM_ACC * DM.SIGN_OP WHEN DM.CODE_OP='DIS' AND DM.ID_TABLE<>19 THEN DM.SUM_ACC ELSE 0 END),
	--SUM_DIS0 = SUM(CASE WHEN DM.VAT_RATE_SAL = 0 THEN CASE WHEN DM.CODE_OP='DIS' AND DM.ID_TABLE=19 THEN DM.SUM_ACC * DM.SIGN_OP WHEN DM.CODE_OP='DIS' AND DM.ID_TABLE<>19 THEN DM.SUM_ACC ELSE 0 END ELSE 0 END),
	--SUM_DIS10 = SUM(CASE WHEN DM.VAT_RATE_SAL = 10 THEN CASE WHEN DM.CODE_OP='DIS' AND DM.ID_TABLE=19 THEN DM.SUM_ACC * DM.SIGN_OP WHEN DM.CODE_OP='DIS' AND DM.ID_TABLE<>19 THEN DM.SUM_ACC ELSE 0 END ELSE 0 END),
	--SUM_DIS18 = SUM(CASE WHEN DM.VAT_RATE_SAL = 18 THEN CASE WHEN DM.CODE_OP='DIS' AND DM.ID_TABLE=19 THEN DM.SUM_ACC * DM.SIGN_OP WHEN DM.CODE_OP='DIS' AND DM.ID_TABLE<>19 THEN DM.SUM_ACC ELSE 0 END ELSE 0 END)
--INTO #RESTS
FROM DOC_MOVEMENT DM
WHERE DATE_OP <= @DATE_TO
	AND DM.ID_STORE IN (SELECT ID_STORE FROM #STORE)

/*SELECT 
	SUM_SUP,
	SUM_ACC = SUM_ACC + CASE WHEN @DIS = 1 THEN SUM_DIS ELSE 0 END,
	NAL = NAL + CASE WHEN @DIS = 1 THEN NAL ELSE 0 END,
	KOF,
	
	SUM_SVAT_SUP,
	SUM_SVAT_ACC = SUM_SVAT_ACC * CASE WHEN @DIS = 1 AND SUM_ACC > 0 
		THEN (SUM_ACC + CASE WHEN @DIS = 1 THEN SUM_DIS ELSE 0 END) / SUM_ACC
		ELSE 1 END,
	
	SUM_SUP0,
	SUM_SUP10,
	SUM_SUP18,
	SUM_ACC0 = SUM_ACC0 + CASE WHEN @DIS = 1 THEN SUM_DIS0 ELSE 0 END,
	SUM_ACC10 = SUM_ACC10 + CASE WHEN @DIS = 1 THEN SUM_DIS10 ELSE 0 END,
	SUM_ACC18 = SUM_ACC18 + CASE WHEN @DIS = 1 THEN SUM_DIS18 ELSE 0 END,
	
	SVAT_SUP10,
	SVAT_SUP18,
	SVAT_ACC10 = SVAT_ACC10 * CASE WHEN @DIS = 1 AND SUM_ACC10 > 0 
		THEN (SUM_ACC10 + CASE WHEN @DIS = 1 THEN SUM_DIS10 ELSE 0 END) / SUM_ACC10
		ELSE 1 END,
	SVAT_ACC18 = SVAT_ACC18 * CASE WHEN @DIS = 1 AND SUM_ACC18 > 0 
		THEN (SUM_ACC18 + CASE WHEN @DIS = 1 THEN SUM_DIS18 ELSE 0 END) / SUM_ACC18
		ELSE 1 END
FROM #RESTS*/

IF(@SHOW_SUB = 1)
BEGIN
SELECT
	SUM_ACC = SUM(SUM_ACC + CASE WHEN @DIS = 1 THEN SUM_DIS ELSE 0 END),
	SUM_ACC0 = SUM(SUM_ACC0 + CASE WHEN @DIS = 1 THEN SUM_DIS0 ELSE 0 END),
	SUM_ACC10 = SUM(SUM_ACC10 + CASE WHEN @DIS = 1 THEN SUM_DIS10 ELSE 0 END),
	SUM_ACC18 = SUM(SUM_ACC18 + CASE WHEN @DIS = 1 THEN SUM_DIS18 ELSE 0 END),
	SUM_VAT = SUM(SUM_SVAT_ACC * CASE WHEN @DIS = 1 AND SUM_ACC > 0 
		THEN (SUM_ACC + CASE WHEN @DIS = 1 THEN SUM_DIS ELSE 0 END) / SUM_ACC
		ELSE 1 END),
	SVAT_ACC10 = SUM(SVAT_ACC10 * CASE WHEN @DIS = 1 AND SUM_ACC10 > 0 
		THEN (SUM_ACC10 + CASE WHEN @DIS = 1 THEN SUM_DIS10 ELSE 0 END) / SUM_ACC10
		ELSE 1 END),
	SVAT_ACC18 = SUM(SVAT_ACC18 * CASE WHEN @DIS = 1 AND SUM_ACC18 > 0 
		THEN (SUM_ACC18 + CASE WHEN @DIS = 1 THEN SUM_DIS18 ELSE 0 END) / SUM_ACC18
		ELSE 1 END)
FROM #temp_t where EX = 1
END ELSE
BEGIN
SELECT
	SUM_ACC = NULL,
	SUM_ACC0 = NULL,
	SUM_ACC10 = NULL,
	SUM_ACC18 = NULL,
	SUM_VAT = NULL,
	SVAT_ACC10 = NULL,
	SVAT_ACC18 = NULL
END

RETURN 0
GO

/*

exec REP_GOODS_REPORTS_TO_EX_SERVICE_SAL N'
<XML>
	<DATE_FR>2010-06-28T00:00:00.000</DATE_FR>
	<DATE_TO>2011-07-25T00:00:00.000</DATE_TO>
	<SHOW_ADD>1</SHOW_ADD>
	<SHOW_SUB>1</SHOW_SUB>
	<SORT_DOC>1</SORT_DOC>
	<ID_CONTRACTOR>5271</ID_CONTRACTOR>
	<NOAU>1</NOAU>		
</XML>'
*/





SET NOCOUNT ON
SET QUOTED_IDENTIFIER OFF
GO 

IF OBJECT_ID('DBO.REMOVE_REPORT_BY_TYPE_NAME') IS NULL EXEC('CREATE PROCEDURE DBO.REMOVE_REPORT_BY_TYPE_NAME AS RETURN')
GO
ALTER PROCEDURE DBO.REMOVE_REPORT_BY_TYPE_NAME 
	@REPORT_TYPE_NAME VARCHAR(200) AS
	
DECLARE @id_meta_report BIGINT

	select 
		@id_meta_report = id_meta_report
	from meta_report
	where type_name = @REPORT_TYPE_NAME
	--select @id_meta_report
		
	DECLARE @SQL NVARCHAR(200)
	SET @SQL = N'delete from META_REPORT_2_REPORT_GROUPS
				where id_meta_report = @id_meta_report'
	IF (OBJECT_ID('META_REPORT_2_REPORT_GROUPS') IS NOT NULL)
		EXEC SP_EXECUTESQL @SQL, N'@id_meta_report BIGINT', @id_meta_report=@id_meta_report
		

	SET @SQL = N'delete from meta_report_settings_csv_export
		where id_meta_report = @id_meta_report'
	IF (OBJECT_ID('meta_report_settings_csv_export') IS NOT NULL)
		EXEC SP_EXECUTESQL @SQL, N'@id_meta_report BIGINT', @id_meta_report=@id_meta_report
		

	SET @SQL = N'delete from meta_report_settings_visible
		where id_meta_report = @id_meta_report'
	IF (OBJECT_ID('meta_report_settings_visible') IS NOT NULL)
		EXEC SP_EXECUTESQL @SQL, N'@id_meta_report BIGINT', @id_meta_report=@id_meta_report
		

	SET @SQL = N'delete from meta_report_settings_managed
				where id_meta_report = @id_meta_report'
	IF (OBJECT_ID('meta_report_settings_managed') IS NOT NULL)
		EXEC SP_EXECUTESQL @SQL, N'@id_meta_report BIGINT', @id_meta_report=@id_meta_report


	SET @SQL = N'delete from meta_report_settings_archive
				where id_meta_report = @id_meta_report'
	IF (OBJECT_ID('meta_report_settings_archive') IS NOT NULL)
		EXEC SP_EXECUTESQL @SQL, N'@id_meta_report BIGINT', @id_meta_report=@id_meta_report


	delete from meta_report
	where id_meta_report = @id_meta_report

RETURN 0
GO

EXEC DBO.REMOVE_REPORT_BY_TYPE_NAME 'GoodsReportsTaxGroups.TaxGroupsParams'