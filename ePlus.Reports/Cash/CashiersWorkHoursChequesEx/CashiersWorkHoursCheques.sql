SET NOCOUNT ON
SET QUOTED_IDENTIFIER OFF
SET DATEFORMAT DMY 
GO

IF OBJECT_ID('DBO.REPEX_CASHIERS_WORK_HOURS_CHEQUES') IS NULL EXEC('CREATE PROCEDURE DBO.REPEX_CASHIERS_WORK_HOURS_CHEQUES AS RETURN')
GO
ALTER  PROCEDURE DBO.REPEX_CASHIERS_WORK_HOURS_CHEQUES
    @XMLPARAM NTEXT AS
    
DECLARE @HDOC INT
DECLARE @DATE_FR DATETIME
DECLARE @DATE_TO DATETIME
DECLARE @CO BIT

DECLARE @ALL_USER_CODES BIT
DECLARE @ALL_DRUGSTORES BIT

DECLARE @CONTRACTORS VARCHAR(2048)

EXEC SP_XML_PREPAREDOCUMENT @HDOC OUT, @XMLPARAM

SELECT
	@DATE_FR = DATE_FR,
	@DATE_TO = DATE_TO,	
	@CO = CO
FROM OPENXML(@HDOC, '/XML') WITH(
	DATE_FR DATETIME 'DATE_FR',
	DATE_TO DATETIME 'DATE_TO', 
	CO BIT 'CO'
)

SELECT * INTO #USER_CODES FROM OPENXML(@HDOC, '/XML/USER_CODE') WITH(USER_CODE UNIQUEIDENTIFIER '.')
IF (@@ROWCOUNT = 0)	SET @ALL_USER_CODES = 1

SELECT * INTO #GUID_CONTRACTORS FROM OPENXML(@HDOC, '/XML/GUID_CONTRACTOR') WITH(GUID_CONTRACTOR UNIQUEIDENTIFIER '.')
IF (@@ROWCOUNT = 0)	SET @ALL_DRUGSTORES = 1

EXEC SP_XML_REMOVEDOCUMENT @HDOC

EXEC USP_RANGE_DAYS @DATE_FR OUT, @DATE_TO OUT
EXEC USP_RANGE_NORM @DATE_FR OUT, @DATE_TO OUT

SELECT 
	U.ID_USER, 
    US_NAME = ISNULL(U.FULL_NAME, NAME),
	CS = CASE WHEN CH.CHEQUE_TYPE='SALE' THEN 1 
                   ELSE -1
              END, 
    DATETIME_CHEQUE = CH.DATE_CHEQUE,
	DATE_CHEQUE = DATEADD(dd, 0, DATEDIFF(dd, 0, CH.DATE_CHEQUE)),
    SUMM = CH.SUMM, 
    CR.ID_CONTRACTOR, 
    CH.ID_USER_DATA
INTO #CHEQUE_INFO    
FROM CHEQUE CH
INNER JOIN CASH_SESSION CS ON CH.ID_CASH_SESSION_GLOBAL = CS.ID_CASH_SESSION_GLOBAL
INNER JOIN CASH_REGISTER CR ON CS.ID_CASH_REGISTER = CR.ID_CASH_REGISTER
LEFT JOIN [META_USER] U ON CH.ID_USER_DATA = U.USER_NUM
WHERE 
	(
	(CR.ID_CONTRACTOR = (SELECT TOP 1 ID_CONTRACTOR FROM ENTERPRISE_BRANCH WHERE IS_SELF = 1) AND (@CO IS NULL OR @CO = 0))
		OR 
	(@CO = 1 AND 
		(CR.ID_CONTRACTOR IN (SELECT C.ID_CONTRACTOR FROM CONTRACTOR C 
			WHERE C.ID_CONTRACTOR_GLOBAL IN (SELECT GC.GUID_CONTRACTOR FROM #GUID_CONTRACTORS GC)) 
			OR @ALL_DRUGSTORES = 1))
	)
	AND CH.DATE_CHEQUE BETWEEN @DATE_FR AND @DATE_TO 
	AND (@ALL_USER_CODES = 1 OR (U.ID_USER IN (SELECT USER_CODE FROM #USER_CODES)))
   
SELECT  
	CI.ID_CONTRACTOR, 
	CNAME = C.NAME, 
	DATE_CHEQUE = CI.DATE_CHEQUE, 
	CI.ID_USER,
	CI.US_NAME,  
	QUANTITY = ISNULL(SUM(CI.CS), 0), 
	DAY_SUMM = ISNULL(SUM(CI.SUMM * CI.CS), 0), 
	SUM_CH_1 = ISNULL(SUM(CASE WHEN DATEPART(hh,CI.DATETIME_CHEQUE)=1 THEN CI.CS ELSE NULL END),0),
    SUM_CH_2 = ISNULL(SUM(CASE WHEN DATEPART(hh,CI.DATETIME_CHEQUE)=2 THEN CI.CS ELSE NULL END),0),
    SUM_CH_3 = ISNULL(SUM(CASE WHEN DATEPART(hh,CI.DATETIME_CHEQUE)=3 THEN CI.CS ELSE NULL END),0),
    SUM_CH_4 = ISNULL(SUM(CASE WHEN DATEPART(hh,CI.DATETIME_CHEQUE)=4 THEN CI.CS ELSE NULL END),0),
    SUM_CH_5 = ISNULL(SUM(CASE WHEN DATEPART(hh,CI.DATETIME_CHEQUE)=5 THEN CI.CS ELSE NULL END),0),
    SUM_CH_6 = ISNULL(SUM(CASE WHEN DATEPART(hh,CI.DATETIME_CHEQUE)=6 THEN CI.CS ELSE NULL END),0),
    SUM_CH_7 = ISNULL(SUM(CASE WHEN DATEPART(hh,CI.DATETIME_CHEQUE)=7 THEN CI.CS ELSE NULL END),0),
    SUM_CH_8 = ISNULL(SUM(CASE WHEN DATEPART(hh,CI.DATETIME_CHEQUE)=8 THEN CI.CS ELSE NULL END),0),
    SUM_CH_9 = ISNULL(SUM(CASE WHEN DATEPART(hh,CI.DATETIME_CHEQUE)=9 THEN CI.CS ELSE NULL END),0),
    SUM_CH_10 = ISNULL(SUM(CASE WHEN DATEPART(hh,CI.DATETIME_CHEQUE)=10 THEN CI.CS ELSE NULL END),0),
    SUM_CH_11 = ISNULL(SUM(CASE WHEN DATEPART(hh,CI.DATETIME_CHEQUE)=11 THEN CI.CS ELSE NULL END),0),
    SUM_CH_12 = ISNULL(SUM(CASE WHEN DATEPART(hh,CI.DATETIME_CHEQUE)=12 THEN CI.CS ELSE NULL END),0),
    SUM_CH_13 = ISNULL(SUM(CASE WHEN DATEPART(hh,CI.DATETIME_CHEQUE)=13 THEN CI.CS ELSE NULL END),0),
    SUM_CH_14 = ISNULL(SUM(CASE WHEN DATEPART(hh,CI.DATETIME_CHEQUE)=14 THEN CI.CS ELSE NULL END),0),
    SUM_CH_15 = ISNULL(SUM(CASE WHEN DATEPART(hh,CI.DATETIME_CHEQUE)=15 THEN CI.CS ELSE NULL END),0),
    SUM_CH_16 = ISNULL(SUM(CASE WHEN DATEPART(hh,CI.DATETIME_CHEQUE)=16 THEN CI.CS ELSE NULL END),0),
    SUM_CH_17 = ISNULL(SUM(CASE WHEN DATEPART(hh,CI.DATETIME_CHEQUE)=17 THEN CI.CS ELSE NULL END),0),
    SUM_CH_18 = ISNULL(SUM(CASE WHEN DATEPART(hh,CI.DATETIME_CHEQUE)=18 THEN CI.CS ELSE NULL END),0),
    SUM_CH_19 = ISNULL(SUM(CASE WHEN DATEPART(hh,CI.DATETIME_CHEQUE)=19 THEN CI.CS ELSE NULL END),0),
    SUM_CH_20 = ISNULL(SUM(CASE WHEN DATEPART(hh,CI.DATETIME_CHEQUE)=20 THEN CI.CS ELSE NULL END),0),
    SUM_CH_21 = ISNULL(SUM(CASE WHEN DATEPART(hh,CI.DATETIME_CHEQUE)=21 THEN CI.CS ELSE NULL END),0),
    SUM_CH_22 = ISNULL(SUM(CASE WHEN DATEPART(hh,CI.DATETIME_CHEQUE)=22 THEN CI.CS ELSE NULL END),0),
    SUM_CH_23 = ISNULL(SUM(CASE WHEN DATEPART(hh,CI.DATETIME_CHEQUE)=23 THEN CI.CS ELSE NULL END),0),
    SUM_CH_24 = ISNULL(SUM(CASE WHEN DATEPART(hh,CI.DATETIME_CHEQUE)=0 THEN CI.CS ELSE NULL END),0)
FROM #CHEQUE_INFO CI
INNER JOIN CONTRACTOR C ON CI.ID_CONTRACTOR = C.ID_CONTRACTOR
GROUP BY CI.DATE_CHEQUE, CI.ID_USER, CI.US_NAME, 
	CI.ID_USER_DATA, CI.ID_CONTRACTOR, C.NAME
ORDER BY C.NAME, CI.DATE_CHEQUE, CI.US_NAME

DECLARE @ID_CONTRACTOR BIGINT
DECLARE [CI$CURSOR] CURSOR LOCAL FAST_FORWARD
		FOR SELECT DISTINCT
			[CI].ID_CONTRACTOR 
		FROM #CHEQUE_INFO CI
		ORDER BY CI.ID_CONTRACTOR
OPEN [CI$CURSOR]
WHILE (1=1)
BEGIN
	FETCH NEXT FROM [CI$CURSOR] INTO @ID_CONTRACTOR
	IF @@fetch_status=-1 
      BREAK
	IF @@fetch_status=-2
      CONTINUE
    SET @CONTRACTORS = ''
    SELECT 
		@CONTRACTORS = 
			CASE WHEN (@CONTRACTORS IS NULL OR @CONTRACTORS = '') THEN  
				C.NAME
			ELSE 
				@CONTRACTORS + ', ' + C.NAME
			END
	FROM (SELECT DISTINCT ID_CONTRACTOR FROM #CHEQUE_INFO) T
	INNER JOIN CONTRACTOR C ON C.ID_CONTRACTOR = T.ID_CONTRACTOR
	ORDER BY T.ID_CONTRACTOR
END
	CLOSE [CI$CURSOR]
	DEALLOCATE [CI$CURSOR]
	
SELECT CONTRACTORS = @CONTRACTORS

RETURN
GO

/*
EXEC REPEX_CASHIERS_WORK_HOURS_CHEQUES N'
<XML>
	<DATE_FR>2009-06-26T00:00:00.000</DATE_FR>
	<DATE_TO>2009-06-29T00:00:00.000</DATE_TO>
	<CO>1</CO>
</XML>'*/

/*
EXEC REPEX_CASHIERS_WORK_HOURS_CHEQUES N'
<XML>
	<DATE_FR>2010-01-01T18:46:55.593</DATE_FR>
	<DATE_TO>2010-10-29T18:46:55.593</DATE_TO>
	<GUID_CONTRACTOR>c2125625-cfa9-4b00-90e3-d0813f10d1b7</GUID_CONTRACTOR>
	<USER_CODE>0e04c478-7c2a-4005-bae5-66f6ab03afd6</USER_CODE>
	<CO>1</CO>
</XML>'*/
