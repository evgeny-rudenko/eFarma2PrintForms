/****** Object:  StoredProcedure [dbo].[UDP_REPEX_COURIER_SERVICE_SAV]    Script Date: 08/25/2014 11:35:06 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROCEDURE [dbo].[UDP_REPEX_COURIER_SERVICE_SAV]
    @XMLPARAM NTEXT
AS

DECLARE @HDOC INT
DECLARE @DATE_REP DATETIME
DECLARE @RTYPE BIT
DECLARE @STRIPPEDDATE  DATETIME
DECLARE @STRIPPEDDATE1 DATETIME
DECLARE @DELIVERY_SERVICE INT

EXEC SP_XML_PREPAREDOCUMENT @HDOC OUTPUT, @XMLPARAM OUTPUT
    SELECT 
        @DATE_REP = DATE_REP,
        @RTYPE = RTYPE,
		@DELIVERY_SERVICE = DELIVERY_SERVICE        
    FROM OPENXML(@HDOC, '/XML') 
    WITH(
        DATE_REP DATETIME 'DATE_REP',        
        RTYPE BIT 'RTYPE',
		DELIVERY_SERVICE INT 'DELIVERY_SERVICE'
		)

EXEC SP_XML_REMOVEDOCUMENT @HDOC

SET @strippedDate = DATENAME(day, @DATE_REP) + '.' + DATENAME(month, @DATE_REP) + '.' + DATENAME(year, @DATE_REP) + ' ' + 
            '00:00:00' 
SET @strippedDate1 = DATENAME(day, @DATE_REP) + '.' + DATENAME(month, @DATE_REP) + '.' + DATENAME(year, @DATE_REP) + ' ' + 
            '23:59:59' 

-- Формируем временную таблицу чеков
SELECT ID_DOCUMENT_BASE_GLOBAL, SUMM, KKM_CHEQUE_NUMBER 
INTO #CHEQUE FROM DBO.CHEQUE WHERE DATE_CHEQUE >= (@DATE_REP - 100)

-- Курьерская служба cdl
IF (@DELIVERY_SERVICE = 0)
BEGIN

	IF (@RTYPE = 1)
	BEGIN

	---------------------------------------------------------
	---------------------------------------------------------
	---- Автоматическая смена статуса интернет-заказов ------
	---- которые соответсвуют по номеру и по сумме с   ------
	---- с курьерской службой                          ------
	---------------------------------------------------------

	UPDATE INTERNET_ORDER 
	SET ID_INTERNET_ORDER_STATE_GLOBAL = IOS.ID_INTERNET_ORDER_STATE_GLOBAL 
	FROM INTERNET_ORDER IOR, INTERNET_ORDER_STATE IOS 
	WHERE ID_INTERNET_ORDER_GLOBAL IN
	(SELECT IOR.ID_INTERNET_ORDER_GLOBAL
	FROM UDT_REPEX_INTERNET_ORDER_CS_MONEY IOCS
	INNER JOIN INTERNET_ORDER IOR ON IOR.NUMBER_DOC = CONVERT(VARCHAR,IOCS.ORDER_NUMBER)
	INNER JOIN #CHEQUE CH ON IOR.ID_INTERNET_ORDER_GLOBAL = CH.ID_DOCUMENT_BASE_GLOBAL 		  
		  AND CH.SUMM = ISNULL(IOCS.SUMMA, 0)
	WHERE IOCS.ORDER_STATUS = 'Исполнен') AND IOS.NAME = 'Выполнен' AND 
			IOR.ID_INTERNET_ORDER_STATE_GLOBAL <> IOS.ID_INTERNET_ORDER_STATE_GLOBAL

	END

		SELECT        
		   DATE_REPORT = IOCS.DATE_REPORT,
		   ORDER_NUMBER = ISNULL(IOCS.ORDER_NUMBER,0), 
		   SUMMA = ISNULL(IOCS.SUMMA,0),  
		   SUMMA_CHEQUE = T1.SUMM, 
		   KKM_CHEQUE_NUMBER = T1.KKM_CHEQUE_NUMBER,  
		   ORDER_STATUS = ISNULL(IOCS.ORDER_STATUS,''),
		   ORDER_STATUS_EF = T1.NAME,
		   NUMBER_DOC = T1.NUMBER_DOC,
		   DATE_CREATE = T1.DATE_CREATE 
	FROM (SELECT * FROM UDT_REPEX_INTERNET_ORDER_CS_MONEY WHERE DATE_REPORT BETWEEN @STRIPPEDDATE AND @STRIPPEDDATE1 ) AS IOCS
	FULL JOIN
		(SELECT 
			IOR.ID_INTERNET_ORDER_GLOBAL,
			IOR.DATE_CREATE, 
			IOR.NUMBER_DOC, 
			CH.SUMM, 
			CH.KKM_CHEQUE_NUMBER,
			IOS.NAME
		FROM INTERNET_ORDER IOR
		INNER JOIN #CHEQUE CH ON IOR.ID_INTERNET_ORDER_GLOBAL = CH.ID_DOCUMENT_BASE_GLOBAL
		LEFT JOIN INTERNET_ORDER_STATE IOS ON IOS.ID_INTERNET_ORDER_STATE_GLOBAL = IOR.ID_INTERNET_ORDER_STATE_GLOBAL
		)T1 ON CONVERT(VARCHAR,IOCS.ORDER_NUMBER) =  T1.NUMBER_DOC 
	ORDER BY 1,6,2

END

-- Курьерская служба allianz
IF (@DELIVERY_SERVICE = 1)
BEGIN

	IF (@RTYPE = 1)
	BEGIN

	---------------------------------------------------------
	---------------------------------------------------------
	---- Автоматическая смена статуса интернет-заказов ------
	---- которые соответсвуют по номеру и по сумме с   ------
	---- с курьерской службой                          ------
	---------------------------------------------------------

	UPDATE INTERNET_ORDER 		
	SET ID_INTERNET_ORDER_STATE_GLOBAL = IOS.ID_INTERNET_ORDER_STATE_GLOBAL 
	FROM DBO.INTERNET_ORDER IOR, DBO.INTERNET_ORDER_STATE IOS 
	WHERE ID_INTERNET_ORDER_GLOBAL IN
	(SELECT IOR.ID_INTERNET_ORDER_GLOBAL
	FROM DBO.UDT_IO_TO_ALLIANZ IOCS
	INNER JOIN DBO.INTERNET_ORDER IOR ON IOR.NUMBER_DOC = CONVERT(VARCHAR,IOCS.ORDER_ID)
	INNER JOIN #CHEQUE CH ON IOR.ID_INTERNET_ORDER_GLOBAL = CH.ID_DOCUMENT_BASE_GLOBAL 		  
		  AND CH.SUMM = ISNULL(IOCS.PAID, 0)
	WHERE IOCS.STATE = 'Доставлена') AND IOS.NAME = 'Выполнен' AND 
			IOR.ID_INTERNET_ORDER_STATE_GLOBAL <> IOS.ID_INTERNET_ORDER_STATE_GLOBAL AND
			IOR.DELIVERY_DATE >= @STRIPPEDDATE and IOR.DELIVERY_DATE  < @STRIPPEDDATE1

	END

	SELECT        
			   DATE_REPORT = IOCS.DELIVERY_DATE,   
			   ORDER_NUMBER = ISNULL(IOCS.ORDER_ID,0), 
			   SUMMA = ISNULL(IOCS.PAID,0),  
			   SUMMA_CHEQUE = T1.SUMM, 
			   KKM_CHEQUE_NUMBER = T1.KKM_CHEQUE_NUMBER,  
			   ORDER_STATUS =  case when ISNULL(IOCS.STATE,'') = 'Доставлена' then 'Исполнен' end,
			   ORDER_STATUS_EF = T1.NAME,
			   NUMBER_DOC = T1.NUMBER_DOC,
			   DATE_CREATE = T1.DATE_CREATE  
		FROM (	
		SELECT ORDER_ID, DELIVERY_DATE, PAID, STATE FROM DBO.UDT_IO_TO_ALLIANZ ) IOCS
		FULL JOIN
			(SELECT 
				IOR.ID_INTERNET_ORDER_GLOBAL,
				IOR.DATE_CREATE, 
				IOR.NUMBER_DOC, 
				CH.SUMM, 
				CH.KKM_CHEQUE_NUMBER,
				IOS.NAME
			FROM DBO.INTERNET_ORDER IOR
			INNER JOIN #CHEQUE CH ON IOR.ID_INTERNET_ORDER_GLOBAL = CH.ID_DOCUMENT_BASE_GLOBAL
			LEFT JOIN DBO.INTERNET_ORDER_STATE IOS ON IOS.ID_INTERNET_ORDER_STATE_GLOBAL = IOR.ID_INTERNET_ORDER_STATE_GLOBAL			
			WHERE IOR.DELIVERY_DATE >= @STRIPPEDDATE and IOR.DELIVERY_DATE  < @STRIPPEDDATE1
			)T1 ON CONVERT(VARCHAR,IOCS.ORDER_ID) =  T1.NUMBER_DOC 
		ORDER BY 1,6,2

END


RETURN


/*
exec UDP_REPEX_COURIER_SERVICE_SAV 
@XMLPARAM=
'<XML>
    <DATE_REP>2014-09-08T12:34:13</DATE_REP>
	<DELIVERY_SERVICE>allianz</DELIVERY_SERVICE>
    <RTYPE>1</RTYPE>	
</XML>'
*/
