SET NOCOUNT ON
SET QUOTED_IDENTIFIER OFF
GO

IF OBJECT_ID('DBO.REPEX_GOODS_REGISTRY') IS NULL EXEC('CREATE PROCEDURE DBO.REPEX_GOODS_REGISTRY AS RETURN')
GO

ALTER PROCEDURE DBO.REPEX_GOODS_REGISTRY
    @XMLPARAM NTEXT AS

DECLARE @HDOC INT
DECLARE @DATE_FR DATETIME
DECLARE @DATE_TO DATETIME
DECLARE @DATE_SH_FR DATETIME
DECLARE @DATE_SH_TO DATETIME
DECLARE @SHORT BIT
DECLARE @ALL_CONTRACTOR BIT
DECLARE @ALL_STORE BIT
DECLARE @ALL_INS BIT
DECLARE @ALL_LGOT BIT
DECLARE @ALL_GOODS BIT
DECLARE @ALL_LPU BIT

EXEC SP_XML_PREPAREDOCUMENT @HDOC OUT, @XMLPARAM
SELECT
	@DATE_FR = DATE_FR,
	@DATE_TO = DATE_TO,
	@DATE_SH_FR = DATE_SH_FR,
	@DATE_SH_TO = DATE_SH_TO,
	@SHORT = SHORT
FROM OPENXML(@HDOC, '/XML') WITH(
	DATE_FR DATETIME 'DATE_FR',
	DATE_TO DATETIME 'DATE_TO',
	DATE_SH_FR DATETIME 'DATE_SH_FR',
	DATE_SH_TO DATETIME 'DATE_SH_TO',
	SHORT BIT 'SHORT'
)

SELECT * INTO #CONTRACTOR FROM OPENXML(@HDOC, '//ID_CONTRACTOR') 
WITH(ID_CONTRACTOR BIGINT '.')
IF @@ROWCOUNT = 0 SET @ALL_CONTRACTOR = 1

SELECT * INTO #STORE FROM OPENXML(@HDOC, '//ID_STORE') 
WITH(ID_STORE BIGINT '.')
IF @@ROWCOUNT = 0 SET @ALL_STORE = 1

SELECT * INTO #INS FROM OPENXML(@HDOC, '//ID_INS') 
WITH(ID_INS UNIQUEIDENTIFIER '.')
IF @@ROWCOUNT = 0 SET @ALL_INS = 1;

SELECT * INTO #GOODS FROM OPENXML(@HDOC, '//ID_GOODS') 
WITH(ID_GOODS BIGINT '.')
IF @@ROWCOUNT = 0 SET @ALL_GOODS = 1;

SELECT * INTO #LPU FROM OPENXML(@HDOC, '//ID_LPU') 
WITH(ID_LPU BIGINT '.')
IF @@ROWCOUNT = 0 SET @ALL_LPU = 1;

SELECT * INTO #LGOT FROM OPENXML(@HDOC, '//ID_LGOT') 
WITH(ID_LGOT UNIQUEIDENTIFIER '.')
IF @@ROWCOUNT = 0 SET @ALL_LGOT = 1


EXEC SP_XML_REMOVEDOCUMENT @HDOC

EXEC USP_RANGE_NORM @DATE_FR OUT, @DATE_TO OUT
EXEC USP_RANGE_DAYS @DATE_FR OUT, @DATE_TO OUT

EXEC USP_RANGE_NORM @DATE_SH_FR OUT, @DATE_SH_TO OUT
EXEC USP_RANGE_DAYS @DATE_SH_FR OUT, @DATE_SH_TO OUT

SELECT *
into #temp_t
FROM 
(
SELECT 
	MEMBER_NAME = ISNULL(DM.LASTNAME + ' ', '') + ISNULL(DM.FIRSTNAME + ' ', '') + ISNULL(DM.MIDDLENAME, ''),
	NUMBER_RECIPE = isnull(TL.SERIES_RECIPE + ' ', '') + TL.NUMBER_RECIPE,
	DATE_CHEQUE = CH.DATE_CHEQUE,
	GOODS_NAME = G.NAME,
	QUANTITY = CHI.QUANTITY * CONVERT(MONEY,SR.NUMERATOR) / CONVERT(MONEY, SR.DENOMINATOR),
	PRICE = CHI.PRICE * CONVERT(MONEY,SR.DENOMINATOR) / CONVERT(MONEY, SR.NUMERATOR),
	SUMM = ISNULL(ISNULL((SELECT TOP 1 SUMM FROM CHEQUE_PAYMENT WHERE ID_CHEQUE_GLOBAL = CH.ID_CHEQUE_GLOBAL AND  TYPE_PAYMENT/*SEPARATE_TYPE*/ = 'TYPE4'),(SELECT TOP 1 SUMM FROM CHEQUE_PAYMENT WHERE ID_CHEQUE_GLOBAL = CH.ID_CHEQUE_GLOBAL AND  /*TYPE_PAYMENT*/SEPARATE_TYPE = 'TYPE4')) * CHI.SUMM / CH.SUMM, 0),
	INSURANCE_COMPANY = IC.NAME

FROM TRUST_LETTER TL
	LEFT JOIN DISCOUNT2_DOCTOR ON DISCOUNT2_DOCTOR.ID_DOCTOR = TL.ID_DISCOUNT2_DOCTOR
	LEFT JOIN CHEQUE CH ON CH.ID_CHEQUE_GLOBAL = TL.ID_TRUST_LETTER_GLOBAL		
	LEFT JOIN CHEQUE_ITEM CHI ON CHI.ID_CHEQUE_GLOBAL = TL.ID_TRUST_LETTER_GLOBAL
	LEFT JOIN GOODS G ON CHI.ID_GOODS = G.ID_GOODS
	LEFT JOIN DISCOUNT2_INSURANCE_COMPANY IC ON IC.ID_DISCOUNT2_INSURANCE_COMPANY_GLOBAL = TL.ID_DISCOUNT2_INSURANCE_COMPANY_GLOBAL
	LEFT JOIN DISCOUNT2_MEMBER DM ON DM.ID_DISCOUNT2_MEMBER_GLOBAL = TL.ID_DISCOUNT2_MEMBER_GLOBAL
	LEFT JOIN LOT L ON L.ID_LOT_GLOBAL = CHI.ID_LOT_GLOBAL
	LEFT JOIN SCALING_RATIO SR ON SR.ID_SCALING_RATIO = L.ID_SCALING_RATIO
	LEFT JOIN STORE ST ON ST.ID_STORE = L.ID_STORE
	LEFT JOIN DISCOUNT2_MEDICAL_ORGANIZATION MO ON MO.ID_DISCOUNT2_MEDICAL_ORGANIZATION = TL.ID_DISCOUNT2_MEDICAL_ORGANIZATION
WHERE 1 = 1
	AND DATE_CHEQUE BETWEEN @DATE_FR AND @DATE_TO
	AND ISNULL(TL.DATE_SHIP,DATE_CHEQUE) BETWEEN @DATE_SH_FR AND @DATE_SH_TO 
	AND (@ALL_GOODS = 1 OR G.ID_GOODS IN (SELECT ID_GOODS FROM #GOODS))
	AND (@ALL_CONTRACTOR = 1 OR ST.ID_CONTRACTOR IN (SELECT ID_CONTRACTOR FROM #CONTRACTOR))
	AND (@ALL_STORE = 1 OR ST.ID_STORE IN (SELECT ID_STORE FROM #STORE))
	AND (@ALL_INS = 1 OR IC.ID_DISCOUNT2_INSURANCE_COMPANY_GLOBAL IN (SELECT ID_INS FROM #INS))
	AND (@ALL_LPU = 1 OR TL.ID_DISCOUNT2_MEDICAL_ORGANIZATION IN (SELECT ID_LPU FROM #LPU))
	AND (@ALL_LGOT = 1 OR TL.ID_DISCOUNT2_CAT_LGOT_GLOBAL IN (SELECT ID_LGOT FROM #LGOT))
	AND (NOT EXISTS (SELECT * FROM CHEQUE rch
		WHERE rch.CHEQUE_TYPE = 'RETURN' AND rch.DOCUMENT_STATE IN ('PRINTED', 'PROC')
			AND rch.ID_DOCUMENT_BASE_GLOBAL = CH.ID_CHEQUE_GLOBAL)	
	OR EXISTS
		(SELECT * FROM CHEQUE rch
			inner join CHEQUE ch2 on ch2.ID_DOCUMENT_BASE_GLOBAL = rch.ID_CHEQUE_GLOBAL		
			inner join CHEQUE_ITEM chi2 on ch2.ID_CHEQUE_GLOBAL = chi2.ID_CHEQUE_GLOBAL
		WHERE rch.CHEQUE_TYPE = 'RETURN' AND rch.DOCUMENT_STATE IN ('PRINTED', 'PROC')
			AND rch.ID_DOCUMENT_BASE_GLOBAL = CH.ID_CHEQUE_GLOBAL and chi2.ID_LOT_GLOBAL = CHI.ID_LOT_GLOBAL))
			
UNION ALL

SELECT 
	MEMBER_NAME = ISNULL(DM.LASTNAME + ' ', '') + ISNULL(DM.FIRSTNAME + ' ', '') + ISNULL(DM.MIDDLENAME, ''),
	NUMBER_RECIPE = isnull(TL.SERIES_RECIPE + ' ', '') + TL.NUMBER_RECIPE,
	DATE_CHEQUE = TL.DATE_REG,
	GOODS_NAME = G.NAME,
	QUANTITY = TLI.QUANTITY * CONVERT(MONEY,SR.NUMERATOR) / CONVERT(MONEY, SR.DENOMINATOR),
	PRICE = L.PRICE_SAL * CONVERT(MONEY,SR.DENOMINATOR) / CONVERT(MONEY, SR.NUMERATOR),
	SUMM = L.PRICE_SAL * TLI.QUANTITY,
	INSURANCE_COMPANY = IC.NAME

FROM TRUST_LETTER TL
	INNER JOIN TRUST_LETTER_ITEM TLI ON TLI.ID_TRUST_LETTER_GLOBAL = TL.ID_TRUST_LETTER_GLOBAL
	INNER JOIN LOT L ON L.ID_LOT_GLOBAL = TLI.ID_SOURCE_GLOBAL
	LEFT JOIN DISCOUNT2_DOCTOR ON DISCOUNT2_DOCTOR.ID_DOCTOR = TL.ID_DISCOUNT2_DOCTOR
	LEFT JOIN SCALING_RATIO SR ON SR.ID_SCALING_RATIO = L.ID_SCALING_RATIO
	LEFT JOIN GOODS G ON L.ID_GOODS = G.ID_GOODS
	LEFT JOIN DISCOUNT2_INSURANCE_COMPANY IC ON IC.ID_DISCOUNT2_INSURANCE_COMPANY_GLOBAL = TL.ID_DISCOUNT2_INSURANCE_COMPANY_GLOBAL
	LEFT JOIN DISCOUNT2_MEMBER DM ON DM.ID_DISCOUNT2_MEMBER_GLOBAL = TL.ID_DISCOUNT2_MEMBER_GLOBAL
	LEFT JOIN STORE ST ON ST.ID_STORE = L.ID_STORE
	LEFT JOIN DISCOUNT2_MEDICAL_ORGANIZATION MO ON MO.ID_DISCOUNT2_MEDICAL_ORGANIZATION = TL.ID_DISCOUNT2_MEDICAL_ORGANIZATION
WHERE TL.DATE_REG BETWEEN @DATE_FR AND @DATE_TO
	AND ISNULL(TL.DATE_SHIP,TL.DATE_REG) BETWEEN @DATE_SH_FR AND @DATE_SH_TO 
	AND (@ALL_GOODS = 1 OR G.ID_GOODS IN (SELECT ID_GOODS FROM #GOODS))
	AND (@ALL_CONTRACTOR = 1 OR ST.ID_CONTRACTOR IN (SELECT ID_CONTRACTOR FROM #CONTRACTOR))
	AND (@ALL_STORE = 1 OR ST.ID_STORE IN (SELECT ID_STORE FROM #STORE))
	AND (@ALL_INS = 1 OR IC.ID_DISCOUNT2_INSURANCE_COMPANY_GLOBAL IN (SELECT ID_INS FROM #INS))
	AND (@ALL_LPU = 1 OR TL.ID_DISCOUNT2_MEDICAL_ORGANIZATION IN (SELECT ID_LPU FROM #LPU))
	AND (@ALL_LGOT = 1 OR TL.ID_DISCOUNT2_CAT_LGOT_GLOBAL IN (SELECT ID_LGOT FROM #LGOT))
	AND NOT EXISTS(SELECT NULL FROM CHEQUE CH WHERE CH.ID_CHEQUE_GLOBAL = TL.ID_TRUST_LETTER_GLOBAL)
) A

ORDER BY A.DATE_CHEQUE


IF (@SHORT = 1)
BEGIN

select 
	MEMBER_NAME = MEMBER_NAME,
	--NUMBER_POLICY = NUMBER_POLICY,
	DATE_CHEQUE = CAST(CONVERT(VARCHAR(8), DATE_CHEQUE, 112) AS DATETIME),
	SUMM = ROUND(SUM(SUMM), 2),
	INSURANCE_COMPANY = INSURANCE_COMPANY
from #temp_t
group by MEMBER_NAME, --NUMBER_POLICY, 
CAST(CONVERT(VARCHAR(8), DATE_CHEQUE, 112) AS DATETIME), INSURANCE_COMPANY
order by MEMBER_NAME, CAST(CONVERT(VARCHAR(8), DATE_CHEQUE, 112) AS DATETIME)

END ELSE
BEGIN
select * from #temp_t
order by MEMBER_NAME, CAST(CONVERT(VARCHAR(8), DATE_CHEQUE, 112) AS DATETIME)
END

SELECT
	DIRECTOR_FIO
FROM CONTRACTOR
WHERE ID_CONTRACTOR = (SELECT TOP 1 ID_CONTRACTOR FROM ENTERPRISE_BRANCH WHERE IS_SELF = 1)

RETURN
GO

---исправлено
/*
exec DBO.REPEX_GOODS_REGISTRY N'
<XML>
	<DATE_FR>2011-04-01T00:00:00.000</DATE_FR>
	<DATE_TO>2015-04-19T00:00:00.000</DATE_TO>
	<SHORT>0</SHORT>
	
</XML>'
*/
SET NOCOUNT ON
SET QUOTED_IDENTIFIER OFF
GO

IF OBJECT_ID('DBO.REPEX_GOODS_REGISTRY_LAND') IS NULL EXEC('CREATE PROCEDURE DBO.REPEX_GOODS_REGISTRY_LAND AS RETURN')
GO

ALTER PROCEDURE DBO.REPEX_GOODS_REGISTRY_LAND
    @XMLPARAM NTEXT AS

DECLARE @HDOC INT
DECLARE @DATE_FR DATETIME
DECLARE @DATE_TO DATETIME
DECLARE @DATE_SH_FR DATETIME
DECLARE @DATE_SH_TO DATETIME
DECLARE @SHORT BIT
DECLARE @ALL_CONTRACTOR BIT
DECLARE @ALL_STORE BIT
DECLARE @ALL_INS BIT
DECLARE @ALL_LGOT BIT
DECLARE @ALL_GOODS BIT
DECLARE @ALL_LPU BIT

EXEC SP_XML_PREPAREDOCUMENT @HDOC OUT, @XMLPARAM
SELECT
	@DATE_FR = DATE_FR,
	@DATE_TO = DATE_TO,
	@DATE_SH_FR = DATE_SH_FR,
	@DATE_SH_TO = DATE_SH_TO,
	@SHORT = SHORT
FROM OPENXML(@HDOC, '/XML') WITH(
	DATE_FR DATETIME 'DATE_FR',
	DATE_TO DATETIME 'DATE_TO',
	DATE_SH_FR DATETIME 'DATE_SH_FR',
	DATE_SH_TO DATETIME 'DATE_SH_TO',
	SHORT BIT 'SHORT'
)

SELECT * INTO #CONTRACTOR FROM OPENXML(@HDOC, '//ID_CONTRACTOR') 
WITH(ID_CONTRACTOR BIGINT '.')
IF @@ROWCOUNT = 0 SET @ALL_CONTRACTOR = 1

SELECT * INTO #STORE FROM OPENXML(@HDOC, '//ID_STORE') 
WITH(ID_STORE BIGINT '.')
IF @@ROWCOUNT = 0 SET @ALL_STORE = 1

SELECT * INTO #INS FROM OPENXML(@HDOC, '//ID_INS') 
WITH(ID_INS UNIQUEIDENTIFIER '.')
IF @@ROWCOUNT = 0 SET @ALL_INS = 1;

SELECT * INTO #GOODS FROM OPENXML(@HDOC, '//ID_GOODS') 
WITH(ID_GOODS BIGINT '.')
IF @@ROWCOUNT = 0 SET @ALL_GOODS = 1;

SELECT * INTO #LPU FROM OPENXML(@HDOC, '//ID_LPU') 
WITH(ID_LPU BIGINT '.')
IF @@ROWCOUNT = 0 SET @ALL_LPU = 1;

SELECT * INTO #LGOT FROM OPENXML(@HDOC, '//ID_LGOT') 
WITH(ID_LGOT UNIQUEIDENTIFIER '.')
IF @@ROWCOUNT = 0 SET @ALL_LGOT = 1

EXEC SP_XML_REMOVEDOCUMENT @HDOC

EXEC USP_RANGE_NORM @DATE_FR OUT, @DATE_TO OUT
EXEC USP_RANGE_DAYS @DATE_FR OUT, @DATE_TO OUT

EXEC USP_RANGE_NORM @DATE_SH_FR OUT, @DATE_SH_TO OUT
EXEC USP_RANGE_DAYS @DATE_SH_FR OUT, @DATE_SH_TO OUT

SELECT *
FROM
(

SELECT

	NUMBER_RECIPE = isnull(TL.SERIES_RECIPE + ' ', '') + TL.NUMBER_RECIPE,
	DATE_RECIPE = TL.DATE_RECIPE,
	DOCTOR = DISCOUNT2_DOCTOR.LAST_NAME + ' ' + DISCOUNT2_DOCTOR.FIRST_NAME + ' ' + DISCOUNT2_DOCTOR.MIDDLE_NAME,
	MEMBER_NAME = ISNULL(DM.LASTNAME + ' ', '') + ISNULL(DM.FIRSTNAME + ' ', '') + ISNULL(DM.MIDDLENAME, ''),
	NUMBER_POLICY = TL.NUMBER_POLICY,
	[ADDRESS] = DM.[ADDRESS],
	BIRTHDAY = DM.BIRTHDAY,	
	GOODS_NAME = G.NAME,
	QUANTITY = CHI.QUANTITY * CONVERT(MONEY,SR.NUMERATOR) / CONVERT(MONEY, SR.DENOMINATOR),
	PRICE = CHI.PRICE * CONVERT(MONEY,SR.DENOMINATOR) / CONVERT(MONEY, SR.NUMERATOR),
	SUMM = ISNULL(ISNULL((SELECT TOP 1 SUMM FROM CHEQUE_PAYMENT WHERE ID_CHEQUE_GLOBAL = CH.ID_CHEQUE_GLOBAL AND  TYPE_PAYMENT/*SEPARATE_TYPE*/ = 'TYPE4'),(SELECT TOP 1 SUMM FROM CHEQUE_PAYMENT WHERE ID_CHEQUE_GLOBAL = CH.ID_CHEQUE_GLOBAL AND  /*TYPE_PAYMENT*/SEPARATE_TYPE = 'TYPE4')) * CHI.SUMM / CH.SUMM, 0),
	DATE_CHEQUE = COALESCE (TL.DATE_SHIP, TL.DATE_REG, DATE_CHEQUE),
	PERCENT_PAY =FLOOR(ISNULL(ISNULL((SELECT TOP 1 SUMM FROM CHEQUE_PAYMENT WHERE ID_CHEQUE_GLOBAL = CH.ID_CHEQUE_GLOBAL AND  TYPE_PAYMENT/*SEPARATE_TYPE*/ = 'TYPE4'),(SELECT TOP 1 SUMM FROM CHEQUE_PAYMENT WHERE ID_CHEQUE_GLOBAL = CH.ID_CHEQUE_GLOBAL AND  /*TYPE_PAYMENT*/SEPARATE_TYPE = 'TYPE4')) * CHI.SUMM / CH.SUMM, 0) / (CHI.SUMM - CHI.SUMM_DISCOUNT) * 100),
	INSURANCE_COMPANY = IC.NAME
FROM TRUST_LETTER TL
	LEFT JOIN CHEQUE CH ON CH.ID_CHEQUE_GLOBAL = TL.ID_TRUST_LETTER_GLOBAL		
	LEFT JOIN CHEQUE_ITEM CHI ON CHI.ID_CHEQUE_GLOBAL = TL.ID_TRUST_LETTER_GLOBAL
	LEFT JOIN GOODS G ON CHI.ID_GOODS = G.ID_GOODS
	INNER JOIN DISCOUNT2_INSURANCE_COMPANY IC ON IC.ID_DISCOUNT2_INSURANCE_COMPANY_GLOBAL = TL.ID_DISCOUNT2_INSURANCE_COMPANY_GLOBAL
	LEFT JOIN DISCOUNT2_MEMBER DM ON DM.ID_DISCOUNT2_MEMBER_GLOBAL = TL.ID_DISCOUNT2_MEMBER_GLOBAL
	LEFT JOIN LOT L ON L.ID_LOT_GLOBAL = CHI.ID_LOT_GLOBAL
	LEFT JOIN SCALING_RATIO SR ON SR.ID_SCALING_RATIO = L.ID_SCALING_RATIO
	LEFT JOIN STORE ST ON ST.ID_STORE = L.ID_STORE
	LEFT JOIN DISCOUNT2_MEDICAL_ORGANIZATION MO ON MO.ID_DISCOUNT2_MEDICAL_ORGANIZATION = TL.ID_DISCOUNT2_MEDICAL_ORGANIZATION
	LEFT JOIN DISCOUNT2_DOCTOR ON DISCOUNT2_DOCTOR.ID_DOCTOR = TL.ID_DISCOUNT2_DOCTOR
WHERE DATE_CHEQUE BETWEEN @DATE_FR AND @DATE_TO
	AND COALESCE (TL.DATE_SHIP, TL.DATE_REG, DATE_CHEQUE)  BETWEEN @DATE_SH_FR AND @DATE_SH_TO
	AND (@ALL_GOODS = 1 OR G.ID_GOODS IN (SELECT ID_GOODS FROM #GOODS))
	AND (@ALL_CONTRACTOR = 1 OR ST.ID_CONTRACTOR IN (SELECT ID_CONTRACTOR FROM #CONTRACTOR))
	AND (@ALL_STORE = 1 OR ST.ID_STORE IN (SELECT ID_STORE FROM #STORE))
	AND (@ALL_INS = 1 OR IC.ID_DISCOUNT2_INSURANCE_COMPANY_GLOBAL IN (SELECT ID_INS FROM #INS))
	AND (@ALL_LPU = 1 OR TL.ID_DISCOUNT2_MEDICAL_ORGANIZATION IN (SELECT ID_LPU FROM #LPU))
	AND (@ALL_LGOT = 1 OR TL.ID_DISCOUNT2_CAT_LGOT_GLOBAL IN (SELECT ID_LGOT FROM #LGOT))
	AND (NOT EXISTS (SELECT * FROM CHEQUE rch
		WHERE rch.CHEQUE_TYPE = 'RETURN' AND rch.DOCUMENT_STATE IN ('PRINTED', 'PROC')
			AND rch.ID_DOCUMENT_BASE_GLOBAL = CH.ID_CHEQUE_GLOBAL)	
	OR EXISTS
		(SELECT * FROM CHEQUE rch
			inner join CHEQUE ch2 on ch2.ID_DOCUMENT_BASE_GLOBAL = rch.ID_CHEQUE_GLOBAL		
			inner join CHEQUE_ITEM chi2 on ch2.ID_CHEQUE_GLOBAL = chi2.ID_CHEQUE_GLOBAL
		WHERE rch.CHEQUE_TYPE = 'RETURN' AND rch.DOCUMENT_STATE IN ('PRINTED', 'PROC')
			AND rch.ID_DOCUMENT_BASE_GLOBAL = CH.ID_CHEQUE_GLOBAL and chi2.ID_LOT_GLOBAL = CHI.ID_LOT_GLOBAL))	


UNION ALL

SELECT
	NUMBER_RECIPE = isnull(TL.SERIES_RECIPE + ' ', '') + TL.NUMBER_RECIPE,
	DATE_RECIPE = TL.DATE_RECIPE,
	DOCTOR = DISCOUNT2_DOCTOR.LAST_NAME + ' ' + DISCOUNT2_DOCTOR.FIRST_NAME + ' ' + DISCOUNT2_DOCTOR.MIDDLE_NAME,
	MEMBER_NAME = ISNULL(DM.LASTNAME + ' ', '') + ISNULL(DM.FIRSTNAME + ' ', '') + ISNULL(DM.MIDDLENAME, ''),
	NUMBER_POLICY = TL.NUMBER_POLICY,
	[ADDRESS] = DM.[ADDRESS],
	BIRTHDAY = DM.BIRTHDAY,	
	GOODS_NAME = G.NAME,
	QUANTITY = TLI.QUANTITY * CONVERT(MONEY,SR.NUMERATOR) / CONVERT(MONEY, SR.DENOMINATOR),
	PRICE = L.PRICE_SAL * CONVERT(MONEY,SR.DENOMINATOR) / CONVERT(MONEY, SR.NUMERATOR),
	SUMM = TLI.QUANTITY * L.PRICE_SAL,
	DATE_CHEQUE = ISNULL(TL.DATE_SHIP,TL.DATE_REG),
	PERCENT_PAY = 100,
	INSURANCE_COMPANY = IC.NAME

FROM TRUST_LETTER TL
	INNER JOIN TRUST_LETTER_ITEM TLI ON TLI.ID_TRUST_LETTER_GLOBAL = TL.ID_TRUST_LETTER_GLOBAL
	INNER JOIN LOT L ON L.ID_LOT_GLOBAL = TLI.ID_SOURCE_GLOBAL
	LEFT JOIN SCALING_RATIO SR ON SR.ID_SCALING_RATIO = L.ID_SCALING_RATIO
	LEFT JOIN GOODS G ON L.ID_GOODS = G.ID_GOODS
	INNER JOIN DISCOUNT2_INSURANCE_COMPANY IC ON IC.ID_DISCOUNT2_INSURANCE_COMPANY_GLOBAL = TL.ID_DISCOUNT2_INSURANCE_COMPANY_GLOBAL
	LEFT JOIN DISCOUNT2_MEMBER DM ON DM.ID_DISCOUNT2_MEMBER_GLOBAL = TL.ID_DISCOUNT2_MEMBER_GLOBAL
	LEFT JOIN STORE ST ON ST.ID_STORE = L.ID_STORE
	LEFT JOIN DISCOUNT2_MEDICAL_ORGANIZATION MO ON MO.ID_DISCOUNT2_MEDICAL_ORGANIZATION = TL.ID_DISCOUNT2_MEDICAL_ORGANIZATION
	LEFT JOIN DISCOUNT2_DOCTOR ON DISCOUNT2_DOCTOR.ID_DOCTOR = TL.ID_DISCOUNT2_DOCTOR
WHERE TL.DATE_REG BETWEEN @DATE_FR AND @DATE_TO
	AND ISNULL(TL.DATE_SHIP,TL.DATE_REG) BETWEEN @DATE_SH_FR AND @DATE_SH_TO
	AND (@ALL_GOODS = 1 OR G.ID_GOODS IN (SELECT ID_GOODS FROM #GOODS))
	AND (@ALL_CONTRACTOR = 1 OR ST.ID_CONTRACTOR IN (SELECT ID_CONTRACTOR FROM #CONTRACTOR))
	AND (@ALL_STORE = 1 OR ST.ID_STORE IN (SELECT ID_STORE FROM #STORE))
	AND (@ALL_INS = 1 OR IC.ID_DISCOUNT2_INSURANCE_COMPANY_GLOBAL IN (SELECT ID_INS FROM #INS))
	AND (@ALL_LPU = 1 OR TL.ID_DISCOUNT2_MEDICAL_ORGANIZATION IN (SELECT ID_LPU FROM #LPU))
	AND (@ALL_LGOT = 1 OR TL.ID_DISCOUNT2_CAT_LGOT_GLOBAL IN (SELECT ID_LGOT FROM #LGOT))
	AND NOT EXISTS(SELECT NULL FROM CHEQUE CH WHERE CH.ID_CHEQUE_GLOBAL = TL.ID_TRUST_LETTER_GLOBAL)
	
) A

ORDER BY A.MEMBER_NAME, A.DATE_CHEQUE

SELECT
	DIRECTOR_FIO
FROM CONTRACTOR
WHERE ID_CONTRACTOR = (SELECT TOP 1 ID_CONTRACTOR FROM ENTERPRISE_BRANCH WHERE IS_SELF = 1)

RETURN
GO

/*
exec REPEX_GOODS_REGISTRY N'
<XML>
	<DATE_FR>2001-12-28T00:00:00.000</DATE_FR>
	<DATE_TO>2015-12-28T00:00:00.000</DATE_TO>
	
	
</XML>'
 

exec REPEX_GOODS_REGISTRY_LAND N'
<XML>
	<DATE_FR>2001-12-28T00:00:00.000</DATE_FR>
	<DATE_TO>2011-12-28T00:00:00.000</DATE_TO>
	<SHORT>1</SHORT>
	
</XML>'
*/
--<ID_INS>22A3893D-C889-4F50-83D8-4160A0C70164</ID_INS>
/*
select * from cheque where id_cheque_global = '0F4844C7-20DD-4148-8528-7D4BCAAF7CDF'

select * from CHEQUE_ITEM  where id_cheque_global = '0F4844C7-20DD-4148-8528-7D4BCAAF7CDF'
SELECT  * FROM CHEQUE_PAYMENT WHERE ID_CHEQUE_GLOBAL  = '0F4844C7-20DD-4148-8528-7D4BCAAF7CDF'
*/
