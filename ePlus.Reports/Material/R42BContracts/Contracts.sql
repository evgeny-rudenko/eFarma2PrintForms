SET NOCOUNT ON
SET QUOTED_IDENTIFIER OFF
GO

IF (OBJECT_ID('R42B_CONTRACTS') IS NULL) EXEC ('CREATE PROCEDURE R42B_CONTRACTS AS RETURN')
GO
ALTER PROCEDURE R42B_CONTRACTS
	@XMLPARAM NTEXT
AS
SET NOCOUNT ON

DECLARE @HDOC INT
DECLARE @DATE_FROM DATETIME, @DATE_TO DATETIME
DECLARE @ALL_CONTRACTOR BIT

EXEC SP_XML_PREPAREDOCUMENT @HDOC OUTPUT, @XMLPARAM OUTPUT
	SELECT 
	    @DATE_FROM = DATE_FROM,
        @DATE_TO = DATE_TO        
	FROM OPENXML(@HDOC, '/XML') 
	WITH(
		DATE_FROM DATETIME 'DATE_FROM',
        DATE_TO DATETIME 'DATE_TO')

SELECT * INTO #CONTRACTOR FROM OPENXML(@HDOC, '//ID_CONTRACTOR') 
WITH(ID_CONTRACTOR BIGINT '.')
IF @@ROWCOUNT = 0 SET @ALL_CONTRACTOR = 1

EXEC SP_XML_REMOVEDOCUMENT @HDOC

   EXEC USP_RANGE_DAYS @DATE_FROM OUT, @DATE_TO OUT
   EXEC USP_RANGE_NORM @DATE_FROM OUT, @DATE_TO OUT
   
SELECT 
	COUNT1 = COUNT(*),
	SUMM = SUM(REQ_AMOUNT)
FROM CONTRACTS
WHERE (@ALL_CONTRACTOR = 1 OR ID_CONTRACTOR IN (SELECT ID_CONTRACTOR FROM #CONTRACTOR))  
		AND START_DATE BETWEEN @DATE_FROM AND @DATE_TO
		
SELECT
	DIR = DIRECTOR_FIO,
	NAMEAPT = NAME
FROM CONTRACTOR
WHERE ID_CONTRACTOR = (SELECT TOP 1 ID_CONTRACTOR FROM ENTERPRISE_BRANCH WHERE IS_SELF = 1)		
   
   
RETURN 0
GO

/* 
EXEC R42B_CONTRACTS 
@XMLPARAM = '<XML><ID_CONTRACTOR>5484</ID_CONTRACTOR></XML>'
*/
   
