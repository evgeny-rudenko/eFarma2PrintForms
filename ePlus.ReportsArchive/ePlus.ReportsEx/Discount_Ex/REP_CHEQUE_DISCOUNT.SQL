IF OBJECT_ID('DBO.REP_CHEQUE_DISCOUNT') IS NULL EXEC('CREATE PROCEDURE DBO.REP_CHEQUE_DISCOUNT AS RETURN')
GO
ALTER PROCEDURE DBO.REP_CHEQUE_DISCOUNT
     (@XMLPARAM NTEXT) AS
/* PARAMETERS */
DECLARE @HDOC INT, @SORT INT
DECLARE @TEXT NVARCHAR(4000)
DECLARE @DATE_FR DATETIME, @DATE_TO DATETIME
DECLARE @ALL_CONTRACTOR BIT, @ALL_STORE BIT, @ALL_DISCOUNT_PROGRAM BIT, @ALL_DISCOUNT_CARD BIT, 
     @ALL_DISCOUNT_MEMBER BIT, @ALL_DISCOUNT_CARD_TYPE BIT, @ALL_CASH_REGISTER BIT
EXEC SP_XML_PREPAREDOCUMENT @HDOC OUTPUT, @XMLPARAM OUTPUT
     SELECT TOP 1 @SORT = SORT, @DATE_FR = DATE_FR, @DATE_TO = DATE_TO 
          FROM OPENXML(@HDOC, '/XML') 
     WITH(SORT INT 'SORT', DATE_FR DATETIME 'DATE_FR', DATE_TO DATETIME 'DATE_TO')
     /* “¿¡À»÷¿ »ƒ≈Õ“»‘» ¿“Œ–Œ¬  ŒÕ“–¿√≈Õ“Œ¬ */
     SELECT * INTO #CONTRACTOR FROM OPENXML(@HDOC, '//ID_CONTRACTOR') 
     WITH(ID_CONTRACTOR BIGINT '.') WHERE ID_CONTRACTOR <> 0
     IF @@ROWCOUNT = 0 SET @ALL_CONTRACTOR = 1
        /* “¿¡À»÷¿ »ƒ≈Õ“»‘» ¿“Œ–Œ¬ — À¿ƒŒ¬ */
     SELECT * INTO #STORE FROM OPENXML(@HDOC, '//ID_STORE') 
     WITH(ID_STORE BIGINT '.') WHERE ID_STORE <> 0
     IF @@ROWCOUNT = 0 SET @ALL_STORE = 1;
     
        /* “¿¡À»÷¿ »ƒ≈Õ“»‘» ¿“Œ–Œ¬  */
     SELECT * INTO #CASH_REGISTER FROM OPENXML(@HDOC, '//ID_CASH_REGISTER') 
     WITH(ID_CASH_REGISTER BIGINT '.') WHERE ID_CASH_REGISTER <> 0
     IF @@ROWCOUNT = 0 SET @ALL_CASH_REGISTER = 1;
        /* “¿¡À»÷¿ »ƒ≈Õ“»‘» ¿“Œ–Œ¬  */
     SELECT * INTO #DISCOUNT2_CARD FROM OPENXML(@HDOC, '//ID_DISCOUNT2_CARD_GLOBAL') 
     WITH(ID_DISCOUNT2_CARD_GLOBAL UNIQUEIDENTIFIER '.')
     IF @@ROWCOUNT = 0 SET @ALL_DISCOUNT_CARD = 1;
        /* “¿¡À»÷¿ »ƒ≈Õ“»‘» ¿“Œ–Œ¬  */
     SELECT * INTO #DISCOUNT2_MEMBER FROM OPENXML(@HDOC, '//ID_DISCOUNT2_MEMBER_GLOBAL') 
     WITH(ID_DISCOUNT2_MEMBER_GLOBAL UNIQUEIDENTIFIER '.')
     IF @@ROWCOUNT = 0 SET @ALL_DISCOUNT_MEMBER = 1;
        /* “¿¡À»÷¿ »ƒ≈Õ“»‘» ¿“Œ–Œ¬  */
     SELECT * INTO #DISCOUNT2_CARD_TYPE FROM OPENXML(@HDOC, '//ID_DISCOUNT2_CARD_TYPE_GLOBAL') 
     WITH(ID_DISCOUNT2_CARD_TYPE_GLOBAL UNIQUEIDENTIFIER '.')
     IF @@ROWCOUNT = 0 SET @ALL_DISCOUNT_CARD_TYPE = 1;
        /* “¿¡À»÷¿ »ƒ≈Õ“»‘» ¿“Œ–Œ¬  */
     SELECT * INTO #DISCOUNT2_PROGRAM FROM OPENXML(@HDOC, '//ID_DISCOUNT2_PROGRAM_GLOBAL') 
     WITH(ID_DISCOUNT2_PROGRAM_GLOBAL UNIQUEIDENTIFIER '.')
     IF @@ROWCOUNT = 0 SET @ALL_DISCOUNT_PROGRAM = 1;
EXEC SP_XML_REMOVEDOCUMENT @HDOC
EXEC DBO.USP_RANGE_NORM @DATE_FR OUT, @DATE_TO OUT
EXEC DBO.REP_RANGEDAY @DATE_FR OUT, @DATE_TO OUT
SELECT
     TYPE = CASE  
          WHEN DMI.ID_DISCOUNT2_CARD_GLOBAL IS NOT NULL THEN 
               'ƒ : '+ISNULL(DCK.[NAME], '')+'; '+ISNULL(DC.BARCODE,'')+'; '+ISNULL(DM.LASTNAME,'')+
               ' '+LEFT(ISNULL(DM.FIRSTNAME,''),1)+'. '+LEFT(ISNULL(DM.MIDDLENAME, ''),1)
          WHEN DMI.ID_DISCOUNT2_INSURANCE_POLICY_GLOBAL IS NOT NULL THEN 'œÂÙËÍÒ: ' + ISNULL(DIP.PREFIX, '') + ' ÕÓÏÂ ÔÓÎËÒ‡: ' + ISNULL(DIP.NUMBER, '')
          ELSE 'ƒœ: '+ISNULL(DP.[NAME], '') END,--“»œ(Õ¿»Ã≈ÕŒ¬¿Õ»≈)
     DISCOUNT_VALUE = CASE DISCOUNT_TYPE 
          WHEN 'PERCENT' THEN DP.DISCOUNT_VALUE
          ELSE DMI.AMOUNT*100/(CHI.PRICE*CHI.QUANTITY) END,
     VALUE_TEXT = G.[NAME],--Õ¿»Ã≈ÕŒ¬¿Õ»≈ “Œ¬¿–¿
     CHI.QUANTITY,-- ŒÀ»◊≈—“¬Œ
     UNIT.SHORT_NAME,---≈ƒ. »«Ã.
     CHI.SUMM,--—”ÃÃ¿ œ–Œƒ¿∆»
     CHI.SUMM_DISCOUNT,--—”ÃÃ¿ — »ƒ »
     L.ID_STORE, 
     CR.ID_CASH_REGISTER,
     SUMM_BEZ = CHI.PRICE*CHI.QUANTITY--CHI.SUMM + CHI.SUMM_DISCOUNT--SUM(CHI.PRICE*CHI.QUANTITY)
FROM DISCOUNT2_MAKE_ITEM DMI
     LEFT JOIN DISCOUNT2_PROGRAM DP ON DP.ID_DISCOUNT2_PROGRAM_GLOBAL = DMI.ID_DISCOUNT2_PROGRAM_GLOBAL
     LEFT JOIN DISCOUNT2_CARD DC ON DC.ID_DISCOUNT2_CARD_GLOBAL = DMI.ID_DISCOUNT2_CARD_GLOBAL
     LEFT JOIN DISCOUNT2_CARD_TYPE DCK ON DCK.ID_DISCOUNT2_CARD_TYPE_GLOBAL = DC.ID_DISCOUNT2_CARD_TYPE_GLOBAL
     LEFT JOIN DISCOUNT2_MEMBER DM ON DM.ID_DISCOUNT2_MEMBER_GLOBAL = DC.ID_DISCOUNT2_MEMBER_GLOBAL
     LEFT JOIN DISCOUNT2_INSURANCE_POLICY DIP ON DIP.ID_DISCOUNT2_INSURANCE_POLICY_GLOBAL = DMI.ID_DISCOUNT2_INSURANCE_POLICY_GLOBAL
     LEFT JOIN CHEQUE_ITEM CHI ON DMI.ID_CHEQUE_ITEM_GLOBAL = CHI.ID_CHEQUE_ITEM_GLOBAL
     LEFT JOIN CHEQUE CH ON CHI.ID_CHEQUE_GLOBAL = CH.ID_CHEQUE_GLOBAL
     LEFT JOIN GOODS G ON G.ID_GOODS = CHI.ID_GOODS
     LEFT JOIN SCALING_RATIO SR ON SR.ID_SCALING_RATIO = CHI.ID_SCALING_RATIO
     LEFT JOIN UNIT ON UNIT.ID_UNIT = SR.ID_UNIT
     LEFT JOIN CASH_SESSION CS ON CH.ID_CASH_SESSION_GLOBAL = CS.ID_CASH_SESSION_GLOBAL
     LEFT JOIN CASH_REGISTER CR ON CR.ID_CASH_REGISTER = CS.ID_CASH_REGISTER
     LEFT JOIN DBO.LOT L ON L.ID_LOT_GLOBAL = CHI.ID_LOT_GLOBAL
--WHERE CH.DATE_MODIFIED BETWEEN @DATE_FR AND @DATE_TO
WHERE CH.DATE_CHEQUE BETWEEN @DATE_FR AND @DATE_TO
AND CH.SUM_DISCOUNT <> 0 
AND DOCUMENT_STATE = 'PROC'
AND (@ALL_DISCOUNT_CARD = 1 OR DC.ID_DISCOUNT2_CARD_GLOBAL IN (SELECT ID_DISCOUNT2_CARD_GLOBAL FROM #DISCOUNT2_CARD))
AND (@ALL_DISCOUNT_MEMBER = 1 OR DM.ID_DISCOUNT2_MEMBER_GLOBAL IN (SELECT ID_DISCOUNT2_MEMBER_GLOBAL FROM #DISCOUNT2_MEMBER))
AND (@ALL_DISCOUNT_CARD_TYPE = 1 OR DCK.ID_DISCOUNT2_CARD_TYPE_GLOBAL IN (SELECT ID_DISCOUNT2_CARD_TYPE_GLOBAL FROM #DISCOUNT2_CARD_TYPE))
AND (@ALL_DISCOUNT_PROGRAM = 1 OR DP.ID_DISCOUNT2_PROGRAM_GLOBAL IN (SELECT ID_DISCOUNT2_PROGRAM_GLOBAL FROM #DISCOUNT2_PROGRAM))
AND (@ALL_CONTRACTOR = 1 OR CR.ID_CONTRACTOR IN (SELECT ID_CONTRACTOR FROM #CONTRACTOR))
AND (@ALL_STORE = 1 OR L.ID_STORE IN (SELECT ID_STORE FROM #STORE))
AND (@ALL_CASH_REGISTER = 1 OR CR.ID_CASH_REGISTER IN (SELECT ID_CASH_REGISTER FROM #CASH_REGISTER))
AND CH.CHEQUE_TYPE <> 'RETURN'
AND CHI.ID_CHEQUE_ITEM NOT IN (
    SELECT ABI.ID_BASE_DOCUMENT_ITEM
    FROM ACT_RETURN_TO_BUYER_ITEM ABI 
    INNER JOIN ACT_RETURN_TO_BUYER AB ON ABI.ID_ACT_RETURN_TO_BUYER_GLOBAL = AB.ID_ACT_RETURN_TO_BUYER_GLOBAL
    WHERE AB.DOCUMENT_STATE = 'PROC' AND ABI.ID_BASE_DOCUMENT_ITEM IS NOT NULL)

-- “≈ ”Ÿ¿ﬂ ¿œ“≈ ¿ (Õ≈ ƒŒÀ∆ÕŒ ¡€“‹ NULL »Õ¿◊≈ ¬ Œ“◊≈“≈ œ–Œ¡À≈Ã€)
SELECT
  ISNULL(CNT.NAME, '') AS COMPANY
FROM DBO.CONTRACTOR CNT
WHERE CNT.ID_CONTRACTOR = DBO.FN_CONST_CONTRACTOR_SELF()
             
RETURN 0
GO