--USE EPLUS_DEV10
SET NOCOUNT ON
SET QUOTED_IDENTIFIER OFF
-------------------------------------------------------------------------------
IF OBJECT_ID('REMAINDER_FROM1C_EX') IS NULL EXEC('CREATE PROCEDURE REMAINDER_FROM1C_EX AS RETURN')
GO
ALTER  PROCEDURE REMAINDER_FROM1C_EX
    @XMLPARAM NTEXT
AS

DECLARE @HDOC INT, @DATE_FR DATETIME, @DATE_TO DATETIME, @NO_DETAIL BIT

EXEC SP_XML_PREPAREDOCUMENT @HDOC OUTPUT, @XMLPARAM OUTPUT
    SELECT TOP 1
        @DATE_FR = DATE_FR,
        @DATE_TO = DATE_TO,
        @NO_DETAIL = NO_DETAIL
    FROM OPENXML(@HDOC, '/XML')  WITH(
        DATE_FR DATETIME 'DATE_FR',
        DATE_TO DATETIME 'DATE_TO',
        NO_DETAIL BIT 'NO_DETAIL')
EXEC SP_XML_REMOVEDOCUMENT @HDOC

EXEC DBO.REP_RANGEDAY @DATE_FR OUT, @DATE_TO OUT

IF @NO_DETAIL != 1 BEGIN
    SELECT
        LM.ID_GOODS,
        LM.GOODS_NAME,
        PRODUCER_NAME = PROD.[NAME],
        ID_SUPPLIER = C.ID_CONTRACTOR,
        SUPPLIER_NAME = C.[NAME],
        AMOUNT = SUM(LM.QUANTITY_ADD * SR.NUMERATOR / SR.DENOMINATOR),
        PRICE = ROUND(L.PRICE_SUP, 2),
        RETAIL_PRICE = ROUND(L.PRICE_SAL, 2),
        SUMM = SUM(L.PRICE_SUP * LM.QUANTITY_ADD),
        SUMM_RETAIL = SUM(L.PRICE_SAL * LM.QUANTITY_ADD)
    FROM MV_LOT_MOVEMENT LM(NOLOCK)
        INNER JOIN LOT L(NOLOCK) ON L.ID_LOT_GLOBAL = LM.ID_LOT_GLOBAL
        INNER JOIN SCALING_RATIO SR(NOLOCK) ON SR.ID_SCALING_RATIO = L.ID_SCALING_RATIO
        LEFT JOIN INVOICE I(NOLOCK) ON I.ID_INVOICE_GLOBAL = LM.ID_DOCUMENT
        INNER JOIN CONTRACTOR C(NOLOCK) ON I.ID_CONTRACTOR_SUPPLIER = C.ID_CONTRACTOR
        LEFT JOIN PRODUCER PROD(NOLOCK) ON PROD.ID_PRODUCER = LM.ID_PRODUCER
    WHERE LM.ID_TABLE = 2
--        AND I.COMMENT = 'Перенос остатков из 1C'
        AND LM.DATE_OP BETWEEN @DATE_FR AND @DATE_TO
        AND LM.QUANTITY_ADD != 0
    GROUP BY LM.ID_GOODS, LM.GOODS_NAME, PROD.[NAME], C.ID_CONTRACTOR, C.[NAME], L.PRICE_SUP, L.PRICE_SAL
    ORDER BY C.[NAME], LM.GOODS_NAME
END ELSE BEGIN
    SELECT												
        ID_SUPPLIER = C.ID_CONTRACTOR,
        SUPPLIER_NAME = C.[NAME],
        AMOUNT = SUM(LM.QUANTITY_ADD * SR.NUMERATOR / SR.DENOMINATOR),
        SUMM = SUM(L.PRICE_SUP * LM.QUANTITY_ADD),
        SUMM_RETAIL = SUM(L.PRICE_SAL * LM.QUANTITY_ADD)
    FROM MV_LOT_MOVEMENT LM(NOLOCK)
        INNER JOIN LOT L(NOLOCK) ON L.ID_LOT_GLOBAL = LM.ID_LOT_GLOBAL
        INNER JOIN SCALING_RATIO SR(NOLOCK) ON SR.ID_SCALING_RATIO = L.ID_SCALING_RATIO
        LEFT JOIN INVOICE I(NOLOCK) ON I.ID_INVOICE_GLOBAL = LM.ID_DOCUMENT
        INNER JOIN CONTRACTOR C(NOLOCK) ON I.ID_CONTRACTOR_SUPPLIER = C.ID_CONTRACTOR
        LEFT JOIN PRODUCER PROD(NOLOCK) ON PROD.ID_PRODUCER = LM.ID_PRODUCER
    WHERE LM.ID_TABLE = 2
        AND I.COMMENT = 'Перенос остатков из 1C'
        AND LM.DATE_OP BETWEEN @DATE_FR AND @DATE_TO
        AND LM.QUANTITY_ADD != 0
    GROUP BY C.ID_CONTRACTOR, C.[NAME]
    ORDER BY C.[NAME]
END

RETURN 0
GO
-------------------------------------------------------------------------------
-- EXEC REP_REMAINDER_FROM1C_EX '<XML><DATE_FR>20070101</DATE_FR><DATE_TO>20080101</DATE_TO><NO_DETAIL>1</NO_DETAIL></XML>'
-- GO
SET QUOTED_IDENTIFIER OFF 
GO
SET ANSI_NULLS ON 
GO

--exec REMAINDER_FROM1C_EX @xmlParam = N'<XML><DATE_FR>2009-02-05T00:00:00.000</DATE_FR><DATE_TO>2009-02-18T00:00:00.000</DATE_TO><NO_DETAIL>0</NO_DETAIL></XML>'



