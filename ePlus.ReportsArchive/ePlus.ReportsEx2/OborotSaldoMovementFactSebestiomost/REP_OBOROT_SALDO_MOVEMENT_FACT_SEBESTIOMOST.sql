IF (OBJECT_ID('REP_OBOROT_SALDO_MOVEMENT_FACT_SEBESTIOMOST') IS NULL) 
    EXEC ('CREATE PROCEDURE REP_OBOROT_SALDO_MOVEMENT_FACT_SEBESTIOMOST AS RETURN')
GO
ALTER PROCEDURE REP_OBOROT_SALDO_MOVEMENT_FACT_SEBESTIOMOST(
	@XMLPARAM NTEXT)
AS
DECLARE @DATE_FROM DATETIME
DECLARE @DATE_TO DATETIME
DECLARE @ENVD BIT
DECLARE @ID_CONTRACTOR_STU BIGINT

SELECT TOP 1 @ID_CONTRACTOR_STU = ID_CONTRACTOR FROM CONTRACTOR WHERE [NAME] = 'СТУ' AND DATE_DELETED IS NULL

DECLARE @HDOC INT, @ERROR INT, @ROWCOUNT INT

EXEC SP_XML_PREPAREDOCUMENT @HDOC OUTPUT, @XMLPARAM
    SELECT TOP 1 * INTO #PARAMS FROM OPENXML(@HDOC, '//XML') WITH(
        DATE_FR DATETIME 'DATE_FR',
        DATE_TO DATETIME 'DATE_TO',
	ENVD BIT 'ENVD')

    SELECT * INTO #GOODS FROM OPENXML(@HDOC, '//XML/GOODS') WITH(
        ID_GOODS BIGINT 'ID_GOODS')

    SELECT * INTO #STORE FROM OPENXML(@HDOC, '//XML/STORE') WITH(
        ID_STORE BIGINT 'ID_STORE')
EXEC SP_XML_REMOVEDOCUMENT @HDOC

SELECT @DATE_FROM = DATE_FR, @DATE_TO = DATE_TO, @ENVD = ENVD FROM #PARAMS
EXEC USP_RANGE_DAYS @DATE_FROM OUT, @DATE_TO OUT


SELECT 
	LM.*, 
	L.ID_STORE, 
	L.ID_GOODS,
	L.ID_SUPPLIER,
	S.ID_CONTRACTOR,
	CONVERT(MONEY, NULL) AS SUM_SUP_VAT,
	CONVERT(MONEY, NULL) AS SUM_SALDO,
	CONVERT(DATETIME, NULL) AS DATE_CLOSE
INTO #LM
FROM LOT_MOVEMENT LM
INNER JOIN LOT L ON L.ID_LOT_GLOBAL = LM.ID_LOT_GLOBAL
INNER JOIN STORE S ON S.ID_STORE = L.ID_STORE
WHERE ISNULL(LM.QUANTITY_RES, 0) = 0

UPDATE #LM SET DATE_CLOSE = CS.DATE_CLOSE
FROM CASH_SESSION CS, #LM
WHERE #LM.ID_DOCUMENT = CS.ID_CASH_SESSION_GLOBAL

IF (ISNULL(@ENVD, 0) = 0)
	UPDATE #LM SET 
		SUM_SUP_VAT = ISNULL(ROUND(SUM_SUP, 2), 0) - ISNULL(ROUND(SVAT_SUP, 0), 0),
		SUM_SALDO = (SIGN(QUANTITY_ADD) - SIGN(QUANTITY_SUB)) * (ISNULL(ROUND(SUM_SUP, 2), 0) - ISNULL(ROUND(SVAT_SUP, 0), 0))
ELSE
	UPDATE #LM SET 
		SUM_SUP_VAT = ISNULL(ROUND(SUM_SUP, 2), 0),
		SUM_SALDO = (SIGN(QUANTITY_ADD) - SIGN(QUANTITY_SUB)) * ISNULL(ROUND(SUM_SUP, 2), 0)
		

IF (SELECT COUNT(*) FROM #STORE) > 0
BEGIN
	DELETE FROM #LM WHERE ID_STORE NOT IN (SELECT ID_STORE FROM #STORE)
END

IF (SELECT COUNT(*) FROM #GOODS) > 0
BEGIN
	DELETE FROM #LM WHERE ID_GOODS NOT IN (SELECT ID_GOODS FROM #GOODS)
END

DECLARE @RESULT TABLE(
	[COUNT] [BIGINT] IDENTITY (1, 1),
	ID_CONTRACTOR BIGINT,
	SALDO_DATE_START MONEY,
	SALDO_DATE_END MONEY,
	INVOICE_DEBET MONEY,
	NDS_INVOICE_DEBET MONEY,
	RETURN_BUYER_DEBET MONEY,
	MOVEMENT_DEBET MONEY,
	IZLISHKI_DEBET MONEY,
	DIS_REVAL_DEBET MONEY,
	TOTAL_DEBET MONEY,
	
	COST_CREDIT MONEY,
	RETURN_SUPPLIER_CRETID MONEY,
	RETURN_SUPPLIER_BACK MONEY,
	NEDOSTACHI_CREDIT MONEY,
	SPISANIYA_CREDIT MONEY,
	MOVEMENT_CREDIT MONEY,
	DIS_REVAL_CREDIT MONEY,
	TOTAL_CREDIT MONEY,
	CASH_SUM MONEY
)

INSERT INTO @RESULT (ID_CONTRACTOR) SELECT DISTINCT ID_CONTRACTOR FROM #LM

-- 3
-- Сальдо для всех документов кроме чеков продаж
UPDATE @RESULT SET SALDO_DATE_START = T.VALUE
FROM 
(
SELECT SUM(SUM_SALDO) AS VALUE, ID_CONTRACTOR
FROM #LM WHERE DATE_OP <= @DATE_FROM AND DATE_CLOSE IS NULL
GROUP BY ID_CONTRACTOR
) T, @RESULT R
WHERE T.ID_CONTRACTOR = R.ID_CONTRACTOR

UPDATE @RESULT SET SALDO_DATE_START = ISNULL(SALDO_DATE_START, 0) + ISNULL(T.VALUE, 0)
FROM 
(
SELECT SUM(SUM_SALDO) AS VALUE, ID_CONTRACTOR
FROM #LM WHERE DATE_CLOSE <= @DATE_FROM AND DATE_CLOSE IS NOT NULL
GROUP BY ID_CONTRACTOR
) T, @RESULT R
WHERE T.ID_CONTRACTOR = R.ID_CONTRACTOR

UPDATE @RESULT SET SALDO_DATE_START = ISNULL(SALDO_DATE_START, 0) + ISNULL(T.VALUE, 0)
FROM 
(
SELECT SUM(SUM_SUP_VAT) AS VALUE, ID_CONTRACTOR
FROM #LM WHERE DATE_OP BETWEEN @DATE_FROM AND @DATE_TO 
	AND ((CODE_OP = 'INVOICE' AND ID_SUPPLIER = @ID_CONTRACTOR_STU) OR CODE_OP = 'IMPORT_REMAINS')
GROUP BY ID_CONTRACTOR
) T, @RESULT R
WHERE T.ID_CONTRACTOR = R.ID_CONTRACTOR

-- 16
-- Сальдо для всех документов кроме чеков продаж
UPDATE @RESULT SET SALDO_DATE_END = T.VALUE
FROM 
(
SELECT SUM(SUM_SALDO) AS VALUE, ID_CONTRACTOR
FROM #LM WHERE DATE_OP <= @DATE_TO AND DATE_CLOSE IS NULL
GROUP BY ID_CONTRACTOR
) T, @RESULT R
WHERE T.ID_CONTRACTOR = R.ID_CONTRACTOR

UPDATE @RESULT SET SALDO_DATE_END = ISNULL(SALDO_DATE_END, 0) + ISNULL(T.VALUE, 0)
FROM 
(
SELECT SUM(SUM_SALDO) AS VALUE, ID_CONTRACTOR
FROM #LM WHERE DATE_CLOSE <= @DATE_TO AND DATE_CLOSE IS NOT NULL
GROUP BY ID_CONTRACTOR
) T, @RESULT R
WHERE T.ID_CONTRACTOR = R.ID_CONTRACTOR

-- 4
UPDATE @RESULT SET INVOICE_DEBET = T.VALUE
FROM 
(
SELECT SUM(SUM_SUP_VAT) AS VALUE, ID_CONTRACTOR
FROM #LM WHERE DATE_OP BETWEEN @DATE_FROM AND @DATE_TO 
	AND CODE_OP = 'INVOICE' AND (ID_SUPPLIER <> @ID_CONTRACTOR_STU OR @ID_CONTRACTOR_STU IS NULL)
GROUP BY ID_CONTRACTOR
) T, @RESULT R
WHERE T.ID_CONTRACTOR = R.ID_CONTRACTOR

-- 4a
IF (ISNULL(@ENVD, 0) = 0)
BEGIN
	UPDATE @RESULT SET NDS_INVOICE_DEBET = T.VALUE
	FROM 
	(
	SELECT SUM(SVAT_SUP) AS VALUE, ID_CONTRACTOR
	FROM #LM WHERE DATE_OP BETWEEN @DATE_FROM AND @DATE_TO AND 
		CODE_OP = 'INVOICE' AND (ID_SUPPLIER <> @ID_CONTRACTOR_STU OR @ID_CONTRACTOR_STU IS NULL)
	GROUP BY ID_CONTRACTOR
	) T, @RESULT R
	WHERE T.ID_CONTRACTOR = R.ID_CONTRACTOR
END

-- Считаем акты возврата от покупателя
UPDATE @RESULT SET RETURN_BUYER_DEBET = T.VALUE
FROM 
(
SELECT SUM(SUM_SUP_VAT) AS VALUE, ID_CONTRACTOR
FROM #LM WHERE DATE_CLOSE IS NULL AND DATE_OP BETWEEN @DATE_FROM AND @DATE_TO
	AND CODE_OP = 'ACT_R2B' /*OR (CODE_OP = 'CHEQUE' AND QUANTITY_SUB < 0)*/
GROUP BY ID_CONTRACTOR
) T, @RESULT R
WHERE T.ID_CONTRACTOR = R.ID_CONTRACTOR

-- Считаем чеки возврата
UPDATE @RESULT SET RETURN_BUYER_DEBET = ISNULL(RETURN_BUYER_DEBET, 0) + ISNULL(T.VALUE, 0)
FROM 
(
SELECT SUM(SUM_SUP_VAT) AS VALUE, ID_CONTRACTOR
FROM #LM WHERE DATE_CLOSE IS NOT NULL AND DATE_CLOSE BETWEEN @DATE_FROM AND @DATE_TO
	AND(CODE_OP = 'CHEQUE' AND QUANTITY_SUB < 0)
GROUP BY ID_CONTRACTOR
) T, @RESULT R
WHERE T.ID_CONTRACTOR = R.ID_CONTRACTOR

-- 6
UPDATE @RESULT SET MOVEMENT_DEBET = T.VALUE
FROM 
(
SELECT SUM(SUM_SUP_VAT) AS VALUE, ID_CONTRACTOR
FROM #LM WHERE DATE_OP BETWEEN @DATE_FROM AND @DATE_TO 
	AND CODE_OP = 'MOVE' AND QUANTITY_ADD > 0
GROUP BY ID_CONTRACTOR
) T, @RESULT R
WHERE T.ID_CONTRACTOR = R.ID_CONTRACTOR

-- 7
UPDATE @RESULT SET IZLISHKI_DEBET = T.VALUE
FROM 
(
SELECT SUM(SUM_SUP_VAT) AS VALUE, ID_CONTRACTOR
FROM #LM WHERE DATE_OP BETWEEN @DATE_FROM AND @DATE_TO 
	AND CODE_OP = 'INVENTORY_SVED' AND ISNULL(QUANTITY_ADD, 0) > 0
GROUP BY ID_CONTRACTOR
) T, @RESULT R
WHERE T.ID_CONTRACTOR = R.ID_CONTRACTOR

UPDATE @RESULT SET DIS_REVAL_DEBET = T.VALUE
FROM 
(
SELECT SUM(SUM_SUP_VAT) AS VALUE, ID_CONTRACTOR
FROM #LM WHERE DATE_OP BETWEEN @DATE_FROM AND @DATE_TO 
	AND (CODE_OP = 'ACT_REV' OR CODE_OP = 'DIS') AND ISNULL(QUANTITY_ADD, 0) > 0
GROUP BY ID_CONTRACTOR
) T, @RESULT R
WHERE T.ID_CONTRACTOR = R.ID_CONTRACTOR

-- 8
UPDATE @RESULT SET TOTAL_DEBET = ISNULL(INVOICE_DEBET, 0) + ISNULL(RETURN_BUYER_DEBET, 0) + ISNULL(MOVEMENT_DEBET, 0) 
	+ ISNULL(IZLISHKI_DEBET, 0) + ISNULL(DIS_REVAL_DEBET, 0)

-- 9
UPDATE @RESULT SET COST_CREDIT = T.VALUE
FROM 
(
SELECT SUM(SUM_SUP_VAT) AS VALUE, ID_CONTRACTOR
FROM #LM 
INNER JOIN INVOICE_OUT INV_OUT ON INV_OUT.ID_INVOICE_OUT_GLOBAL = #LM.ID_DOCUMENT
WHERE DATE_CLOSE IS NULL AND DATE_OP BETWEEN @DATE_FROM AND @DATE_TO AND ISNULL(INV_OUT.IS_SUPPLIER, 1) = 0
	AND CODE_OP = 'INVOICE_OUT'
GROUP BY ID_CONTRACTOR
) T, @RESULT R
WHERE T.ID_CONTRACTOR = R.ID_CONTRACTOR

-- Считаем чеки продажи
UPDATE @RESULT SET COST_CREDIT = ISNULL(COST_CREDIT, 0) + ISNULL(T.VALUE, 0)
FROM 
(
SELECT SUM(SUM_SUP_VAT) AS VALUE, ID_CONTRACTOR
FROM #LM WHERE DATE_CLOSE IS NOT NULL AND DATE_CLOSE BETWEEN @DATE_FROM AND @DATE_TO
	AND(CODE_OP = 'CHEQUE' AND QUANTITY_SUB > 0)
GROUP BY ID_CONTRACTOR
) T, @RESULT R
WHERE T.ID_CONTRACTOR = R.ID_CONTRACTOR

-- 10
UPDATE @RESULT SET RETURN_SUPPLIER_CRETID = T.VALUE
FROM 
(
SELECT SUM(SUM_SUP_VAT) AS VALUE, ID_CONTRACTOR
FROM #LM WHERE DATE_OP BETWEEN @DATE_FROM AND @DATE_TO 
	AND CODE_OP = 'ACT_R2C'
GROUP BY ID_CONTRACTOR
) T, @RESULT R
WHERE T.ID_CONTRACTOR = R.ID_CONTRACTOR


-- 11
UPDATE @RESULT SET RETURN_SUPPLIER_BACK = ISNULL(RETURN_SUPPLIER_BACK, 0) + ISNULL(T.VALUE, 0)
FROM 
(
SELECT SUM(SUM_SUP_VAT) AS VALUE, ID_CONTRACTOR
FROM #LM 
INNER JOIN INVOICE_OUT INV_OUT ON INV_OUT.ID_INVOICE_OUT_GLOBAL = #LM.ID_DOCUMENT
WHERE DATE_CLOSE IS NULL AND DATE_OP BETWEEN @DATE_FROM AND @DATE_TO AND ISNULL(INV_OUT.IS_SUPPLIER, 1) = 1
	AND CODE_OP = 'INVOICE_OUT'
GROUP BY ID_CONTRACTOR
) T, @RESULT R
WHERE T.ID_CONTRACTOR = R.ID_CONTRACTOR

-- 12
UPDATE @RESULT SET NEDOSTACHI_CREDIT = T.VALUE
FROM 
(
SELECT SUM(SUM_SUP_VAT) AS VALUE, ID_CONTRACTOR
FROM #LM WHERE DATE_OP BETWEEN @DATE_FROM AND @DATE_TO 
	AND CODE_OP = 'INVENTORY_SVED' AND ISNULL(QUANTITY_SUB, 0) > 0
GROUP BY ID_CONTRACTOR
) T, @RESULT R
WHERE T.ID_CONTRACTOR = R.ID_CONTRACTOR

-- 13
UPDATE @RESULT SET SPISANIYA_CREDIT = T.VALUE
FROM 
(
SELECT SUM(SUM_SUP_VAT) AS VALUE, ID_CONTRACTOR
FROM #LM WHERE DATE_OP BETWEEN @DATE_FROM AND @DATE_TO 
	AND CODE_OP = 'DED'
GROUP BY ID_CONTRACTOR
) T, @RESULT R
WHERE T.ID_CONTRACTOR = R.ID_CONTRACTOR

-- 14
UPDATE @RESULT SET MOVEMENT_CREDIT = T.VALUE
FROM 
(
SELECT SUM(SUM_SUP_VAT) AS VALUE, ID_CONTRACTOR
FROM #LM WHERE DATE_OP BETWEEN @DATE_FROM AND @DATE_TO 
	AND CODE_OP = 'MOVE' AND QUANTITY_SUB > 0
GROUP BY ID_CONTRACTOR
) T, @RESULT R
WHERE T.ID_CONTRACTOR = R.ID_CONTRACTOR

UPDATE @RESULT SET DIS_REVAL_CREDIT = T.VALUE
FROM 
(
SELECT SUM(SUM_SUP_VAT) AS VALUE, ID_CONTRACTOR
FROM #LM WHERE DATE_OP BETWEEN @DATE_FROM AND @DATE_TO 
	AND (CODE_OP = 'ACT_REV' OR CODE_OP = 'DIS') AND ISNULL(QUANTITY_SUB, 0) > 0
GROUP BY ID_CONTRACTOR
) T, @RESULT R
WHERE T.ID_CONTRACTOR = R.ID_CONTRACTOR

-- 15
UPDATE @RESULT SET TOTAL_CREDIT = ISNULL(COST_CREDIT, 0) + ISNULL(RETURN_SUPPLIER_CRETID, 0) + 
			ISNULL(NEDOSTACHI_CREDIT, 0) + ISNULL(SPISANIYA_CREDIT, 0) + ISNULL(MOVEMENT_CREDIT, 0) + ISNULL(DIS_REVAL_CREDIT, 0)

--17
UPDATE R SET CASH_SUM = T.SUM_CASH
FROM @RESULT R
INNER JOIN (SELECT SUM_CASH = SUM(CS.SUM_SALES - CS.SUM_SALES_RETURNS), S.ID_CONTRACTOR
    FROM CASH_SESSION CS 
    INNER JOIN CASH_REGISTER_2_STORE CR ON CR.ID_CASH_REGISTER = CS.ID_CASH_REGISTER
    INNER JOIN STORE S ON S.ID_STORE = CR.ID_STORE
    WHERE CS.DATE_CLOSE BETWEEN @DATE_FROM AND @DATE_TO
    GROUP BY S.ID_CONTRACTOR) T ON T.ID_CONTRACTOR = R.ID_CONTRACTOR

SELECT R.*, C.NAME AS CONTRACTOR_NAME FROM @RESULT R INNER JOIN CONTRACTOR C ON C.ID_CONTRACTOR = R.ID_CONTRACTOR

RETURN 0
GO


