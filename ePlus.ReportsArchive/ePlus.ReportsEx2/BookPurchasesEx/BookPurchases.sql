SET NOCOUNT ON
SET QUOTED_IDENTIFIER OFF
GO

IF (OBJECT_ID('DBO.REPEX_BOOK_PURCHASES') IS NULL) EXEC ('CREATE PROCEDURE DBO.REPEX_BOOK_PURCHASES AS RETURN')
GO
ALTER PROCEDURE DBO.REPEX_BOOK_PURCHASES
    @XMLPARAM NTEXT AS

DECLARE @HDOC INT

DECLARE 
    @DATE_FROM DATETIME, 
    @DATE_TO DATETIME,
	@ONE_OF BIT,
	@ALL_CONTRACTORS BIT,
	@ALL_SUPPLIERS BIT,
	@INC BIT

DECLARE @CONTRACTORS TABLE(CONTRACTOR_NAME VARCHAR(128))

EXEC SP_XML_PREPAREDOCUMENT @HDOC OUT, @XMLPARAM OUT
SELECT 
    @DATE_FROM = DATE_FROM,
    @DATE_TO = DATE_TO,
	@INC = INC
FROM OPENXML(@HDOC, '/XML') WITH(
    DATE_FROM DATETIME 'DATE_FROM',
    DATE_TO DATETIME 'DATE_TO',
	INC BIT 'INC'
)

SELECT ID_CONTRACTOR INTO #CONTRACTORS
FROM OPENXML(@HDOC, '/XML/ID_CONTRACTOR') WITH(ID_CONTRACTOR BIGINT '.')
IF (@@ROWCOUNT = 0)
	SET @ALL_CONTRACTORS = 1

SELECT ID_SUPPLIER INTO #SUPPLIERS
FROM OPENXML(@HDOC, '/XML/ID_SUPPLIER') WITH(ID_SUPPLIER BIGINT '.')
IF (@@ROWCOUNT = 0)
	SET @ALL_SUPPLIERS = 1

--select @all_suppliers, @all_contractors, @inc

EXEC SP_XML_REMOVEDOCUMENT @HDOC

EXEC USP_RANGE_DAYS @DATE_FROM OUT, @DATE_TO OUT
EXEC USP_RANGE_NORM @DATE_FROM OUT, @DATE_TO OUT

--select * from #contractors
--select * from #suppliers

IF (@INC = 1)
BEGIN
SELECT
    MNEMOCODE = I.MNEMOCODE,
    I.ID_CONTRACTOR_SUPPLIER,
    STATE = I.DOCUMENT_STATE,
    DATE_AND_NUM = ISNULL(CONVERT(VARCHAR, I.INCOMING_BILL_DATE, 104), '') + CASE WHEN I.INCOMING_BILL_NUMBER IS NULL THEN '' ELSE '/' + I.INCOMING_BILL_NUMBER END,
    BILL_NUMBER = I.INCOMING_BILL_NUMBER,
    BILL_DATE = CONVERT(VARCHAR, I.INCOMING_BILL_DATE, 104),
    DATE_PAYMENT = CONVERT(VARCHAR, I.DATE_PAYMENT, 104),
    DOC_DATE = I.DOCUMENT_DATE,
    ID_CONTRACTOR = C.ID_CONTRACTOR,
    CONTRACTOR_NAME = C.NAME,
    INN = C.INN,
    KPP = C.KPP,
    SUPP_SUM_VAT = SUM(II.SUPPLIER_SUM_VAT),
    SUPPLIER_VAT_RATE_18 = SUM(CASE WHEN II.SUPPLIER_VAT = 18.0 THEN II.SUPPLIER_VAT_SUM ELSE 0 END),
    SUPPLIER_SUM_18 = SUM(CASE WHEN II.SUPPLIER_VAT = 18.0 THEN II.SUPPLIER_SUM ELSE 0 END),
    SUPPLIER_VAT_RATE_10 = SUM(CASE WHEN II.SUPPLIER_VAT = 10.0 THEN II.SUPPLIER_VAT_SUM ELSE 0 END),
    SUPPLIER_SUM_10 = SUM(CASE WHEN II.SUPPLIER_VAT = 10.0 THEN II.SUPPLIER_SUM ELSE 0 END),
    SUPPLIER_SUM_0 = SUM(CASE WHEN II.SUPPLIER_VAT = 0.0 THEN II.SUPPLIER_SUM ELSE 0 END)
FROM INVOICE I
	INNER JOIN INVOICE_ITEM II ON I.ID_INVOICE_GLOBAL = II.ID_INVOICE_GLOBAL		 
	INNER JOIN CONTRACTOR C ON C.ID_CONTRACTOR = I.ID_CONTRACTOR_SUPPLIER
	INNER JOIN STORE S ON I.ID_STORE = S.ID_STORE
	INNER JOIN CONTRACTOR SELF ON SELF.ID_CONTRACTOR = S.ID_CONTRACTOR
WHERE I.DOCUMENT_STATE = 'PROC'
	AND (I.DOCUMENT_DATE BETWEEN @DATE_FROM AND @DATE_TO)
	AND (@ALL_CONTRACTORS = 1 OR (SELF.ID_CONTRACTOR IN (SELECT ID_CONTRACTOR FROM #CONTRACTORS)))
	AND (@ALL_SUPPLIERS = 1 OR (C.ID_CONTRACTOR IN (SELECT ID_SUPPLIER FROM #SUPPLIERS)))
GROUP BY I.MNEMOCODE, I.INCOMING_BILL_NUMBER, I.INCOMING_BILL_DATE, I.DATE_PAYMENT, I.DOCUMENT_DATE, C.ID_CONTRACTOR, C.NAME, C.INN, C.KPP, I.DOCUMENT_STATE, I.ID_CONTRACTOR_SUPPLIER
ORDER BY I.INCOMING_BILL_DATE, BILL_NUMBER
END
ELSE
BEGIN
SELECT
    MNEMOCODE = I.MNEMOCODE,
    I.ID_CONTRACTOR_SUPPLIER,
    STATE = I.DOCUMENT_STATE,
    DATE_AND_NUM = ISNULL(CONVERT(VARCHAR, I.INCOMING_BILL_DATE, 104), '') + CASE WHEN I.INCOMING_BILL_NUMBER IS NULL THEN '' ELSE '/' + I.INCOMING_BILL_NUMBER END,
    BILL_NUMBER = I.INCOMING_BILL_NUMBER,
    BILL_DATE = CONVERT(VARCHAR, I.INCOMING_BILL_DATE, 104),
    DATE_PAYMENT = CONVERT(VARCHAR, I.DATE_PAYMENT, 104),
    DOC_DATE = I.DOCUMENT_DATE,
    ID_CONTRACTOR = C.ID_CONTRACTOR,
    CONTRACTOR_NAME = C.NAME,
    INN = C.INN,
    KPP = C.KPP,
    SUPP_SUM_VAT = SUM(II.SUPPLIER_SUM_VAT),
    SUPPLIER_VAT_RATE_18 = SUM(CASE WHEN II.SUPPLIER_VAT = 18.0 THEN II.SUPPLIER_VAT_SUM ELSE 0 END),
    SUPPLIER_SUM_18 = SUM(CASE WHEN II.SUPPLIER_VAT = 18.0 THEN II.SUPPLIER_SUM ELSE 0 END),
    SUPPLIER_VAT_RATE_10 = SUM(CASE WHEN II.SUPPLIER_VAT = 10.0 THEN II.SUPPLIER_VAT_SUM ELSE 0 END),
    SUPPLIER_SUM_10 = SUM(CASE WHEN II.SUPPLIER_VAT = 10.0 THEN II.SUPPLIER_SUM ELSE 0 END),
    SUPPLIER_SUM_0 = SUM(CASE WHEN II.SUPPLIER_VAT = 0.0 THEN II.SUPPLIER_SUM ELSE 0 END)
FROM INVOICE I
	INNER JOIN INVOICE_ITEM II ON I.ID_INVOICE_GLOBAL = II.ID_INVOICE_GLOBAL		 
	INNER JOIN CONTRACTOR C ON C.ID_CONTRACTOR = I.ID_CONTRACTOR_SUPPLIER
	INNER JOIN STORE S ON I.ID_STORE = S.ID_STORE
	INNER JOIN CONTRACTOR SELF ON SELF.ID_CONTRACTOR = S.ID_CONTRACTOR
WHERE I.DOCUMENT_STATE = 'PROC'
	AND (I.DOCUMENT_DATE BETWEEN @DATE_FROM AND @DATE_TO)
	AND (@ALL_CONTRACTORS = 1 OR (SELF.ID_CONTRACTOR IN (SELECT ID_CONTRACTOR FROM #CONTRACTORS)))
	AND (C.ID_CONTRACTOR NOT IN (SELECT ID_SUPPLIER FROM #SUPPLIERS))
GROUP BY I.MNEMOCODE, I.INCOMING_BILL_NUMBER, I.INCOMING_BILL_DATE, I.DATE_PAYMENT, I.DOCUMENT_DATE, C.ID_CONTRACTOR, C.NAME, C.INN, C.KPP, I.DOCUMENT_STATE, I.ID_CONTRACTOR_SUPPLIER
ORDER BY I.INCOMING_BILL_DATE, BILL_NUMBER
END


INSERT INTO @CONTRACTORS
SELECT 
	CONTRACTOR_NAME = CASE WHEN ISNULL(FULL_NAME, '') = '' THEN NAME ELSE FULL_NAME END
FROM CONTRACTOR
WHERE ID_CONTRACTOR IN (SELECT ID_CONTRACTOR FROM #CONTRACTORS)

DECLARE @CONTRACTOR_STRING VARCHAR(4000)

SELECT 
    @CONTRACTOR_STRING = ISNULL(@CONTRACTOR_STRING+', '+C.CONTRACTOR_NAME, C.CONTRACTOR_NAME)
FROM @CONTRACTORS C
SELECT CONTRACTOR_NAME = @CONTRACTOR_STRING
	
SELECT
	DIRECTOR_FIO,
	BUH_FIO
FROM CONTRACTOR
WHERE ID_CONTRACTOR = (SELECT TOP 1 ID_CONTRACTOR FROM ENTERPRISE_BRANCH WHERE IS_SELF = 1)

RETURN
GO

/*
exec REPEX_BOOK_PURCHASES N'
<XML>
	<DATE_FROM>2009-08-01T00:00:00.000</DATE_FROM>
	<DATE_TO>2009-08-17T00:00:00.000</DATE_TO>	
	<ID_CONTRACTOR>5271</ID_CONTRACTOR>
	<ID_SUPPLIER>5281</ID_SUPPLIER>
	<ID_SUPPLIER>5288</ID_SUPPLIER>
	<ID_SUPPLIER>5270</ID_SUPPLIER>	
	<INC>1</INC>	
</XML>'*/
