SET NOCOUNT ON
SET QUOTED_IDENTIFIER OFF
GO

IF OBJECT_ID('DBO.REPEX_ACT_DEDUCTION_TORG_16') IS NULL EXEC('CREATE PROCEDURE DBO.REPEX_ACT_DEDUCTION_TORG_16 AS RETURN')
GO
ALTER PROCEDURE DBO.REPEX_ACT_DEDUCTION_TORG_16
	@XMLPARAM NTEXT AS
		
DECLARE	@HDOC INT
DECLARE @ID_GLOBAL UNIQUEIDENTIFIER
		
EXEC SP_XML_PREPAREDOCUMENT @HDOC OUTPUT, @XMLPARAM OUTPUT
		
SELECT @ID_GLOBAL = ID_GLOBAL
FROM OPENXML(@HDOC , '/XML') WITH(ID_GLOBAL UNIQUEIDENTIFIER 'ID_GLOBAL')
		
EXEC SP_XML_REMOVEDOCUMENT @HDOC

SELECT
	CONTRACTOR = C.FULL_NAME,
	STORE = S.NAME,
	DOC_NUM = AD.MNEMOCODE
FROM ACT_DEDUCTION AD
	INNER JOIN STORE S ON S.ID_STORE = AD.ID_STORE
	INNER JOIN CONTRACTOR C ON C.ID_CONTRACTOR = S.ID_CONTRACTOR
	LEFT JOIN INVOICE I ON I.ID_INVOICE = AD.ID_BASE_DOCUMENT
WHERE AD.ID_ACT_DEDUCTION_GLOBAL = @ID_GLOBAL

SELECT
	GOODS_NAME = G.NAME,
	ID_GOODS = ADI.ID_GOODS,
	UNIT_NAME = U.NAME,
	OKEI_CODE = U.OKEI_CODE,
	QUANTITY = ADI.QUANTITY,
	PRICE_SAL = ADI.PRICE_ACC,
	SUM_SAL = ADI.SUM_ACC
FROM ACT_DEDUCTION_ITEM ADI
	INNER JOIN GOODS G ON G.ID_GOODS = ADI.ID_GOODS
	LEFT JOIN LOT L ON L.ID_LOT_GLOBAL = ADI.ID_LOT_GLOBAL
	INNER JOIN SCALING_RATIO SR ON SR.ID_SCALING_RATIO = L.ID_SCALING_RATIO
	INNER JOIN UNIT U ON U.ID_UNIT = SR.ID_UNIT
WHERE ADI.ID_ACT_DEDUCTION_GLOBAL = @ID_GLOBAL
ORDER BY G.NAME

SELECT DISTINCT
	INCOME_DATE = L.INVOICE_DATE,
	DEDUCTION_DATE = AD.DATE,
	INCOMING_NUMBER = L.INCOMING_NUM,
	INCOMING_DATE = L.INCOMING_DATE
FROM ACT_DEDUCTION AD
	INNER JOIN ACT_DEDUCTION_ITEM ADI ON ADI.ID_ACT_DEDUCTION_GLOBAL = AD.ID_ACT_DEDUCTION_GLOBAL
	INNER JOIN LOT L ON L.ID_LOT_GLOBAL = ADI.ID_LOT_GLOBAL
WHERE AD.ID_ACT_DEDUCTION_GLOBAL = @ID_GLOBAL
ORDER BY L.INVOICE_DATE
	
RETURN 0
GO

--exec REPEX_ACT_DEDUCTION_TORG_16 N'<XML><ID_GLOBAL>F1BCAAE6-AB30-4787-99A8-1A109B014FF3</ID_GLOBAL></XML>'

