SET NOCOUNT ON
SET QUOTED_IDENTIFIER OFF
GO

IF OBJECT_ID('DBO.REPEX_SERVICE_PRICE_LIST') IS NULL EXEC('CREATE PROCEDURE DBO.REPEX_SERVICE_PRICE_LIST AS RETURN')
GO
ALTER PROCEDURE DBO.REPEX_SERVICE_PRICE_LIST
	@XMLPARAM NTEXT AS
		
DECLARE	@HDOC INT
DECLARE @ID_GLOBAL UNIQUEIDENTIFIER
		
EXEC SP_XML_PREPAREDOCUMENT @HDOC OUTPUT, @XMLPARAM OUTPUT		
SELECT @ID_GLOBAL = ID_GLOBAL FROM OPENXML(@HDOC , '/XML') WITH(ID_GLOBAL UNIQUEIDENTIFIER 'ID_GLOBAL')		
EXEC SP_XML_REMOVEDOCUMENT @HDOC

SELECT 
	CONTRACTOR = C.[NAME],
	STORE = NULL
FROM SERVICE_PRICE_LIST AS PL
	INNER JOIN CONTRACTOR AS C ON C.ID_CONTRACTOR = PL.ID_CONTRACTOR
WHERE PL.ID_SERVICE_PRICE_LIST = @ID_GLOBAL

SELECT
	SERVICE_NAME = S.NAME,
	QUANTITY = PLIC.QUANTITY,
	PRICE_SAL = PLIC.PRICE_SAL,
	SUM_SAL = PLIC.QUANTITY * PLIC.PRICE_SAL,
	LIST_NAME = PLI.NAME
FROM SERVICE_PRICE_LIST_ITEM AS PLI
	INNER JOIN SERVICE_PRICE_LIST_ITEM_COMPLEX AS PLIC ON PLIC.ID_SERVICE_PRICE_LIST_ITEM = PLI.ID_SERVICE_PRICE_LIST_ITEM
	INNER JOIN SERVICE AS S ON S.ID_SERVICE = PLIC.ID_SERVICE
	INNER JOIN SERVICE_4_SALE S4S ON S4S.ID_DOCUMENT_ITEM = PLI.id_Service_price_list_item
WHERE PLI.ID_SERVICE_PRICE_LIST = @ID_GLOBAL AND S4S.CAN_SALE = 1
ORDER BY LIST_NAME, SERVICE_NAME
	
RETURN 0
GO

--exec REPEX_SERVICE_PRICE_LIST N'<XML><ID_GLOBAL>EAF23FB4-56A6-4584-BD55-2F13AE7848B9</ID_GLOBAL></XML>'
