SET NOCOUNT ON
SET QUOTED_IDENTIFIER OFF
GO

IF (OBJECT_ID('DBO.REPEX_INTERNET_INVOICE_CHEQUE') IS NULL) EXEC ('CREATE PROCEDURE DBO.REPEX_INTERNET_INVOICE_CHEQUE AS RETURN')
GO
ALTER PROCEDURE DBO.REPEX_INTERNET_INVOICE_CHEQUE
    @XMLPARAM NTEXT
AS

DECLARE	@HDOC INT
DECLARE @ID_GLOBAL UNIQUEIDENTIFIER

EXEC SP_XML_PREPAREDOCUMENT @HDOC OUTPUT, @XMLPARAM OUTPUT
SELECT @ID_GLOBAL = ID_GLOBAL  FROM OPENXML(@HDOC, '/XML') WITH(ID_GLOBAL UNIQUEIDENTIFIER 'ID_GLOBAL')
EXEC SP_XML_REMOVEDOCUMENT @HDOC

DECLARE @CONTRACTOR_SELF_NAME VARCHAR(50)
DECLARE @CONTRACTOR_SELF_ADDRESS VARCHAR(50)
SELECT TOP 1 @CONTRACTOR_SELF_NAME=NAME, @CONTRACTOR_SELF_ADDRESS=ADDRESS FROM CONTRACTOR WHERE ID_CONTRACTOR_GLOBAL = dbo.FN_CONTRACTOR_SELF_GLOBAL()

SELECT 
	NUMBER_DOC = I_O.NUMBER_DOC,--Заказ
	DATE_CREATE =CONVERT(VARCHAR, I_O.DATE_CREATE, 104),--От
	DATE_DELIVERY =CONVERT(VARCHAR, I_O.DATE_DELIVERY, 104),--Доставка к
	DATE_CHEQUE ='',--Чек к(пустое поле)
	CONTRACTOR_FROM_SHORT_NAME = @CONTRACTOR_SELF_NAME,--Поставщик	
	CONTRACTOR_FROM_ADDRESS = @CONTRACTOR_SELF_ADDRESS,--Адрес
	CONTRACTOR_TO_SHORT_NAME = CT_EM.NAME,--Предприятие
	NAME_CLIENTA_TO = ISNULL(IOE.LAST_NAME+' ','')+ISNULL(IOE.FIRST_NAME+' ','')+ISNULL(IOE.MIDDLE_NAME,''),--Получатель
	ROOM= IOE.ROOM,--Комната
	TEL_1_TEL_2 = ISNULL(IOE.TEL_1+', ','')+ISNULL(IOE.TEL_2,''),--Тел.служебный
	ADDRESS_TO = IOA.ADDRESS --Адрес
FROM INTERNET_ORDER I_O 
	inner JOIN INTERNET_ORDER_EMPLOYEE IOE ON IOE.ID_INTERNET_ORDER_EMPLOYEE_GLOBAL=I_O.ID_INTERNET_ORDER_EMPLOYEE_GLOBAL
	inner JOIN CONTRACTOR CT_EM ON CT_EM.ID_CONTRACTOR = I_O.ID_CONTRACTOR
	inner JOIN INTERNET_ORDER_ADDRESS IOA ON IOA.ID_INTERNET_ORDER_ADDRESS_GLOBAL = I_O.ID_INTERNET_ORDER_ADDRESS_GLOBAL
WHERE I_O.ID_INTERNET_ORDER_GLOBAL = @ID_GLOBAL


---- нужно учесть скидки
SELECT
	GOODS_NAME = G.NAME,
	BARCODE = L.INTERNAL_BARCODE,
	QUANTITY = IOI.QUANTITY,
	PRICE_SAL =L.PRICE_SAL- (CI.SUMM_DISCOUNT/IOI.QUANTITY),
	CODE = G.CODE
FROM INTERNET_ORDER_ITEM IOI
	inner JOIN LOT L ON L.ID_LOT_GLOBAL = IOI.ID_LOT_GLOBAL
	inner JOIN GOODS G ON G.ID_GOODS = IOI.ID_GOODS
	inner join CHEQUE CH ON CH.ID_DOCUMENT_BASE_GLOBAL = IOI.ID_INTERNET_ORDER_GLOBAL
	inner join CHEQUE_ITEM CI ON  CI.ID_CHEQUE_GLOBAL = CH.ID_CHEQUE_GLOBAL AND CI.ID_GOODS = IOI.ID_GOODS
WHERE IOI.ID_INTERNET_ORDER_GLOBAL = @ID_GLOBAL
ORDER BY GOODS_NAME

RETURN
GO

--exec DBO.REPEX_INTERNET_INVOICE_CHEQUE '<XML><ID_GLOBAL>0564bb00-61f8-42ec-ab19-e4da3b72f3b0</ID_GLOBAL></XML>'