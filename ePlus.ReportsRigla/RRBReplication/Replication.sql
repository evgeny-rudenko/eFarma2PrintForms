SET NOCOUNT ON
SET QUOTED_IDENTIFIER OFF
GO
------------------------------------------------------------------------------------------------------------------------------------
IF OBJECT_ID(N'DBO.FN_REPEX_REPLICATION_GETLOG_MAX_DATE', N'FN') IS NOT NULL 
	DROP FUNCTION DBO.FN_REPEX_REPLICATION_GETLOG_MAX_DATE
GO
CREATE FUNCTION DBO.FN_REPEX_REPLICATION_GETLOG_MAX_DATE
    (@ID_REPLICATION_SESSION uniqueidentifier)
	RETURNS DATETIME
	AS
BEGIN
	DECLARE @DATE_OP DATETIME
	SELECT    @DATE_OP = MAX(DATE_OP) 
		FROM REPLICATION_SESSION_LOG RS_L
		WHERE (RS_L.ID_REPLICATION_SESSION = @ID_REPLICATION_SESSION)
		GROUP BY ID_REPLICATION_SESSION
	RETURN @DATE_OP
END
GO
------------------------------------------------------------------------------------------------------------------------------------
SET NOCOUNT ON
SET QUOTED_IDENTIFIER OFF
GO

IF OBJECT_ID('DBO.REPEX_REPLICATION') IS NULL EXEC('CREATE PROCEDURE DBO.REPEX_REPLICATION AS RETURN')
GO
ALTER  PROCEDURE DBO.REPEX_REPLICATION
    @XMLPARAM NTEXT AS
	DECLARE @HDOC INT
	DECLARE @ALL_AU BIT
	DECLARE @CO BIT
	------------------------------------
	DECLARE @DATE_LATE DATETIME
	SET @DATE_LATE = GETDATE()-2 -- CONVERT(DATETIME, '01.02.2011',104)-2   --
	EXEC USP_RANGE_DAYS @DATE_LATE OUT, @DATE_LATE OUT
	------------------------------------				
	SELECT 
		ID_CONTRACTOR_GLOBAL 
		INTO #CONTRACTOR 
		FROM REPLICATION_CONFIG 
		WHERE IS_ACTIVE=1 
				and IS_SELF = 0
	
	SELECT 
		ID_CONTRACTOR_FROM_GLOBAL
		,SN = MAX(SESSION_NUMBER)
		into #LAST_SESSION
	FROM REPLICATION_SESSION
	WHERE ID_CONTRACTOR_FROM_GLOBAL IN (SELECT ID_CONTRACTOR_GLOBAL FROM #CONTRACTOR)
			AND direction = 'IMP' AND REPLICATION_MODEL = 'DOC' 
	GROUP BY ID_CONTRACTOR_FROM_GLOBAL

	SELECT 
		ID_CONTRACTOR_FROM_GLOBAL
		,SN = SESSION_NUMBER
		,ID_REPLICATION_SESSION 
		into #ERR_SESSION
	FROM REPLICATION_SESSION
	WHERE ID_CONTRACTOR_FROM_GLOBAL IN (SELECT ID_CONTRACTOR_GLOBAL FROM #CONTRACTOR)
			AND direction = 'IMP' AND REPLICATION_MODEL = 'DOC' and SESSION_STATE='IMP_ERR'
			and (SESSION_NUMBER not in (select sn from #LAST_SESSION))
SELECT *
from
	(
	SELECT 
		NAME_AP = C.NAME
		,CREATED_DATE_SESSION = RS.CREATED_DATE
		,DATE_UPLOAD_CO = DBO.FN_REPEX_REPLICATION_GETLOG_MAX_DATE(RS.ID_REPLICATION_SESSION)
		,MSG_TYPE =CASE WHEN RS.SESSION_STATE='IMP_ERR' THEN 'ERR' ELSE CASE WHEN CREATED_DATE >= @DATE_LATE THEN 'OK' ELSE 'LATE' END END
		,LAST_UPLOAD_SESSION_NUM = SN
		,CODE_AP = RC.GLOBAL_CODE
	FROM 
		(
		SELECT * FROM #LAST_SESSION
		) T
	INNER JOIN CONTRACTOR C ON C.ID_CONTRACTOR_GLOBAL = ID_CONTRACTOR_FROM_GLOBAL
	INNER JOIN REPLICATION_SESSION RS ON RS.ID_CONTRACTOR_FROM_GLOBAL = T.ID_CONTRACTOR_FROM_GLOBAL
		and RS.SESSION_NUMBER = T.SN AND REPLICATION_MODEL = 'DOC'
	INNER JOIN REPLICATION_CONFIG RC ON RC.ID_CONTRACTOR_GLOBAL = T.ID_CONTRACTOR_FROM_GLOBAL

	
	UNION ALL
	
	
	SELECT 
		NAME_AP = C.NAME
		,CREATED_DATE_SESSION = null
		,DATE_UPLOAD_CO = null
		,MSG_TYPE ='LATE'
		,LAST_UPLOAD_SESSION_NUM = SN
		,CODE_AP = RC.GLOBAL_CODE
	FROM	
        (
        SELECT ID_CONTRACTOR_GLOBAL, SN =null
        FROM #CONTRACTOR
        WHERE ID_CONTRACTOR_GLOBAL not in (SELECT ID_CONTRACTOR_FROM_GLOBAL FROM #LAST_SESSION )
			
        ) T
    INNER JOIN CONTRACTOR C ON C.ID_CONTRACTOR_GLOBAL = T.ID_CONTRACTOR_GLOBAL
    INNER JOIN REPLICATION_CONFIG RC ON RC.ID_CONTRACTOR_GLOBAL = T.ID_CONTRACTOR_GLOBAL
   	
   UNION ALL
	SELECT 
		NAME_AP = C.NAME
		,CREATED_DATE_SESSION = RS.CREATED_DATE
		,DATE_UPLOAD_CO = DBO.FN_REPEX_REPLICATION_GETLOG_MAX_DATE(RS.ID_REPLICATION_SESSION)
		,MSG_TYPE =CASE WHEN RS.SESSION_STATE='IMP_ERR' THEN 'ERR' ELSE CASE WHEN CREATED_DATE >= @DATE_LATE THEN 'OK' ELSE 'LATE' END END
		,LAST_UPLOAD_SESSION_NUM = T.SN
		,CODE_AP = RC.GLOBAL_CODE
	FROM	
        (
		 SELECT * FROM #ERR_SESSION 
        ) T
	INNER JOIN CONTRACTOR C ON C.ID_CONTRACTOR_GLOBAL = ID_CONTRACTOR_FROM_GLOBAL
	INNER JOIN REPLICATION_SESSION RS ON RS.ID_REPLICATION_SESSION = T.ID_REPLICATION_SESSION
		and RS.SESSION_NUMBER = T.SN AND REPLICATION_MODEL = 'DOC'
	INNER JOIN REPLICATION_CONFIG RC ON RC.ID_CONTRACTOR_GLOBAL = T.ID_CONTRACTOR_FROM_GLOBAL
	) L
ORDER BY CODE_AP

RETURN
GO


--exec REPEX_REPLICATION @xmlParam=N''
