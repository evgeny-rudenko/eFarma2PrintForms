SET NOCOUNT ON
SET QUOTED_IDENTIFIER OFF
GO 

IF OBJECT_ID('DBO.REPEX_SVYAZ_CARDS') IS NULL EXEC('CREATE PROCEDURE DBO.REPEX_SVYAZ_CARDS AS RETURN')
GO
ALTER PROCEDURE DBO.REPEX_SVYAZ_CARDS 
	@XMLPARAM NTEXT AS

DECLARE @HDOC INT
DECLARE @DATE_FR DATETIME
DECLARE @DATE_TO DATETIME
DECLARE @ALL_CONTRACTORS BIT
DECLARE @ALL_CARDS BIT

EXEC SP_XML_PREPAREDOCUMENT @HDOC OUTPUT, @XMLPARAM OUTPUT

SELECT @DATE_FR = DATE_FR, @DATE_TO = DATE_TO FROM OPENXML(@HDOC, '/XML')
WITH (DATE_FR DATETIME 'DATE_FR', DATE_TO DATETIME 'DATE_TO')

SELECT * INTO #CONTRACTORS FROM OPENXML(@HDOC, '//ID_CONTRACTOR') WITH(ID_CONTRACTOR BIGINT '.')
IF (@@ROWCOUNT = 0)	SET @ALL_CONTRACTORS = 1

SELECT * INTO #CARDS FROM OPENXML(@HDOC, '//ID_CARDS') WITH(ID_CARDS UNIQUEIDENTIFIER '.')
IF (@@ROWCOUNT = 0)	SET @ALL_CARDS = 1

EXEC SP_XML_REMOVEDOCUMENT @HDOC

EXEC USP_RANGE_NORM @DATE_FR OUT, @DATE_TO OUT
EXEC USP_RANGE_DAYS @DATE_FR OUT, @DATE_TO OUT

--select @DATE_FR, @DATE_TO
--select * from #contractors
--select * from #cards

SELECT
	chi.id_cheque_item_global,
	GOODS_CODE = G.CODE,
	GOODS_NAME = G.NAME,
	CONTRACTOR_NAME = CT.NAME,
	DATE_CHEQUE = CH.DATE_CHEQUE,
	QUANTITY = CHI.QUANTITY,	
	COST = CASE 
				WHEN CH.CHEQUE_TYPE = 'SALE' THEN 
						CASE WHEN EXISTS (SELECT * FROM PCX_CHEQUE_ITEM WHERE OPER_TYPE = 'DEBIT' AND ID_CHEQUE_ITEM_GLOBAL = CHI.ID_CHEQUE_ITEM_GLOBAL) THEN CHI.SUMM + (SELECT TOP 1 SUMM FROM PCX_CHEQUE_ITEM WHERE OPER_TYPE = 'DEBIT' AND ID_CHEQUE_ITEM_GLOBAL = CHI.ID_CHEQUE_ITEM_GLOBAL) ELSE chi.summ END
				WHEN CH.CHEQUE_TYPE = 'RETURN' THEN
						CASE WHEN EXISTS (SELECT * FROM PCX_CHEQUE_ITEM WHERE OPER_TYPE = 'DEBIT_REFUND' AND ID_CHEQUE_ITEM_GLOBAL = CHI.ID_CHEQUE_ITEM_GLOBAL) THEN CHI.SUMM + (SELECT TOP 1 SUMM FROM PCX_CHEQUE_ITEM WHERE OPER_TYPE = 'DEBIT_REFUND' AND ID_CHEQUE_ITEM_GLOBAL = CHI.ID_CHEQUE_ITEM_GLOBAL) ELSE chi.summ END
			END,
	OPER_TYPE = CASE
					WHEN SCI.OPER_TYPE = 'CHARGE' THEN 'Начисление'
					WHEN SCI.OPER_TYPE = 'CHARGE_REFUND' THEN 'Возврат начисления'
					WHEN SCI.OPER_TYPE = 'DEBIT' THEN 'Списание'
					WHEN SCI.OPER_TYPE = 'DEBIT_REFUND' THEN 'Возврат cписания'
				END,
	CHEQUE_NUM = CH.MNEMOCODE,
	CHEQUE_TYPE = CASE WHEN CH.CHEQUE_TYPE = 'SALE' THEN 'Продажа' ELSE 'Возврат' END,
	CARD_CODE = DC.BARCODE,
	PPOINTS = CASE WHEN SCI.OPER_TYPE IN ('CHARGE', 'DEBIT_REFUND') THEN SCI.SUMM_SCORE ELSE NULL END,
	MPOINTS = CASE WHEN SCI.OPER_TYPE IN ('DEBIT', 'CHARGE_REFUND') THEN SCI.SUMM_SCORE ELSE NULL END,
	PSUMM = CASE WHEN SCI.OPER_TYPE IN ('CHARGE', 'DEBIT_REFUND') THEN SCI.SUMM ELSE NULL END,
	MSUMM = CASE WHEN SCI.OPER_TYPE IN ('DEBIT', 'CHARGE_REFUND') THEN SCI.SUMM ELSE NULL END,
	TRAN_CODE = SCI.TRANSACTION_ID,
	MULT = CASE WHEN CH.CHEQUE_TYPE = 'SALE' THEN 1 ELSE -1 END	
into #t1	
--select *
FROM PCX_CHEQUE_ITEM SCI
	INNER JOIN CHEQUE_ITEM CHI ON SCI.ID_CHEQUE_ITEM_GLOBAL = CHI.ID_CHEQUE_ITEM_GLOBAL
	INNER JOIN CHEQUE CH ON CH.ID_CHEQUE_GLOBAL = CHI.ID_CHEQUE_GLOBAL		
	INNER JOIN CASH_SESSION CS ON CS.ID_CASH_SESSION_GLOBAL = CH.ID_CASH_SESSION_GLOBAL
	INNER JOIN CASH_REGISTER CR ON CR.ID_CASH_REGISTER = CS.ID_CASH_REGISTER
	INNER JOIN CONTRACTOR CT ON CT.ID_CONTRACTOR = CR.ID_CONTRACTOR
	INNER JOIN DISCOUNT2_MAKE_ITEM DMI ON DMI.ID_CHEQUE_ITEM_GLOBAL = CHI.ID_CHEQUE_ITEM_GLOBAL
	INNER JOIN DISCOUNT2_CARD DC ON DC.ID_DISCOUNT2_CARD_GLOBAL = DMI.ID_DISCOUNT2_CARD_GLOBAL
	LEFT JOIN GOODS G ON G.ID_GOODS = CHI.ID_GOODS
WHERE DATE_CHEQUE BETWEEN @DATE_FR AND @DATE_TO
	AND CH.CHEQUE_TYPE IN ('SALE', 'RETURN')
	AND CH.DOCUMENT_STATE = 'PROC'
	AND (@ALL_CONTRACTORS = 1 OR CT.ID_CONTRACTOR IN (SELECT ID_CONTRACTOR FROM #CONTRACTORS))
	AND (@ALL_CARDS = 1 OR DC.ID_DISCOUNT2_CARD_GLOBAL IN (SELECT ID_CARDS FROM #CARDS))
	AND (CLIENT_ID_TYPE = 4)--   6 - сбер, 4 - связной
	
	
select * from #t1

select id_cheque_item_global, cost, quantity, mult into #t2 from #t1 group by id_cheque_item_global, cost, quantity, mult
--select * from #t2

select SUM_S = SUM(cost*mult), SUM_Q = SUM(quantity) from #t2

RETURN 0
GO

/*
EXEC DBO.REPEX_SVYAZ_CARDS N'
<XML>
	<DATE_FR>2000-05-25T00:00:00.000</DATE_FR>
	<DATE_TO>2016-05-25T12:00:00.000</DATE_TO>
</XML>'
*/

--select *FROM PCX_CHEQUE_ITEM
--select * from pcx_CHEQUE_ITEM
--select * from CASH_REGISTER

SET NOCOUNT ON
SET QUOTED_IDENTIFIER OFF
GO 

IF OBJECT_ID('DBO.REMOVE_REPORT_BY_TYPE_NAME') IS NULL EXEC('CREATE PROCEDURE DBO.REMOVE_REPORT_BY_TYPE_NAME AS RETURN')
GO
ALTER PROCEDURE DBO.REMOVE_REPORT_BY_TYPE_NAME 
	@REPORT_TYPE_NAME VARCHAR(200) AS
	
DECLARE @ID_META_REPORT BIGINT

	SELECT 
		@ID_META_REPORT = ID_META_REPORT
	FROM META_REPORT
	WHERE TYPE_NAME = @REPORT_TYPE_NAME
	--SELECT @ID_META_REPORT
		
	DECLARE @SQL NVARCHAR(200)
	SET @SQL = N'DELETE FROM META_REPORT_2_REPORT_GROUPS
				WHERE ID_META_REPORT = @ID_META_REPORT'
	IF (OBJECT_ID('META_REPORT_2_REPORT_GROUPS') IS NOT NULL)
		EXEC SP_EXECUTESQL @SQL, N'@ID_META_REPORT BIGINT', @ID_META_REPORT=@ID_META_REPORT
		

	SET @SQL = N'DELETE FROM META_REPORT_SETTINGS_CSV_EXPORT
		WHERE ID_META_REPORT = @ID_META_REPORT'
	IF (OBJECT_ID('META_REPORT_SETTINGS_CSV_EXPORT') IS NOT NULL)
		EXEC SP_EXECUTESQL @SQL, N'@ID_META_REPORT BIGINT', @ID_META_REPORT=@ID_META_REPORT
		

	SET @SQL = N'DELETE FROM META_REPORT_SETTINGS_VISIBLE
		WHERE ID_META_REPORT = @ID_META_REPORT'
	IF (OBJECT_ID('META_REPORT_SETTINGS_VISIBLE') IS NOT NULL)
		EXEC SP_EXECUTESQL @SQL, N'@ID_META_REPORT BIGINT', @ID_META_REPORT=@ID_META_REPORT
		

	SET @SQL = N'DELETE FROM META_REPORT_SETTINGS_MANAGED
				WHERE ID_META_REPORT = @ID_META_REPORT'
	IF (OBJECT_ID('META_REPORT_SETTINGS_MANAGED') IS NOT NULL)
		EXEC SP_EXECUTESQL @SQL, N'@ID_META_REPORT BIGINT', @ID_META_REPORT=@ID_META_REPORT


	SET @SQL = N'DELETE FROM META_REPORT_SETTINGS_ARCHIVE
				WHERE ID_META_REPORT = @ID_META_REPORT'
	IF (OBJECT_ID('META_REPORT_SETTINGS_ARCHIVE') IS NOT NULL)
		EXEC SP_EXECUTESQL @SQL, N'@ID_META_REPORT BIGINT', @ID_META_REPORT=@ID_META_REPORT


	DELETE FROM META_REPORT
	WHERE ID_META_REPORT = @ID_META_REPORT

RETURN 0
GO


EXEC DBO.REMOVE_REPORT_BY_TYPE_NAME 'SVYAZCARDS_RIGLA.FORMPARAMS'
GO
