SET NOCOUNT ON
SET QUOTED_IDENTIFIER OFF
GO

IF OBJECT_ID('DBO.REPEX_APTEKA_RU_EXPORT') IS NULL EXEC('CREATE PROCEDURE DBO.REPEX_APTEKA_RU_EXPORT AS RETURN')
GO
ALTER  PROCEDURE DBO.REPEX_APTEKA_RU_EXPORT
	@XMLPARAM NTEXT AS

DECLARE @HDOC INT
DECLARE @CO BIT, @ALL_CONTRACTORS BIT

EXEC SP_XML_PREPAREDOCUMENT @HDOC OUTPUT, @XMLPARAM OUTPUT
	SELECT TOP 1 @CO = CO
		FROM OPENXML(@HDOC, '/XML') 
	WITH(CO BIT 'CO')

	SELECT * INTO #CONTRACTOR FROM OPENXML(@HDOC, '//ID_CONTRACTOR') 
	WITH(ID_CONTRACTOR BIGINT '.') WHERE ID_CONTRACTOR <> 0
	IF @@ROWCOUNT = 0 SET @ALL_CONTRACTORS = 1

EXEC SP_XML_REMOVEDOCUMENT @HDOC

SELECT 
	L.ID_LOT, 
	S.ID_CONTRACTOR,
	L.ID_GOODS AS V_PRODUCTS_ID,
	G.[NAME] AS V_PRODUCTS_NAME_1,
	L.PRICE_SAL AS V_PRODUCTS_PRICE,
	SUM((LM.QUANTITY_ADD - LM.QUANTITY_SUB - LM.QUANTITY_RES)) AS V_PRODUCTS_QUANTITY,
	V_MANUFACTURERS_NAME = P.NAME,
	V_STATUS = CASE WHEN SUM((LM.QUANTITY_ADD - LM.QUANTITY_SUB - LM.QUANTITY_RES)) > 0 THEN 'Active'
		ELSE 'Inactive' END
INTO #TEMP
FROM LOT_MOVEMENT LM
	INNER JOIN LOT L ON L.ID_LOT_GLOBAL = LM.ID_LOT_GLOBAL
	INNER JOIN GOODS G ON G.ID_GOODS = L.ID_GOODS
	LEFT JOIN PRODUCER P ON G.ID_PRODUCER = P.ID_PRODUCER
	LEFT JOIN STORE S ON L.ID_STORE = S.ID_STORE
WHERE (
	(@CO = 1 AND (@ALL_CONTRACTORS = 1 OR S.ID_CONTRACTOR IN (SELECT ID_CONTRACTOR FROM #CONTRACTOR)))
	OR 
	((@CO <> 1 OR @CO IS NULL) 
		AND S.ID_CONTRACTOR = (SELECT TOP 1 ID_CONTRACTOR FROM ENTERPRISE_BRANCH WHERE IS_SELF = 1))
	)
GROUP BY L.ID_LOT, S.ID_CONTRACTOR, L.ID_GOODS, G.[NAME], P.[NAME], L.PRICE_SAL
HAVING SUM((LM.QUANTITY_ADD - LM.QUANTITY_SUB - LM.QUANTITY_RES)) > 0
ORDER BY G.[NAME]

SELECT * FROM #TEMP

SELECT
	DISTINCT ID_CONTRACTOR
FROM #TEMP
ORDER BY ID_CONTRACTOR

RETURN
GO